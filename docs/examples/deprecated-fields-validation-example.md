# åºŸå¼ƒå­—æ®µéªŒè¯ç¤ºä¾‹

æœ¬æ–‡æ¡£å±•ç¤ºç¼–è¾‘å™¨ä¸­å¯¹åºŸå¼ƒå­—æ®µçš„éªŒè¯å’Œæç¤ºæ•ˆæœã€‚

## åœºæ™¯ 1ï¼šæ‰“å¼€åŒ…å«åºŸå¼ƒå­—æ®µçš„æ—§è„šæœ¬

### ç”¨æˆ·æ“ä½œ

ç”¨æˆ·åœ¨ç¼–è¾‘å™¨ä¸­æ‰“å¼€ä¸€ä¸ªæ—§çš„ YAML è„šæœ¬æ–‡ä»¶ã€‚

### åŸå§‹è„šæœ¬å†…å®¹

```yaml
topic_id: welcome_topic
topic_name: æ¬¢è¿è¯é¢˜
actions:
  - action_id: action_1
    action_type: ai_say
    config:
      content: æ¬¢è¿æ¥è®¿

  - action_id: action_2
    action_type: ai_ask
    config:
      content_template: å‘æ¥è®¿è€…è¯¢é—®å¦‚ä½•ç§°å‘¼
      question_template: å‘æ¥è®¿è€…è¯¢é—®å¦‚ä½•ç§°å‘¼
      exit: æ”¶åˆ°åˆ°æ¥è®¿è€…çš„ç§°å‘¼
      target_variable: user_name
      extraction_prompt: æ¥è®¿è€…å¯ä»¥æ¥å—çš„ç§°å‘¼
      required: false
      max_rounds: 3
```

### éªŒè¯è§¦å‘

- **è§¦å‘ç‚¹**: FILE_OPEN (æ–‡ä»¶æ‰“å¼€)
- **å»¶è¿Ÿ**: ç«‹å³æ‰§è¡Œ

### é”™è¯¯åˆ—è¡¨å±•ç¤º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è„šæœ¬éªŒè¯ç»“æœ                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âŒ å‘ç° 6 ä¸ªé—®é¢˜                                                â”‚
â”‚                                                                 â”‚
â”‚ ğŸ“ actions[1].config                                           â”‚
â”‚                                                                 â”‚
â”‚   âŒ ç¼ºå°‘å¿…å¡«å­—æ®µ 'content'                                     â”‚
â”‚      â†’ è¯·æ·»åŠ  content å­—æ®µ                                     â”‚
â”‚                                                                 â”‚
â”‚   âŒ åŒ…å«ä¸å…è®¸çš„é¢å¤–å­—æ®µ 'content_template'                   â”‚
â”‚      å­—æ®µ 'content_template' å·²åºŸå¼ƒï¼ˆè¯¥å­—æ®µå·²é‡å‘½åï¼‰          â”‚
â”‚      â†’ è¯·ä½¿ç”¨ 'content' ä»£æ›¿                                   â”‚
â”‚      â†’ è¯·å°† content_template é‡å‘½åä¸º content                  â”‚
â”‚      [æŸ¥çœ‹ç¤ºä¾‹]                                                 â”‚
â”‚                                                                 â”‚
â”‚   âŒ åŒ…å«ä¸å…è®¸çš„é¢å¤–å­—æ®µ 'question_template'                  â”‚
â”‚      å­—æ®µ 'question_template' å·²åºŸå¼ƒï¼ˆè¯¥å­—æ®µå·²è¢«åºŸå¼ƒï¼‰         â”‚
â”‚      â†’ è¯·ä½¿ç”¨ 'content' ä»£æ›¿                                   â”‚
â”‚      â†’ è¯·ä½¿ç”¨ content å­—æ®µä»£æ›¿ question_template               â”‚
â”‚                                                                 â”‚
â”‚   âŒ åŒ…å«ä¸å…è®¸çš„é¢å¤–å­—æ®µ 'target_variable'                    â”‚
â”‚      å­—æ®µ 'target_variable' å·²åºŸå¼ƒï¼ˆè¯¥å­—æ®µå·²è¢« output é…ç½®å–ä»£ï¼‰â”‚
â”‚      â†’ è¯·ä½¿ç”¨ 'output' ä»£æ›¿                                    â”‚
â”‚      â†’ è¯·ä½¿ç”¨ output æ•°ç»„é…ç½®å˜é‡æå–ï¼Œä¾‹å¦‚ï¼š                  â”‚
â”‚         output:                                                 â”‚
â”‚           - get: user_name                                      â”‚
â”‚             define: æå–ç”¨æˆ·ç§°å‘¼                               â”‚
â”‚      [æŸ¥çœ‹ç¤ºä¾‹]                                                 â”‚
â”‚                                                                 â”‚
â”‚   âŒ åŒ…å«ä¸å…è®¸çš„é¢å¤–å­—æ®µ 'extraction_prompt'                  â”‚
â”‚      å­—æ®µ 'extraction_prompt' å·²åºŸå¼ƒï¼ˆè¯¥å­—æ®µå·²è¢« output.instruction å–ä»£ï¼‰â”‚
â”‚      â†’ è¯·ä½¿ç”¨ 'output[].define' ä»£æ›¿                           â”‚
â”‚      â†’ è¯·åœ¨ output æ•°ç»„ä¸­ä½¿ç”¨ define å­—æ®µ                      â”‚
â”‚                                                                 â”‚
â”‚   âŒ åŒ…å«ä¸å…è®¸çš„é¢å¤–å­—æ®µ 'required'                           â”‚
â”‚      å­—æ®µ 'required' å·²åºŸå¼ƒï¼ˆè¯¥å­—æ®µæ— å®é™…ä½œç”¨å·²åºŸå¼ƒï¼‰          â”‚
â”‚      â†’ è¯·ç›´æ¥ç§»é™¤è¯¥å­—æ®µï¼Œæ‰€æœ‰ ai_ask åŠ¨ä½œéƒ½æ˜¯å¯é€‰çš„            â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## åœºæ™¯ 2ï¼šç¼–è¾‘å™¨ä¸­å®æ—¶éªŒè¯

### ç”¨æˆ·æ“ä½œ

ç”¨æˆ·æ­£åœ¨ç¼–è¾‘ `action_2` çš„é…ç½®ï¼Œåˆ é™¤äº† `question_template` å­—æ®µã€‚

### å½“å‰ç¼–è¾‘çŠ¶æ€

```yaml
- action_id: action_2
  action_type: ai_ask
  config:
    content_template: å‘æ¥è®¿è€…è¯¢é—®å¦‚ä½•ç§°å‘¼
    # question_template å·²åˆ é™¤
    exit: æ”¶åˆ°åˆ°æ¥è®¿è€…çš„ç§°å‘¼
    target_variable: user_name
    extraction_prompt: æ¥è®¿è€…å¯ä»¥æ¥å—çš„ç§°å‘¼
    required: false
    max_rounds: 3
```

### éªŒè¯è§¦å‘

- **è§¦å‘ç‚¹**: CONTENT_CHANGE (å†…å®¹å˜æ›´)
- **å»¶è¿Ÿ**: 500ms é˜²æŠ–åæ‰§è¡Œ

### å®æ—¶é”™è¯¯æ›´æ–°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âŒ å‘ç° 5 ä¸ªé—®é¢˜                            [æœ€åéªŒè¯: 14:30:45] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¡Œå†…æ ‡è®°ï¼š
    11 â”‚     config:
    12 â”‚ âŒ    content_template: å‘æ¥è®¿è€…è¯¢é—®å¦‚ä½•ç§°å‘¼
              ~~~~~~~~~~~~~~~~
              å­—æ®µå·²åºŸå¼ƒï¼Œè¯·ä½¿ç”¨ 'content'
    13 â”‚       exit: æ”¶åˆ°åˆ°æ¥è®¿è€…çš„ç§°å‘¼
    14 â”‚ âŒ    target_variable: user_name
              ~~~~~~~~~~~~~~~
              è¯¥å­—æ®µå·²è¢« output é…ç½®å–ä»£
    15 â”‚ âŒ    extraction_prompt: æ¥è®¿è€…å¯ä»¥æ¥å—çš„ç§°å‘¼
              ~~~~~~~~~~~~~~~~~
              è¯¥å­—æ®µå·²è¢« output.define å–ä»£
    16 â”‚ âŒ    required: false
              ~~~~~~~~
              è¯¥å­—æ®µæ— å®é™…ä½œç”¨å·²åºŸå¼ƒ
    17 â”‚       max_rounds: 3
```

---

## åœºæ™¯ 3ï¼šé¼ æ ‡æ‚¬åœæŸ¥çœ‹é”™è¯¯è¯¦æƒ…

### ç”¨æˆ·æ“ä½œ

é¼ æ ‡æ‚¬åœåœ¨ `target_variable` å­—æ®µä¸Šã€‚

### æ‚¬åœæç¤º (Tooltip)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âŒ å­—æ®µ 'target_variable' å·²åºŸå¼ƒ                            â”‚
â”‚                                                             â”‚
â”‚ åŸå› ï¼šè¯¥å­—æ®µå·²è¢« output é…ç½®å–ä»£                            â”‚
â”‚ æ›¿ä»£ï¼šè¯·ä½¿ç”¨ 'output' å­—æ®µ                                  â”‚
â”‚                                                             â”‚
â”‚ ä¿®å¤å»ºè®®ï¼š                                                  â”‚
â”‚ è¯·ä½¿ç”¨ output æ•°ç»„é…ç½®å˜é‡æå–ï¼Œä¾‹å¦‚ï¼š                      â”‚
â”‚                                                             â”‚
â”‚ âœ… æ­£ç¡®ç¤ºä¾‹ï¼š                                               â”‚
â”‚ config:                                                     â”‚
â”‚   content: å‘æ¥è®¿è€…è¯¢é—®å¦‚ä½•ç§°å‘¼                             â”‚
â”‚   exit: æ”¶åˆ°ç§°å‘¼                                            â”‚
â”‚   output:                                                   â”‚
â”‚     - get: user_name                                        â”‚
â”‚       define: æå–ç”¨æˆ·ç§°å‘¼                                  â”‚
â”‚                                                             â”‚
â”‚ [å¿«é€Ÿä¿®å¤] [äº†è§£æ›´å¤š]                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## åœºæ™¯ 4ï¼šå°è¯•ä¿å­˜åŒ…å«é”™è¯¯çš„è„šæœ¬

### ç”¨æˆ·æ“ä½œ

ç”¨æˆ·ç‚¹å‡»ä¿å­˜æŒ‰é’® (æˆ–æŒ‰ Ctrl+S)ã€‚

### éªŒè¯è§¦å‘

- **è§¦å‘ç‚¹**: BEFORE_SAVE (ä¿å­˜å‰)
- **å»¶è¿Ÿ**: ç«‹å³æ‰§è¡Œï¼ˆé˜»å¡å¼ï¼‰

### ä¿å­˜é˜»æ­¢å¯¹è¯æ¡†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš ï¸  æ— æ³•ä¿å­˜è„šæœ¬                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ è„šæœ¬éªŒè¯å¤±è´¥ï¼Œå‘ç° 5 ä¸ªé”™è¯¯ï¼Œè¯·ä¿®å¤åå†ä¿å­˜ã€‚               â”‚
â”‚                                                             â”‚
â”‚ ä¸»è¦é—®é¢˜ï¼š                                                  â”‚
â”‚ â€¢ ç¼ºå°‘å¿…å¡«å­—æ®µ 'content'                                    â”‚
â”‚ â€¢ åŒ…å« 4 ä¸ªåºŸå¼ƒå­—æ®µ (content_template, target_variable...)  â”‚
â”‚                                                             â”‚
â”‚ [æŸ¥çœ‹æ‰€æœ‰é”™è¯¯] [å–æ¶ˆä¿å­˜]                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## åœºæ™¯ 5ï¼šä¿®å¤æ‰€æœ‰é”™è¯¯åä¿å­˜

### ç”¨æˆ·æ“ä½œ

ç”¨æˆ·æŒ‰ç…§æç¤ºä¿®å¤äº†æ‰€æœ‰é”™è¯¯ï¼Œå†æ¬¡ä¿å­˜ã€‚

### ä¿®å¤åçš„è„šæœ¬

```yaml
topic_id: welcome_topic
topic_name: æ¬¢è¿è¯é¢˜
actions:
  - action_id: action_1
    action_type: ai_say
    config:
      content: æ¬¢è¿æ¥è®¿

  - action_id: action_2
    action_type: ai_ask
    config:
      content: å‘æ¥è®¿è€…è¯¢é—®å¦‚ä½•ç§°å‘¼ # âœ… ä½¿ç”¨ content
      exit: æ”¶åˆ°åˆ°æ¥è®¿è€…çš„ç§°å‘¼
      output: # âœ… ä½¿ç”¨ output æ•°ç»„
        - get: user_name
          define: æå–ç”¨æˆ·ç§°å‘¼
      max_rounds: 3
      # âœ… ç§»é™¤æ‰€æœ‰åºŸå¼ƒå­—æ®µ
```

### éªŒè¯ç»“æœ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… è„šæœ¬éªŒè¯é€šè¿‡                         [æœ€åéªŒè¯: 14:35:22] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è„šæœ¬å·²æˆåŠŸä¿å­˜ï¼
```

---

## åºŸå¼ƒå­—æ®µå®Œæ•´å¯¹ç…§è¡¨

| åºŸå¼ƒå­—æ®µ            | åŸå›        | æ›¿ä»£æ–¹æ¡ˆ          | è¿ç§»è¯´æ˜                                     |
| ------------------- | ---------- | ----------------- | -------------------------------------------- |
| `content_template`  | å­—æ®µé‡å‘½å | `content`         | ç›´æ¥å°† `content_template` é‡å‘½åä¸º `content` |
| `question_template` | åŠŸèƒ½é‡å¤   | `content`         | ä½¿ç”¨ `content` å­—æ®µä»£æ›¿ `question_template`  |
| `target_variable`   | è®¾è®¡æ”¹è¿›   | `output[].get`    | ä½¿ç”¨ `output` æ•°ç»„é…ç½®å˜é‡æå–               |
| `extraction_prompt` | è®¾è®¡æ”¹è¿›   | `output[].define` | åœ¨ `output` æ•°ç»„ä¸­ä½¿ç”¨ `define` å­—æ®µ         |
| `required`          | æ— å®é™…ä½œç”¨ | ç§»é™¤              | ç›´æ¥åˆ é™¤è¯¥å­—æ®µ                               |

---

## éªŒè¯è§¦å‘ç‚¹æ€»ç»“

### FILE_OPEN (æ–‡ä»¶æ‰“å¼€)

- **æ—¶æœº**: æ‰“å¼€è„šæœ¬æ–‡ä»¶æ—¶
- **å»¶è¿Ÿ**: ç«‹å³æ‰§è¡Œ
- **ç”¨é€”**: å¿«é€Ÿå‘ç°ç°æœ‰é—®é¢˜
- **UI åé¦ˆ**: æ˜¾ç¤ºé”™è¯¯åˆ—è¡¨é¢æ¿å’ŒçŠ¶æ€æ¡

### CONTENT_CHANGE (å†…å®¹å˜æ›´)

- **æ—¶æœº**: ç¼–è¾‘å™¨å†…å®¹å˜åŒ–æ—¶
- **å»¶è¿Ÿ**: 500ms é˜²æŠ–
- **ç”¨é€”**: å®æ—¶åé¦ˆç¼–è¾‘é”™è¯¯
- **UI åé¦ˆ**: æ›´æ–°è¡Œå†…é”™è¯¯æ ‡è®°å’Œé”™è¯¯åˆ—è¡¨

### BEFORE_SAVE (ä¿å­˜å‰)

- **æ—¶æœº**: ç‚¹å‡»ä¿å­˜æŒ‰é’®æˆ– Ctrl+S
- **å»¶è¿Ÿ**: ç«‹å³æ‰§è¡Œï¼ˆé˜»å¡ï¼‰
- **ç”¨é€”**: é˜»æ­¢ä¿å­˜æ— æ•ˆè„šæœ¬
- **UI åé¦ˆ**: æ˜¾ç¤ºé”™è¯¯å¯¹è¯æ¡†æˆ–æˆåŠŸæç¤º

### MANUAL (æ‰‹åŠ¨éªŒè¯)

- **æ—¶æœº**: ç‚¹å‡»"éªŒè¯è„šæœ¬"æŒ‰é’®
- **å»¶è¿Ÿ**: ç«‹å³æ‰§è¡Œ
- **ç”¨é€”**: ä¸»åŠ¨æ£€æŸ¥è„šæœ¬
- **UI åé¦ˆ**: æ˜¾ç¤ºéªŒè¯ç»“æœæ‘˜è¦

---

## å¼€å‘è€…ä½¿ç”¨ç¤ºä¾‹

### åœ¨ç¼–è¾‘å™¨ç»„ä»¶ä¸­é›†æˆ

```typescript
import { validationService } from '@/services/validation-service';

function ScriptEditor() {
  const [content, setContent] = useState('');
  const [errors, setErrors] = useState([]);

  // æ–‡ä»¶æ‰“å¼€æ—¶éªŒè¯
  useEffect(() => {
    if (content) {
      const result = validationService.validateOnOpen(content);
      setErrors(result.errors);
    }
  }, []);

  // å†…å®¹å˜æ›´æ—¶éªŒè¯ï¼ˆé˜²æŠ–ï¼‰
  const handleChange = (newContent) => {
    setContent(newContent);

    validationService.validateOnChange(newContent, (result) => {
      setErrors(result.errors);
    });
  };

  // ä¿å­˜å‰éªŒè¯
  const handleSave = async () => {
    const result = await validationService.validateBeforeSave(content);

    if (!result.valid) {
      alert(`æ— æ³•ä¿å­˜ï¼Œå‘ç° ${result.errors.length} ä¸ªé”™è¯¯`);
      return;
    }

    await saveScript(content);
  };

  return (
    <div>
      <ValidationStatusBar errors={errors} />
      <CodeEditor value={content} onChange={handleChange} />
      <ErrorListPanel errors={errors} />
      <button onClick={handleSave}>ä¿å­˜</button>
    </div>
  );
}
```

---

## ç›¸å…³æ–‡æ¡£

- [ç¼–è¾‘å™¨éªŒè¯é›†æˆè®¾è®¡](./editor-validation-integration.md)
- [å®ç°æ€»ç»“](./editor-validation-implementation-summary.md)
- [Schema å®šä¹‰](../../packages/core-engine/src/schemas/)

# å·¥ç¨‹åˆå§‹åŒ–æœºåˆ¶ä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•ä½¿ç”¨å¿ƒæµå¼•æ“çš„å·¥ç¨‹åˆå§‹åŒ–æœºåˆ¶å¿«é€Ÿåˆ›å»ºå¸¦æœ‰ä¸¤å±‚æ¨¡æ¿ç»“æ„çš„æ–°å·¥ç¨‹ã€‚

---

## ä¸€ã€å·¥ç¨‹åˆå§‹åŒ–åŠŸèƒ½

### 1.1 åŠŸèƒ½è¯´æ˜

å½“ä½ åˆ›å»ºä¸€ä¸ªæ–°çš„å’¨è¯¢è„šæœ¬å·¥ç¨‹æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ï¼š

1. **åˆ›å»ºä¸¤å±‚ç›®å½•ç»“æ„**ï¼š
   - `_system/config/default/` - ç³»ç»Ÿé»˜è®¤æ¨¡æ¿ï¼ˆåªè¯»ï¼‰
   - `_system/config/custom/` - è‡ªå®šä¹‰æ¨¡æ¿æ–¹æ¡ˆï¼ˆå¯ç¼–è¾‘ï¼‰

2. **å¤åˆ¶ç³»ç»Ÿæ¨¡æ¿**ï¼š
   - ä»ä»£ç å·¥ç¨‹ `config/prompts/` å¤åˆ¶æœ€æ–°çš„ç³»ç»Ÿæ¨¡æ¿åˆ° `_system/config/default/`
   - åŒ…å«ï¼š`ai_ask_v1.md`ã€`ai_say_v1.md` ç­‰æ ¸å¿ƒæ¨¡æ¿

3. **ç”Ÿæˆç¤ºä¾‹è„šæœ¬**ï¼š
   - `scripts/examples/hello-world.yaml` - ç®€å•çš„æ¬¢è¿ä¼šè¯ç¤ºä¾‹

4. **åˆ›å»ºé…ç½®æ–‡ä»¶**ï¼š
   - `project.json` - å·¥ç¨‹å…ƒæ•°æ®é…ç½®
   - `README.md` - å·¥ç¨‹è¯´æ˜æ–‡æ¡£
   - `.gitignore` - Git å¿½ç•¥è§„åˆ™

### 1.2 ç›®å½•ç»“æ„ç¤ºä¾‹

```
my-project/
â”œâ”€â”€ _system/
â”‚   â””â”€â”€ config/
â”‚       â”œâ”€â”€ default/           # ç³»ç»Ÿé»˜è®¤å±‚ï¼ˆåªè¯»ï¼‰
â”‚       â”‚   â”œâ”€â”€ ai_ask_v1.md
â”‚       â”‚   â”œâ”€â”€ ai_say_v1.md
â”‚       â”‚   â””â”€â”€ .readonly       # åªè¯»æ ‡è®°æ–‡ä»¶
â”‚       â””â”€â”€ custom/             # è‡ªå®šä¹‰å±‚ï¼ˆå¯ç¼–è¾‘ï¼‰
â”‚           â””â”€â”€ .gitkeep        # å ä½æ–‡ä»¶
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ examples/
â”‚       â””â”€â”€ hello-world.yaml    # ç¤ºä¾‹è„šæœ¬
â”œâ”€â”€ project.json                # å·¥ç¨‹é…ç½®
â”œâ”€â”€ README.md                   # å·¥ç¨‹è¯´æ˜
â””â”€â”€ .gitignore                  # Git å¿½ç•¥è§„åˆ™
```

---

## äºŒã€ä½¿ç”¨æ–¹å¼

### 2.1 é€šè¿‡ API åˆ›å»ºå·¥ç¨‹

**ç«¯ç‚¹**: `POST /api/projects`

**è¯·æ±‚ç¤ºä¾‹**:

```bash
curl -X POST http://localhost:8000/api/projects \
  -H "Content-Type: application/json" \
  -d '{
    "projectName": "CBTæŠ‘éƒç—‡è¯„ä¼°å·¥ç¨‹",
    "description": "ç”¨äºCBTæŠ‘éƒç—‡è¯„ä¼°çš„å’¨è¯¢è„šæœ¬å·¥ç¨‹",
    "author": "å¿ƒç†å’¨è¯¢å¸ˆå¼ ä¸‰",
    "template": "blank",
    "language": "zh-CN"
  }'
```

**è¯·æ±‚å‚æ•°**:

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|------|------|--------|
| `projectName` | string | âœ… | å·¥ç¨‹åç§° | - |
| `description` | string | âŒ | å·¥ç¨‹æè¿° | ç©ºå­—ç¬¦ä¸² |
| `author` | string | âœ… | ä½œè€…åç§° | - |
| `template` | enum | âŒ | æ¨¡æ¿ç±»å‹ï¼š`blank`ã€`cbt-assessment`ã€`cbt-counseling` | `blank` |
| `language` | string | âŒ | è¯­è¨€ä»£ç ï¼ˆå¦‚ `zh-CN`ã€`en-US`ï¼‰ | `zh-CN` |
| `domain` | string | âŒ | é¢†åŸŸæ ‡è¯† | - |
| `scenario` | string | âŒ | åœºæ™¯æ ‡è¯† | - |

**å“åº”ç¤ºä¾‹**:

```json
{
  "success": true,
  "data": {
    "id": "uuid-xxxx-xxxx-xxxx",
    "projectName": "CBTæŠ‘éƒç—‡è¯„ä¼°å·¥ç¨‹",
    "status": "draft",
    "createdAt": "2026-02-01T12:00:00Z"
  }
}
```

### 2.2 é€šè¿‡ç¼–è¾‘å™¨åˆ›å»ºå·¥ç¨‹

> âš ï¸ **æ³¨æ„**ï¼šç¼–è¾‘å™¨UIé›†æˆåŠŸèƒ½å°šåœ¨è§„åˆ’ä¸­ï¼ˆé˜¶æ®µ3ï¼‰ï¼Œå½“å‰è¯·ä½¿ç”¨APIæ–¹å¼åˆ›å»ºå·¥ç¨‹ã€‚

**ä¸´æ—¶æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨æµ‹è¯•è„šæœ¬ `test-project-creation-flow.ts` åˆ›å»ºå·¥ç¨‹
- æˆ–é€šè¿‡ API ç›´æ¥è°ƒç”¨åˆ›å»ºæ¥å£

---

## ä¸‰ã€å·¥ç¨‹é…ç½®æ–‡ä»¶è¯´æ˜

### 3.1 project.json

å·¥ç¨‹å…ƒæ•°æ®é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«å·¥ç¨‹çš„åŸºæœ¬ä¿¡æ¯ï¼š

```json
{
  "projectId": "uuid-xxxx-xxxx-xxxx",
  "name": "CBTæŠ‘éƒç—‡è¯„ä¼°å·¥ç¨‹",
  "version": "1.0.0",
  "description": "",
  "language": "zh-CN",
  "templateVersion": "1.0.0",
  "systemTemplateVersion": "1.2.0",
  "createdAt": "2026-02-01T12:00:00Z",
  "metadata": {
    "author": "å¿ƒç†å’¨è¯¢å¸ˆå¼ ä¸‰",
    "organization": "",
    "tags": []
  },
  "dependencies": {
    "@å¿ƒæµå¼•æ“/core-engine": "^2.0.0"
  }
}
```

**å­—æ®µè¯´æ˜**:

| å­—æ®µ | è¯´æ˜ |
|------|------|
| `projectId` | å·¥ç¨‹å”¯ä¸€æ ‡è¯†ï¼ˆUUIDï¼‰ |
| `name` | å·¥ç¨‹åç§° |
| `version` | å·¥ç¨‹ç‰ˆæœ¬å· |
| `language` | å·¥ç¨‹è¯­è¨€ |
| `systemTemplateVersion` | ç³»ç»Ÿæ¨¡æ¿ç‰ˆæœ¬ï¼ˆæ¥è‡ªä»£ç å·¥ç¨‹ï¼‰ |
| `createdAt` | åˆ›å»ºæ—¶é—´ |

### 3.2 .readonly æ–‡ä»¶

ä½äº `_system/config/default/.readonly`ï¼Œç”¨äºæ ‡è®°è¯¥ç›®å½•ä¸ºåªè¯»ã€‚

**å†…å®¹**:

```
# ç³»ç»Ÿé»˜è®¤æ¨¡æ¿ï¼ˆDefault å±‚ï¼‰

æ­¤ç›®å½•åŒ…å«ç³»ç»Ÿé»˜è®¤æ¨¡æ¿ï¼Œè¯·å‹¿ç›´æ¥ä¿®æ”¹ã€‚
å¦‚éœ€è‡ªå®šä¹‰ï¼Œè¯·åœ¨ custom/ ç›®å½•ä¸‹åˆ›å»ºæ–°çš„æ¨¡æ¿æ–¹æ¡ˆã€‚
```

---

## å››ã€è‡ªå®šä¹‰æ¨¡æ¿æ–¹æ¡ˆ

### 4.1 åˆ›å»ºè‡ªå®šä¹‰æ–¹æ¡ˆ

å‡è®¾ä½ æƒ³ä¸º"CBTæŠ‘éƒç—‡"åˆ›å»ºä¸“ç”¨æ¨¡æ¿æ–¹æ¡ˆï¼š

**æ­¥éª¤**:

1. åœ¨ `_system/config/custom/` ä¸‹åˆ›å»ºæ–°ç›®å½•ï¼š
   ```
   _system/config/custom/cbt_depression/
   ```

2. ä» default å±‚å¤åˆ¶æ¨¡æ¿ä½œä¸ºèµ·ç‚¹ï¼š
   ```bash
   cp _system/config/default/ai_ask_v1.md _system/config/custom/cbt_depression/
   cp _system/config/default/ai_say_v1.md _system/config/custom/cbt_depression/
   ```

3. ç¼–è¾‘æ¨¡æ¿å†…å®¹ï¼Œæ·»åŠ é’ˆå¯¹æŠ‘éƒç—‡çš„ç‰¹å®šè¯æœ¯å’Œç­–ç•¥

### 4.2 åœ¨è„šæœ¬ä¸­ä½¿ç”¨è‡ªå®šä¹‰æ–¹æ¡ˆ

åœ¨ Session èŠ‚ç‚¹é…ç½® `template_scheme` å­—æ®µï¼š

```yaml
session:
  session_id: cbt_depression_session
  session_name: CBTæŠ‘éƒç—‡è¯„ä¼°ä¼šè¯
  template_scheme: custom/cbt_depression  # æŒ‡å®šä½¿ç”¨è‡ªå®šä¹‰æ–¹æ¡ˆ

  phases:
    - phase_id: assessment
      topics:
        - topic_id: mood_assessment
          actions:
            - action_type: ai_ask
              # è‡ªåŠ¨ä½¿ç”¨ _system/config/custom/cbt_depression/ai_ask_v1.md
              content: 'è¯·æè¿°ä½ æœ€è¿‘ä¸¤å‘¨çš„æƒ…ç»ªçŠ¶æ€'
              output:
                - æƒ…ç»ªæè¿°
```

### 4.3 æ¨¡æ¿æŸ¥æ‰¾é¡ºåº

å¼•æ“æŒ‰ä»¥ä¸‹é¡ºåºæŸ¥æ‰¾æ¨¡æ¿ï¼š

1. **Custom å±‚**ï¼š`_system/config/custom/{template_scheme}/{template}.md`
2. **Default å±‚**ï¼ˆå›é€€ï¼‰ï¼š`_system/config/default/{template}.md`

**ç¤ºä¾‹**ï¼š

- é…ç½®ï¼š`template_scheme: custom/cbt_depression`
- æŸ¥æ‰¾è·¯å¾„ï¼š
  1. `_system/config/custom/cbt_depression/ai_ask_v1.md`ï¼ˆä¼˜å…ˆï¼‰
  2. `_system/config/default/ai_ask_v1.md`ï¼ˆå›é€€ï¼‰

---

## äº”ã€ç³»ç»Ÿæ¨¡æ¿å†…å®¹

### 5.1 ai_ask_v1.md

æé—®ç±» Action çš„æç¤ºè¯æ¨¡æ¿ï¼ŒåŒ…å«ï¼š

- **å®‰å…¨è¾¹ç•Œä¸ä¼¦ç†è§„èŒƒ**ï¼šè¯Šæ–­ç¦æ­¢ã€å¤„æ–¹ç¦æ­¢ã€ä¿è¯ç¦æ­¢
- **JSON è¾“å‡ºæ ¼å¼**ï¼šç»Ÿä¸€çš„ç»“æ„åŒ–è¾“å‡º
- **å®‰å…¨é£é™©è‡ªæŸ¥**ï¼šsafety_risk å­—æ®µ
- **å±æœºä¿¡å·æ£€æµ‹**ï¼šcrisis_signal æ ‡è®°

### 5.2 ai_say_v1.md

è®²è§£ç±» Action çš„æç¤ºè¯æ¨¡æ¿ï¼ŒåŒ…å«ï¼š

- **å®‰å…¨è¾¹ç•Œä¸ä¼¦ç†è§„èŒƒ**ï¼šåŒ ai_ask
- **ç†è§£åº¦è¯„ä¼°**ï¼šassessment å­—æ®µ
- **JSON è¾“å‡ºæ ¼å¼**ï¼šç»Ÿä¸€çš„ç»“æ„åŒ–è¾“å‡º

### 5.3 æ¨¡æ¿å˜é‡

ç³»ç»Ÿæ¨¡æ¿æ”¯æŒä»¥ä¸‹å˜é‡å ä½ç¬¦ï¼š

| å˜é‡ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `{{time}}` | å½“å‰æ—¶é—´ | "2026-02-01 12:00" |
| `{{who}}` | å’¨è¯¢å¸ˆè§’è‰²åç§° | "å¿ƒç†å’¨è¯¢å¸ˆ" |
| `{{user}}` | ç”¨æˆ·åç§° | "ç”¨æˆ·" |
| `{{chat}}` | å¯¹è¯å†å² | "ç”¨æˆ·: ...\nå’¨è¯¢å¸ˆ: ..." |
| `{{task}}` | å½“å‰ä»»åŠ¡æè¿° | "è¯„ä¼°ç”¨æˆ·çš„æƒ…ç»ªçŠ¶æ€" |

---

## å…­ã€æµ‹è¯•éªŒè¯

### 6.1 æœ¬åœ°æµ‹è¯•è„šæœ¬

ä½¿ç”¨ `test-project-initializer-local.ts` éªŒè¯å·¥ç¨‹åˆå§‹åŒ–åŠŸèƒ½ï¼š

```bash
cd packages/api-server
npx tsx test-project-initializer-local.ts
```

**æµ‹è¯•è¾“å‡º**:

```
=== ProjectInitializer æœ¬åœ°æµ‹è¯• ===

ğŸ“‹ Step 1: æ¸…ç†æµ‹è¯•å·¥ä½œåŒº...
âœ… æµ‹è¯•å·¥ä½œåŒºå·²æ¸…ç†

ğŸ“‹ Step 2: åˆ›å»º ProjectInitializer å®ä¾‹...
âœ… ProjectInitializer å®ä¾‹å·²åˆ›å»º

ğŸ“‹ Step 3: æ‰§è¡Œå·¥ç¨‹åˆå§‹åŒ–...
âœ… å·¥ç¨‹åˆå§‹åŒ–æˆåŠŸï¼
   - å·¥ç¨‹è·¯å¾„: C:\CBT\test-workspace\test-project-xxxx
   - ç”Ÿæˆçš„ç¤ºä¾‹è„šæœ¬æ•°é‡: 1

ğŸ“‹ Step 4: éªŒè¯ç›®å½•ç»“æ„...
   âœ… _system/config/default
   âœ… _system/config/custom
   âœ… scripts/examples

ğŸ“‹ Step 5: éªŒè¯ç³»ç»Ÿæ¨¡æ¿å¤åˆ¶ï¼ˆT13ï¼‰...
   âœ… .readonly æ ‡è®°æ–‡ä»¶å­˜åœ¨
   âœ… ai_ask_v1.md (4.63 KB)
      âœ“ åŒ…å«å®‰å…¨è¾¹ç•Œè§„èŒƒ
   âœ… ai_say_v1.md (4.52 KB)
      âœ“ åŒ…å«å®‰å…¨è¾¹ç•Œè§„èŒƒ

=== æµ‹è¯•æ€»ç»“ ===

âœ… T12 - ProjectInitializer å®ç°éªŒè¯: é€šè¿‡
âœ… T13 - ç³»ç»Ÿæ¨¡æ¿å¤åˆ¶åˆ° default å±‚: é€šè¿‡
âœ… ä¸¤å±‚ç›®å½•ç»“æ„åˆ›å»º: é€šè¿‡
âœ… é…ç½®æ–‡ä»¶ç”Ÿæˆ: é€šè¿‡
âœ… ç¤ºä¾‹è„šæœ¬ç”Ÿæˆ: é€šè¿‡
```

### 6.2 å•å…ƒæµ‹è¯•

è¿è¡Œå•å…ƒæµ‹è¯•å¥—ä»¶ï¼š

```bash
cd packages/api-server
npx vitest run src/services/project-initializer.test.ts
```

**æµ‹è¯•è¦†ç›–**ï¼š
- âœ… 15ä¸ªæµ‹è¯•ç”¨ä¾‹å…¨éƒ¨é€šè¿‡
- âœ… è¦†ç›– T12ã€T13 æ ¸å¿ƒåŠŸèƒ½
- âœ… éªŒè¯ç›®å½•ç»“æ„ã€æ¨¡æ¿å¤åˆ¶ã€é…ç½®æ–‡ä»¶ç”Ÿæˆ

---

## ä¸ƒã€å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•æ›´æ–°ç³»ç»Ÿæ¨¡æ¿åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Ÿ

**A**: ç³»ç»Ÿæ¨¡æ¿åœ¨å·¥ç¨‹åˆ›å»ºæ—¶ä»ä»£ç å·¥ç¨‹å¤åˆ¶ï¼Œåç»­æ›´æ–°éœ€è¦æ‰‹åŠ¨æ“ä½œï¼š

1. **æ–¹æ¡ˆ1**ï¼šé‡æ–°åˆ›å»ºå·¥ç¨‹ï¼ˆæ¨èç”¨äºæ–°å·¥ç¨‹ï¼‰
2. **æ–¹æ¡ˆ2**ï¼šæ‰‹åŠ¨å¤åˆ¶æ–°æ¨¡æ¿åˆ° default å±‚ï¼ˆéœ€è°¨æ…ï¼Œå¯èƒ½å½±å“ç°æœ‰è„šæœ¬ï¼‰

**æœªæ¥ä¼˜åŒ–**ï¼š
- è®¡åˆ’å¢åŠ "æ¨¡æ¿ç‰ˆæœ¬ç®¡ç†"åŠŸèƒ½
- æ”¯æŒå·¥ç¨‹çº§åˆ«çš„æ¨¡æ¿ç‰ˆæœ¬å‡çº§

### Q2: å¯ä»¥ç›´æ¥ä¿®æ”¹ default å±‚çš„æ¨¡æ¿å—ï¼Ÿ

**A**: ä¸å¯ä»¥ã€‚default å±‚æ ‡è®°ä¸ºåªè¯»ï¼ŒåŸå› ï¼š

1. ä¿è¯ç³»ç»Ÿæ¨¡æ¿çš„ä¸€è‡´æ€§
2. é¿å…æ„å¤–ä¿®æ”¹å½±å“å…¶ä»–è„šæœ¬
3. ä¾¿äºæ¨¡æ¿ç‰ˆæœ¬ç®¡ç†

**æ­£ç¡®åšæ³•**ï¼š
- åœ¨ custom å±‚åˆ›å»ºæ–°çš„æ¨¡æ¿æ–¹æ¡ˆ
- åœ¨è„šæœ¬ä¸­é€šè¿‡ `template_scheme` å¼•ç”¨è‡ªå®šä¹‰æ–¹æ¡ˆ

### Q3: å¦‚ä½•åœ¨å›¢é˜Ÿä¸­å…±äº«è‡ªå®šä¹‰æ¨¡æ¿æ–¹æ¡ˆï¼Ÿ

**A**: å½“å‰æ”¯æŒçš„æ–¹å¼ï¼š

1. **Git ç‰ˆæœ¬æ§åˆ¶**ï¼šå°† `_system/config/custom/` æäº¤åˆ°ä»£ç åº“
2. **æ‰‹åŠ¨å¯¼å‡º/å¯¼å…¥**ï¼šå¤åˆ¶ custom ç›®å½•åˆ°å…¶ä»–å·¥ç¨‹

**æœªæ¥ä¼˜åŒ–**ï¼š
- è®¡åˆ’å¢åŠ "æ¨¡æ¿å¸‚åœº"åŠŸèƒ½
- æ”¯æŒæ–¹æ¡ˆçš„å¯¼å…¥/å¯¼å‡º/è¯„åˆ†æœºåˆ¶

### Q4: å·¥ç¨‹åˆå§‹åŒ–å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

**A**: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š

1. **æƒé™é—®é¢˜**ï¼šç¡®ä¿æœ‰å·¥ä½œåŒºç›®å½•çš„å†™æƒé™
2. **ç³»ç»Ÿæ¨¡æ¿è·¯å¾„**ï¼šç¡®è®¤ `config/prompts/` ç›®å½•å­˜åœ¨
3. **æ•°æ®åº“è¿æ¥**ï¼šç¡®ä¿æ•°æ®åº“æœåŠ¡æ­£å¸¸è¿è¡Œ

**æŸ¥çœ‹æ—¥å¿—**ï¼š
```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯
tail -f logs/api-server.log
```

---

## å…«ã€å‚è€ƒæ–‡æ¡£

- **è®¾è®¡æ–‡æ¡£**ï¼š[template-security-boundary-addition.md](../.qoder/quests/template-security-boundary-addition.md) - ç¬¬3.10èŠ‚
- **ä½¿ç”¨æŒ‡å—**ï¼š[_system/README.md](../_system/README.md) - ä¸¤å±‚æ¨¡æ¿ç³»ç»Ÿä½¿ç”¨è¯´æ˜
- **APIæ–‡æ¡£**ï¼šé¡¹ç›®çŸ¥è¯†åº“ - "å·¥ç¨‹ç®¡ç†API"
- **æ ¸å¿ƒå¼•æ“æµ‹è¯•**ï¼š[template-resolver.test.ts](../packages/core-engine/test/template-resolver.test.ts)

---

## ä¹ã€ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ |
|------|------|----------|
| 1.0  | 2026-02-01 | åˆå§‹ç‰ˆæœ¬ï¼Œå®Œæˆå·¥ç¨‹åˆå§‹åŒ–æœºåˆ¶æ–‡æ¡£ |

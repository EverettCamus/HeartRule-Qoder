# ç£ç›˜ä¾èµ–ç§»é™¤é‡æ„åˆ†ææŠ¥å‘Š

**ç¼–å†™æ—¥æœŸ**: 2026-02-03  
**æ–‡æ¡£çŠ¶æ€**: å®Œæˆåˆ†æï¼Œå·²æ•´åˆåˆ° productbacklog.md

---

## æ‰§è¡Œæ‘˜è¦

ä¸¤ä¸ªå…³é”®çš„é‡æ„ä»»åŠ¡å·²è¢«åˆ†æå¹¶æ•´åˆåˆ° Product Backlog ä¸­ï¼š

| ä»»åŠ¡                                         | æ‰€å± Story           | ä¼˜å…ˆçº§ | Sprint   | é¢„è®¡å·¥ä½œé‡ |
| -------------------------------------------- | -------------------- | ------ | -------- | ---------- |
| DatabaseTemplateProvider å®Œå…¨æ›¿ä»£ç£ç›˜è¯»å–    | **Story 0.4**        | P0     | Sprint 0 | 8 SP       |
| ç§»é™¤ç£ç›˜åŒæ­¥æœºåˆ¶ä¸ ProjectInitializer åˆå§‹åŒ– | **Story 0.5** (æ–°å¢) | P0     | Sprint 0 | 8 SP       |

---

## ä¸€ã€ä»»åŠ¡åˆ†æä¸é‡ç»„å†³ç­–

### 1.1 åˆå§‹éœ€æ±‚å›é¡¾

ç”¨æˆ·æå‡ºä¸¤ä¸ªé‡æ„ä»»åŠ¡ï¼š

```
1. core-engine çš„ DatabaseTemplateProvider å®Œå…¨æ›¿ä»£ç£ç›˜è¯»å–
   - é‡æ„ TemplateResolver ä½¿ç”¨ DatabaseTemplateProvider
   - ç§»é™¤ syncTemplatesToDisk() ä¸´æ—¶æ–¹æ¡ˆ
   - ç§»é™¤ ProjectInitializer çš„ç£ç›˜ç›®å½•åˆ›å»ºé€»è¾‘

2. æ¸…ç† workspace ä¾èµ–
   - ç§»é™¤ PROJECTS_WORKSPACE ç¯å¢ƒå˜é‡
   - åˆ é™¤ workspace ç‰©ç†ç›®å½•
   - æ›´æ–°ç›¸å…³æ–‡æ¡£å’Œæµ‹è¯•
```

### 1.2 ç°çŠ¶åˆ†æ

æ ¹æ®ä»£ç åº“æ‰«æç»“æœï¼Œå½“å‰çŠ¶æ€å¦‚ä¸‹ï¼š

#### âœ… å·²å®ç°çš„éƒ¨åˆ†

1. **DatabaseTemplateProvider å·²å­˜åœ¨**
   - ä½ç½®: `packages/api-server/src/services/database-template-provider.ts`
   - å®ç°å®Œæ•´ï¼Œæ”¯æŒä» `script_files` è¡¨è¯»å–æ¨¡æ¿
   - æ¥å£è§„èŒƒæ˜ç¡®ï¼š`getTemplate(projectId, filePath)` å’Œ `hasTemplate(projectId, filePath)`

2. **TemplateResolver æ”¯æŒä¸¤ç§æ¨¡å¼**
   - ä½ç½®: `packages/core-engine/src/engines/prompt-template/template-resolver.ts`
   - æ•°æ®åº“æ¨¡å¼ï¼šå½“ä¼ å…¥ projectId + templateProvider æ—¶ä½¿ç”¨æ•°æ®åº“è¯»å–
   - æ–‡ä»¶ç³»ç»Ÿæ¨¡å¼ï¼šå…¼å®¹æ—§ç‰ˆæœ¬ï¼Œå½“ä»…ä¼ å…¥ projectPath æ—¶ä½¿ç”¨ç£ç›˜è¯»å–
   - é€»è¾‘æ¸…æ™°ï¼Œæ”¯æŒç°åº¦è¿‡æ¸¡

3. **PromptTemplateManager ä¹Ÿæ”¯æŒä¸¤ç§æ¨¡å¼**
   - ä½ç½®: `packages/core-engine/src/engines/prompt-template/template-manager.ts`
   - åŒæ ·æ”¯æŒ DatabaseTemplateProvider æ³¨å…¥
   - åŒ…å«ç¼“å­˜æœºåˆ¶ï¼Œæ€§èƒ½è€ƒè™‘å‘¨å…¨

#### âš ï¸ å¾…æ¸…ç†çš„éƒ¨åˆ†

1. **SessionManager.syncTemplatesToDisk()**
   - ä½ç½®: `packages/api-server/src/services/session-manager.ts` (è¡Œ 649)
   - ä½œç”¨ï¼šå°†æ•°æ®åº“æ¨¡æ¿åŒæ­¥åˆ°ç£ç›˜ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰
   - ä»£ç æ³¨é‡Šæ˜ç¡®æ ‡æ³¨ï¼š`// ç­‰ TemplateResolver å®Œå…¨æ•°æ®åº“åŒ–åç§»é™¤`
   - å½“å‰ä»åœ¨åˆå§‹åŒ–ä¼šè¯æ—¶è°ƒç”¨

2. **ProjectInitializer çš„ç£ç›˜æ“ä½œ**
   - ä½ç½®: `packages/api-server/src/services/project-initializer.ts`
   - åˆ›å»ºç‰©ç†ç›®å½•ï¼š`_system/config/default`ã€`_system/config/custom`ã€`scripts/examples`
   - å¤åˆ¶ç³»ç»Ÿæ¨¡æ¿ï¼š`copySystemTemplates()` æ–¹æ³•
   - å·¥ç¨‹åˆ›å»º API ä¸­è°ƒç”¨åˆå§‹åŒ–ï¼ˆè¡Œ 220-230ï¼‰

3. **PROJECTS_WORKSPACE ç¯å¢ƒå˜é‡**
   - ä½¿ç”¨ä½ç½®ï¼š4 å¤„ (base-action.tsã€projects.tsã€session-manager.tsã€import-disk-templates-to-db.ts)
   - æ¯å¤„éƒ½æœ‰é»˜è®¤å€¼ï¼š`process.env.PROJECTS_WORKSPACE || path.resolve(process.cwd(), 'workspace', 'projects')`

#### ğŸ“‹ è¿ç§»å·¥å…·

1. **import-disk-templates-to-db.ts**
   - ä¸€æ¬¡æ€§è¿ç§»è„šæœ¬ï¼Œå°†ç£ç›˜æ¨¡æ¿å¯¼å…¥æ•°æ®åº“
   - å½“å‰ä»éœ€ä¿ç•™ç”¨äºå†å²æ•°æ®è¿ç§»
   - åº”æ ‡æ³¨ä¸º"é—ç•™å·¥å…·"

---

## äºŒã€é‡æ„ä»»åŠ¡å®‰æ’å†³ç­–

### 2.1 ä¸ºä½•åˆ†ä¸ºä¸¤ä¸ª Storyï¼Ÿ

**å†³ç­–**: âœ… åˆ†ä¸º **Story 0.4** å’Œ **Story 0.5** ä¸¤ä¸ªç‹¬ç«‹ Story

**ç†ç”±**ï¼š

| å…³é”®ç‚¹       | Story 0.4                                  | Story 0.5                    |
| ------------ | ------------------------------------------ | ---------------------------- |
| **èŒè´£**     | å®Œæˆæ•°æ®åº“è·¯å¾„                             | æ¸…ç†ç£ç›˜ä¾èµ–                 |
| **èŒƒå›´**     | core-engine å±‚çš„æ¨¡æ¿åŠ è½½é€»è¾‘               | API å±‚å’Œåˆå§‹åŒ–é€»è¾‘çš„ç£ç›˜ç§»é™¤ |
| **ä¾èµ–**     | æ— ï¼ˆåŸºç¡€è®¾æ–½ï¼‰                             | ä¸¥æ ¼ä¾èµ– Story 0.4           |
| **é£é™©**     | ä¸­ç­‰ï¼šéœ€éªŒè¯ DatabaseTemplateProvider è¾¹ç•Œ | é«˜ï¼šè‹¥ 0.4 æœ‰æ¼æ´ä¼šæš´éœ²      |
| **éªŒæ”¶æŒ‡æ ‡** | æ•°æ®åº“åŠ è½½å¯ç”¨ä¸”å…¼å®¹                       | ç³»ç»Ÿå®Œå…¨æ— ç£ç›˜ä¾èµ–           |

**ä¼˜åŠ¿**ï¼š

1. **åˆ†ç¦»å…³æ³¨ç‚¹** - 0.4 å…³æ³¨"å¼•å…¥æ–°èƒ½åŠ›"ï¼Œ0.5 å…³æ³¨"ç§»é™¤æ—§ä¾èµ–"
2. **å¯æ§é£é™©** - 0.4 å®Œæˆåå¯å•ç‹¬æµ‹è¯•æ•°æ®åº“æ¨¡å¼ï¼Œ0.5 åˆ™åœ¨ 0.4 åŸºç¡€ä¸Šæ“ä½œ
3. **çµæ´»æ€§** - è‹¥ 0.4 å‘ç°é—®é¢˜ï¼Œå¯å¿«é€Ÿä¿®å¤è€Œä¸å½±å“ 0.5 è®¡åˆ’
4. **MVP ç¨³å®šæ€§** - ä¸¤ä¸ª Story éƒ½åœ¨ Sprint 0ï¼Œç¡®ä¿æ•°æ®åº“æ¶æ„å®Œæ•´æˆå‹

---

## ä¸‰ã€Story 0.5 è¯¦ç»†è®¾è®¡

### 3.1 æ ¸å¿ƒä»»åŠ¡åˆ†è§£

#### ä»»åŠ¡ 1ï¼šç§»é™¤ SessionManager.syncTemplatesToDisk()

**å˜æ›´ç‚¹**ï¼š

```typescript
// åˆ é™¤è¿™ä¸ªæ–¹æ³•
private async syncTemplatesToDisk(projectId: string): Promise<void> {
  // ... å½“å‰ä¼šå°†æ•°æ®åº“æ¨¡æ¿å†™åˆ°ç£ç›˜
}

// åˆ é™¤è°ƒç”¨ç‚¹
private async initializeSession() {
  // await this.syncTemplatesToDisk(projectId);  // âŒ ç§»é™¤è¿™è¡Œ
}
```

**å½±å“åˆ†æ**ï¼š

- ä¼šè¯åˆå§‹åŒ–æ—¶æ— éœ€ç£ç›˜ I/O
- å®Œå…¨ä¾èµ– DatabaseTemplateProvider
- æ€§èƒ½æå‡ï¼ˆå‡å°‘ç£ç›˜æ“ä½œï¼‰

**éªŒè¯æ–¹å¼**ï¼š

- E2E æµ‹è¯•ï¼šæ–°å»ºä¼šè¯ â†’ æ‰§è¡Œ action â†’ æ¨¡æ¿æ­£ç¡®åŠ è½½
- æ— éœ€ workspace ç›®å½•å­˜åœ¨

---

#### ä»»åŠ¡ 2ï¼šé‡æ„ ProjectInitializer

**å˜æ›´å‰**ï¼š

```typescript
async initializeProject(config: ProjectInitConfig): Promise<ProjectInitResult> {
  const projectPath = this.getProjectPath(config.projectId);

  // âŒ åˆ›å»ºç‰©ç†ç›®å½•
  await this.createDirectories(projectPath);

  // âŒ å¤åˆ¶ç³»ç»Ÿæ¨¡æ¿
  await this.copySystemTemplates(projectPath);

  // âŒ å¯é€‰ï¼šå¤åˆ¶é¢„è®¾æ–¹æ¡ˆ
  if (config.templateScheme) {
    await this.copyTemplateScheme(projectPath, config.templateScheme);
  }

  return { projectPath, generatedScripts: [] };
}
```

**å˜æ›´å**ï¼š

```typescript
async initializeProject(config: ProjectInitConfig): Promise<ProjectInitResult> {
  // ä»…æ‰§è¡Œæ•°æ®åº“æ“ä½œï¼Œä¸åˆ›å»ºç‰©ç†ç›®å½•
  const projectId = config.projectId;

  // 1. å†™å…¥å·¥ç¨‹å…ƒæ•°æ®åˆ°æ•°æ®åº“ï¼ˆå·²ç”± projects.ts API å®Œæˆï¼‰

  // 2. è‹¥æŒ‡å®š templateSchemeï¼Œå¤åˆ¶æ•°æ®åº“ä¸­çš„æ¨¡æ¿æ–‡ä»¶
  if (config.templateScheme) {
    await this.copyTemplateSchemeFromDatabase(projectId, config.templateScheme);
  }

  // 3. è¿”å›ç»“æœï¼ˆä»…å…ƒæ•°æ®ï¼‰
  return {
    projectPath: `[DB] project/${projectId}`,  // è™šæ‹Ÿè·¯å¾„ï¼Œè¡¨ç¤ºæ•°æ®åº“èµ„æº
    generatedScripts: []
  };
}
```

**å…·ä½“å˜æ›´**ï¼š

- âŒ åˆ é™¤ `createDirectories()` æ–¹æ³•
- âŒ åˆ é™¤ `copySystemTemplates()` æ–¹æ³•
- âœ… æ–°å¢ `copyTemplateSchemeFromDatabase()` æ–¹æ³•
  - ä» `script_files` è¡¨æŸ¥è¯¢ custom scheme çš„æ¨¡æ¿
  - åœ¨ç›¸åŒ scheme ä¸‹å¤åˆ¶æ‰€æœ‰æ¨¡æ¿æ–‡ä»¶
- âŒ åˆ é™¤æ‰€æœ‰æ–‡ä»¶ç³»ç»Ÿ importï¼š`import fs from 'fs/promises'`

---

#### ä»»åŠ¡ 3ï¼šç§»é™¤ PROJECTS_WORKSPACE ä¾èµ–

**ç§»é™¤ä½ç½®**ï¼š

| æ–‡ä»¶                                                  | è¡Œå· | å½“å‰ç”¨é€”                  | å¤„ç†æ–¹å¼                               |
| ----------------------------------------------------- | ---- | ------------------------- | -------------------------------------- |
| `packages/core-engine/src/actions/base-action.ts`     | 276  | é¡¹ç›®è·¯å¾„è§£æ              | âŒ åˆ é™¤ï¼Œä½¿ç”¨ projectId + DB           |
| `packages/api-server/src/routes/projects.ts`          | 223  | ProjectInitializer åˆå§‹åŒ– | âŒ åˆ é™¤ï¼Œæ”¹ä¸ºä»…æ•°æ®åº“æ“ä½œ              |
| `packages/api-server/src/services/session-manager.ts` | 653  | æ¨¡æ¿ç£ç›˜åŒæ­¥              | âŒ åˆ é™¤ï¼ˆéš syncTemplatesToDisk ç§»é™¤ï¼‰ |
| `packages/api-server/import-disk-templates-to-db.ts`  | 17   | è¿ç§»å·¥å…·                  | ğŸ“ ä¿ç•™ä½†æ ‡æ³¨ä¸º"é—ç•™å·¥å…·"              |

**å…·ä½“å˜æ›´**ï¼š

```typescript
// âŒ åˆ é™¤è¿™ç±»ä»£ç 
const workspacePath =
  process.env.PROJECTS_WORKSPACE || path.resolve(process.cwd(), 'workspace', 'projects');
const projectPath = path.join(workspacePath, projectId);

// âœ… æ”¹ä¸º
// æ‰€æœ‰è·¯å¾„æ“ä½œæ”¹ä¸ºè™šæ‹Ÿè·¯å¾„æˆ–æ•°æ®åº“èµ„æºæ ‡è¯†
const projectPath = `db://projects/${projectId}`; // ä»…ç”¨äºæ—¥å¿—
```

---

#### ä»»åŠ¡ 4ï¼šé¡¹ç›®åˆ›å»º API æµç¨‹è°ƒæ•´

**å½“å‰æµç¨‹**ï¼š

```
å·¥ç¨‹åˆ›å»º API
  â†“
1. æ’å…¥ projects è¡¨
  â†“
2. å¯¼å…¥ç³»ç»Ÿæ¨¡æ¿åˆ° script_files è¡¨
  â†“
3. ProjectInitializer.initializeProject()
   - åˆ›å»ºç‰©ç†ç›®å½•
   - å¤åˆ¶æ¨¡æ¿åˆ°ç›®å½•
  â†“
è¿”å›æˆåŠŸ
```

**æ–°æµç¨‹**ï¼š

```
å·¥ç¨‹åˆ›å»º API
  â†“
1. æ’å…¥ projects è¡¨
  â†“
2. å¯¼å…¥ç³»ç»Ÿæ¨¡æ¿åˆ° script_files è¡¨
  â†“
3. ProjectInitializer.initializeProject()  (ç®€åŒ–ç‰ˆ)
   - ä»…æ•°æ®åº“å…ƒæ•°æ®è®°å½•ï¼ˆ0.4 å·²å®Œæˆï¼‰
   - è‹¥æŒ‡å®š templateSchemeï¼Œå¤åˆ¶æ•°æ®åº“æ¨¡æ¿æ–‡ä»¶
  â†“
è¿”å›æˆåŠŸï¼ˆæ— éœ€ workspaceï¼‰
```

**å½±å“**ï¼š

- å·¥ç¨‹åˆ›å»ºæ›´å¿«ï¼ˆæ— ç£ç›˜ I/Oï¼‰
- éƒ¨ç½²æ—¶æ— éœ€åˆ›å»º workspace ç›®å½•
- å¤šè¿›ç¨‹ç¯å¢ƒä¸­æ— ç£ç›˜ç«äº‰

---

### 3.2 éªŒæ”¶æµ‹è¯•è§„åˆ’

| éªŒæ”¶å‡†åˆ™                                      | éªŒè¯æ–¹æ³•        | ä¾èµ–å·¥å…·                           |
| --------------------------------------------- | --------------- | ---------------------------------- |
| SessionManager ä¸­ä¸å†æœ‰ syncTemplatesToDisk() | ä»£ç å®¡æŸ¥ + grep | grep -r "syncTemplatesToDisk"      |
| ProjectInitializer ä¸åˆ›å»ºç‰©ç†ç›®å½•             | å•å…ƒæµ‹è¯•        | vitest project-initializer.test.ts |
| æ–°å·¥ç¨‹åˆ›å»ºæ—¶æ— éœ€ workspace                    | E2E æµ‹è¯•        | åˆ é™¤ workspace ååˆ›å»ºå·¥ç¨‹          |
| å®Œæ•´ä¼šè¯åœ¨æ—  workspace ä¸‹æ‰§è¡Œ                 | E2E æµ‹è¯•        | test-full-flow.ts (æ—  workspace)   |
| æ‰€æœ‰æµ‹è¯•é€šè¿‡                                  | CI è¿è¡Œ         | npm test                           |
| æ–‡æ¡£æ›´æ–°                                      | æ–‡æ¡£å®¡æŸ¥        | docs/design æ–‡ä»¶å¤¹                 |

---

## å››ã€ä¸ MVP ç›®æ ‡çš„å…³ç³»

### 4.1 ä¸ºä»€ä¹ˆè¿™ä¸ªé‡æ„å¯¹ MVP è‡³å…³é‡è¦ï¼Ÿ

**æ ¸å¿ƒåŸå› **ï¼šæ•°æ®åº“è„šæœ¬å·¥ç¨‹æ˜¯ **MVP çš„åŸºç¡€æ¶æ„**ï¼Œä¸æ˜¯å¯é€‰çš„ã€‚

#### é—®é¢˜åˆ†æ

å½“å‰æ··åˆæ¶æ„å­˜åœ¨çš„é—®é¢˜ï¼š

```
â”Œâ”€ é—®é¢˜ 1: å¤šä¼šè¯éš”ç¦»ä¸æ¸…æ™°
â”‚  â”œâ”€ åŒä¸€é¡¹ç›®çš„ä¸åŒä¼šè¯å¯èƒ½äº’ç›¸å¹²æ‰°ç£ç›˜æ¨¡æ¿
â”‚  â””â”€ ç‰ˆæœ¬åˆ‡æ¢æ—¶ç£ç›˜å’Œæ•°æ®åº“å¯èƒ½ä¸åŒæ­¥
â”‚
â”œâ”€ é—®é¢˜ 2: éƒ¨ç½²å¤æ‚æ€§
â”‚  â”œâ”€ éœ€è¦ workspace ç›®å½•åˆå§‹åŒ–
â”‚  â”œâ”€ éœ€è¦ PROJECTS_WORKSPACE ç¯å¢ƒå˜é‡
â”‚  â”œâ”€ å®¹å™¨åŒ–éƒ¨ç½²æ—¶éœ€è¦æŒ‚è½½å·
â”‚  â””â”€ å¤šå‰¯æœ¬éƒ¨ç½²å¯èƒ½äº§ç”Ÿç£ç›˜ç«äº‰
â”‚
â”œâ”€ é—®é¢˜ 3: AI é“¾è·¯ä¸ç¨³å®š
â”‚  â”œâ”€ syncTemplatesToDisk æ˜¯å¼‚æ­¥æ“ä½œï¼Œå¯èƒ½ä¸¢å¤±æ¨¡æ¿
â”‚  â”œâ”€ è‹¥ç£ç›˜æ»¡æˆ–æƒé™é—®é¢˜ï¼Œä¼šè¯æ‰§è¡Œå¤±è´¥
â”‚  â””â”€ è°ƒè¯•æ—¶éš¾ä»¥è¿½è¸ªæ¨¡æ¿æ¥æºï¼ˆç£ç›˜è¿˜æ˜¯æ•°æ®åº“ï¼‰
â”‚
â””â”€ é—®é¢˜ 4: å¯å¤ç°æ€§é—®é¢˜
   â”œâ”€ ä¸åŒå¼€å‘è€… workspace çŠ¶æ€å¯èƒ½ä¸åŒ
   â””â”€ ç”Ÿäº§ç¯å¢ƒç£ç›˜çŠ¶æ€éš¾ä»¥å¤‡ä»½å’Œæ¢å¤
```

#### MVP çš„æ•°æ®åº“æ¶æ„æ‰¿è¯º

å½“å‰ Backlog å·²æ‰¿è¯ºï¼š

> "ä¸ºä¿éšœ AI æ™ºèƒ½é“¾è·¯ï¼ˆAction/Topic/Phase/Sessionï¼‰çš„ç¨³å®šæ€§ä¸å¯å¤ç°æ€§ï¼Œ  
> **å¿…é¡»åœ¨ MVP é˜¶æ®µå‰ç½®å®Œæˆä¸‰é¡¹æ•°æ®åº“åŸºç¡€è®¾æ–½**ï¼š
>
> 1. è„šæœ¬å·¥ç¨‹æ¨¡å‹ï¼ˆprojects/script_files/project_versionsï¼‰è¯­ä¹‰ç»Ÿä¸€ï¼›
> 2. **ä¼šè¯ä¸ project/version çš„æ˜¾å¼ç»‘å®š**ï¼›
> 3. **TemplateProvider é»˜è®¤èµ°æ•°æ®åº“æ¨¡æ¿åŠ è½½**ã€‚"

**Story 0.5 æ˜¯è¿™ä¸ªæ‰¿è¯ºçš„å®Œæˆæ£€æŸ¥ç‚¹**ã€‚

---

### 4.2 å¯¹åç»­ Sprint çš„å½±å“

#### âœ… æ­£é¢å½±å“

1. **Sprint 1 (Action å±‚)**
   - æ— éœ€åœ¨ Action ä¸­å¤„ç†æ–‡ä»¶ç³»ç»Ÿå…¼å®¹æ€§
   - æ¨¡æ¿åŠ è½½ç¨³å®šï¼Œå¯ä¸“æ³¨ AI æ™ºèƒ½èƒ½åŠ›

2. **Sprint 2 (Topic å±‚)**
   - Topic åŠ¨æ€å±•å¼€ Action æ—¶ï¼Œæ¨¡æ¿æ•°æ®åº“åŠ è½½æœ‰ä¿éšœ
   - ç‰ˆæœ¬å¿«ç…§æœºåˆ¶å®Œæ•´å¯ç”¨

3. **Sprint 3+ (Phase/Session å±‚)**
   - è·¨é˜¶æ®µçš„ä¼šè¯çŠ¶æ€ä¸€è‡´æ€§æœ‰æ•°æ®åº“æ”¯æ’‘
   - ç‰ˆæœ¬åˆ‡æ¢ã€å›æ»šæœºåˆ¶å¯é 

4. **éƒ¨ç½²å’Œæµ‹è¯•**
   - æœ¬åœ°æµ‹è¯•ã€CI ç¯å¢ƒã€ç”Ÿäº§ç¯å¢ƒæµç¨‹ç»Ÿä¸€
   - æ— éœ€ workspace åˆå§‹åŒ–æˆä¸ºé¡¹ç›® best practice

#### âŒ è‹¥è·³è¿‡ Story 0.5 çš„é£é™©

```
ç°è±¡ï¼šAction/Topic/Phase å±‚å¼€å‘è¿›è¡Œä¸­...
å‘ç°ï¼šæ¨¡æ¿åŠ è½½å¶å‘å¤±è´¥ï¼Œä½†éš¾ä»¥å®šä½åŸå› 

æ ¹å› åˆ†æï¼š
  â”œâ”€ syncTemplatesToDisk åœ¨æŸäº›å¹¶å‘æƒ…å†µä¸‹å¤±è´¥
  â”œâ”€ ç£ç›˜æ»¡ã€æƒé™é”™è¯¯å¯¼è‡´æ¨¡æ¿ä¸å¯ç”¨
  â”œâ”€ ç‰ˆæœ¬åˆ‡æ¢æ—¶æ–°æ—§æ¨¡æ¿æ··æ­
  â””â”€ å¼€å‘è€…å„è‡ªçš„ workspace çŠ¶æ€ä¸åŒ

åæœï¼š
  â”œâ”€ éœ€è¦å›æº¯åˆ° Sprint 0 ä¿®å¤
  â”œâ”€ å·²å®ç°çš„ Action/Topic é€»è¾‘éœ€è¦è°ƒæ•´
  â”œâ”€ æµ‹è¯•ç”¨ä¾‹éœ€è¦é‡å†™ï¼ˆæ›´æ–° mock æœŸæœ›ï¼‰
  â””â”€ é¡¹ç›®å»¶æœŸ 1-2 å‘¨
```

---

## äº”ã€æŠ€æœ¯å®ç°è·¯å¾„

### 5.1 Story 0.4 å®Œæˆåçš„éªŒæ”¶æ¸…å•

åœ¨å¼€å§‹ Story 0.5 ä¹‹å‰ï¼ŒStory 0.4 å¿…é¡»æ»¡è¶³ï¼š

- [ ] DatabaseTemplateProvider åœ¨ production ç¯å¢ƒä¸‹å¯ç”¨
- [ ] TemplateResolver åœ¨ä¼ å…¥ projectId + provider æ—¶æ­£ç¡®åŠ è½½æ•°æ®åº“æ¨¡æ¿
- [ ] PromptTemplateManager æ”¯æŒ DatabaseTemplateProvider æ³¨å…¥
- [ ] è‡³å°‘ 1 ä¸ª E2E æµ‹è¯•é€šè¿‡ï¼ˆä½¿ç”¨æ•°æ®åº“æ¨¡æ¿å®Œæ•´æ‰§è¡Œä¼šè¯ï¼‰
- [ ] æ€§èƒ½æŒ‡æ ‡æ»¡è¶³ï¼ˆæ¨¡æ¿åŠ è½½ <500msï¼‰
- [ ] è¾¹ç•Œæƒ…å†µå¤„ç†å®Œå–„ï¼ˆæ¨¡æ¿ä¸å­˜åœ¨ã€æƒé™é”™è¯¯ç­‰ï¼‰

### 5.2 Story 0.5 å®ç°æ­¥éª¤ï¼ˆå»ºè®®åˆ† 3 ä¸ª PRï¼‰

#### PR#1: ç§»é™¤ SessionManager.syncTemplatesToDisk()

**æ–‡ä»¶å˜æ›´**ï¼š

```
packages/api-server/src/services/session-manager.ts
  â”œâ”€ åˆ é™¤ syncTemplatesToDisk() æ–¹æ³•ï¼ˆè¡Œ 649-693ï¼‰
  â””â”€ åˆ é™¤è°ƒç”¨ç‚¹ï¼šinitializeSession() ä¸­çš„ await this.syncTemplatesToDisk(...)
```

**æµ‹è¯•æ›´æ–°**ï¼š

```
packages/api-server/src/services/session-manager.test.ts
  â”œâ”€ åˆ é™¤ syncTemplatesToDisk ç›¸å…³æµ‹è¯•
  â””â”€ æ–°å¢ï¼šéªŒè¯ä¼šè¯åˆå§‹åŒ–ä¸åˆ›å»ºç£ç›˜æ–‡ä»¶
```

**éªŒè¯æ–¹å¼**ï¼š

```bash
npm test -- session-manager.test.ts
# æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œä¸å†ä¾èµ– workspace ç›®å½•
```

---

#### PR#2: é‡æ„ ProjectInitializer ä¸ºçº¯æ•°æ®åº“æ“ä½œ

**æ–‡ä»¶å˜æ›´**ï¼š

```
packages/api-server/src/services/project-initializer.ts
  â”œâ”€ åˆ é™¤ createDirectories() æ–¹æ³•
  â”œâ”€ åˆ é™¤ copySystemTemplates() æ–¹æ³•
  â”œâ”€ åˆ é™¤ copyDirectory() å·¥å…·æ–¹æ³•
  â”œâ”€ åˆ é™¤ fs import
  â”œâ”€ ä¿®æ”¹ initializeProject() ä¸ºæ•°æ®åº“æ“ä½œ
  â””â”€ æ–°å¢ copyTemplateSchemeFromDatabase() æ–¹æ³•

packages/api-server/src/routes/projects.ts
  â”œâ”€ ç§»é™¤ PROJECTS_WORKSPACE ç›¸å…³ä»£ç 
  â””â”€ ProjectInitializer åˆå§‹åŒ–æ”¹ä¸ºæ— å‚
```

**æµ‹è¯•æ›´æ–°**ï¼š

```
packages/api-server/src/services/project-initializer.test.ts
  â”œâ”€ åˆ é™¤æ–‡ä»¶ç³»ç»Ÿç›¸å…³æµ‹è¯•
  â”œâ”€ æ–°å¢ï¼šéªŒè¯ä»…æ‰§è¡Œæ•°æ®åº“æ“ä½œ
  â””â”€ æ–°å¢ï¼šéªŒè¯ templateScheme æ•°æ®åº“å¤åˆ¶é€»è¾‘
```

**æµ‹è¯•å‘½ä»¤**ï¼š

```bash
npm test -- project-initializer.test.ts
# æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œä¸éœ€è¦ä¸´æ—¶ç›®å½•
```

---

#### PR#3: æ¸…ç† PROJECTS_WORKSPACE å’Œæµ‹è¯•å®Œæ•´æµç¨‹

**æ–‡ä»¶å˜æ›´**ï¼š

```
packages/core-engine/src/actions/base-action.ts
  â””â”€ åˆ é™¤ projectPath ç›¸å…³çš„å·¥ä½œåŒºè·¯å¾„è§£æ
    (projectId + DB å·²æ¥ç®¡ï¼Œæ— éœ€ workspace)

packages/api-server/import-disk-templates-to-db.ts
  â””â”€ åœ¨æ–‡ä»¶å¤´éƒ¨æ ‡æ³¨ï¼š
    /**
     * é—ç•™å·¥å…·ï¼šä¸€æ¬¡æ€§ç£ç›˜æ¨¡æ¿å¯¼å…¥è„šæœ¬
     * ç”¨é€”ï¼šå°†å†å²é¡¹ç›®çš„ç£ç›˜æ¨¡æ¿å¯¼å…¥æ•°æ®åº“
     * æ–°é¡¹ç›®ï¼šæ— éœ€ä½¿ç”¨æ­¤è„šæœ¬
     * ç»´æŠ¤è€…ï¼šXX
     */

æ–‡æ¡£æ›´æ–°ï¼š
  â”œâ”€ docs/design/workspace-removal-refactor-analysis.md (æœ¬æ–‡ä»¶)
  â”œâ”€ docs/DEVELOPMENT_GUIDE.md (ç§»é™¤ PROJECTS_WORKSPACE è¯´æ˜)
  â”œâ”€ README.md (ç§»é™¤ workspace åˆå§‹åŒ–æ­¥éª¤)
  â””â”€ .env.example (ç§»é™¤ PROJECTS_WORKSPACE å˜é‡)
```

**E2E æµ‹è¯•**ï¼š

```
packages/api-server/test-full-flow-no-workspace.ts (æ–°å¢)
  â”œâ”€ ä¸è®¾ç½® PROJECTS_WORKSPACE
  â”œâ”€ ä¸åˆ›å»º workspace ç›®å½•
  â”œâ”€ åˆ›å»ºå·¥ç¨‹
  â”œâ”€ åˆ›å»ºä¼šè¯
  â”œâ”€ æ‰§è¡Œå®Œæ•´æµç¨‹
  â””â”€ éªŒè¯æˆåŠŸï¼ˆæ¨¡æ¿å…¨éƒ¨æ¥è‡ªæ•°æ®åº“ï¼‰
```

**è¿è¡Œå‘½ä»¤**ï¼š

```bash
# åˆ é™¤ workspace ç›®å½•
rm -rf packages/api-server/workspace

# è¿è¡Œæµ‹è¯•ï¼ˆä¼šå¤±è´¥å¦‚æœè¿˜æœ‰ç£ç›˜ä¾èµ–ï¼‰
npm test -- test-full-flow-no-workspace.ts
```

---

### 5.3 å›å½’æµ‹è¯•æ¸…å•

å®Œæˆ Story 0.5 åï¼Œéœ€è¦éªŒè¯æ‰€æœ‰å†å²åŠŸèƒ½ä»å¯ç”¨ï¼š

| åŠŸèƒ½        | æµ‹è¯•                               | é¢„æœŸç»“æœ            |
| ----------- | ---------------------------------- | ------------------- |
| å·¥ç¨‹åˆ›å»º    | api.createProject()                | âœ… æˆåŠŸï¼Œæ— ç£ç›˜æ“ä½œ |
| ä¼šè¯åˆå§‹åŒ–  | sessionManager.initializeSession() | âœ… ä½¿ç”¨æ•°æ®åº“æ¨¡æ¿   |
| Action æ‰§è¡Œ | ScriptExecutor.executeAction()     | âœ… æ¨¡æ¿åŠ è½½æ­£ç¡®     |
| ç‰ˆæœ¬åˆ‡æ¢    | projectsApi.switchVersion()        | âœ… åˆ‡æ¢åæ¨¡æ¿æ­£ç¡®   |
| æ¨¡æ¿ç®¡ç†    | projectsApi.getTemplate()          | âœ… è¿”å›æ•°æ®åº“å†…å®¹   |
| è°ƒè¯•ä¼šè¯    | DebugSession with inspection       | âœ… è°ƒè¯•ä¿¡æ¯å®Œæ•´     |

---

## å…­ã€é£é™©è¯„ä¼°ä¸ç¼“è§£æªæ–½

### 6.1 é«˜é£é™©é¡¹

#### âš ï¸ é£é™© 1: DatabaseTemplateProvider é—æ¼è¾¹ç•Œæƒ…å†µ

**åœºæ™¯**ï¼šStory 0.4 æœªå……åˆ†æµ‹è¯•æŸäº›åœºæ™¯ï¼ˆå¦‚è‡ªå®šä¹‰æ¨¡æ¿æ–¹æ¡ˆï¼‰

**å½±å“**ï¼šStory 0.5 å®æ–½æ—¶æš´éœ²é—®é¢˜ï¼Œå¯¼è‡´åŠŸèƒ½å›å½’

**ç¼“è§£æªæ–½**ï¼š

1. Story 0.4 éªŒæ”¶æ—¶å¼ºåˆ¶åŒ…å«ï¼š
   - custom scheme æ¨¡æ¿åŠ è½½æµ‹è¯•
   - æ¨¡æ¿ä¸å­˜åœ¨æ—¶çš„é”™è¯¯å¤„ç†
   - å¹¶å‘åŠ è½½å¤šä¸ªæ¨¡æ¿
   - ç¼“å­˜ä¸€è‡´æ€§éªŒè¯

2. Story 0.5 å¼€å§‹å‰ï¼Œè¿è¡Œå®Œæ•´ E2E æµ‹è¯•ï¼ˆæ•°æ®åº“æ¨¡æ¿æ¨¡å¼ï¼‰
   - test-full-flow.ts æ”¹ä¸ºä½¿ç”¨ DatabaseTemplateProvider
   - è¦†ç›– CBT è„šæœ¬å®Œæ•´æµç¨‹

---

#### âš ï¸ é£é™© 2: æ—§é¡¹ç›®å…¼å®¹æ€§é—®é¢˜

**åœºæ™¯**ï¼šæŸäº›å†å²é¡¹ç›®ä¾èµ–ç£ç›˜æ¨¡æ¿ï¼ŒStory 0.5 åæ— æ³•è¿è¡Œ

**å½±å“**ï¼šçº¿ä¸Šé¡¹ç›®åŠŸèƒ½ä¸­æ–­

**ç¼“è§£æªæ–½**ï¼š

1. åœ¨æ•°æ®åº“è¿ç§»è„šæœ¬ä¸­æ·»åŠ ï¼š
   - æ£€æµ‹æ—§é¡¹ç›®æ˜¯å¦æœ‰ç£ç›˜æ¨¡æ¿
   - è‡ªåŠ¨å¯¼å…¥åˆ° script_files è¡¨
   - æ›´æ–° project è®°å½•æ ‡è®°ä¸º"å·²è¿ç§»"

2. ä¿ç•™ import-disk-templates-to-db.ts ä½œä¸ºåº”æ€¥å·¥å…·

3. æä¾›"å…¼å®¹æ¨¡å¼"å¼€å…³ï¼ˆè‹¥å¿…è¦ï¼‰ï¼š
   ```typescript
   if (process.env.LEGACY_MODE === 'true') {
     // ä¿ç•™ç£ç›˜å›é€€é€»è¾‘ï¼ˆä¸æ¨èï¼‰
   }
   ```

---

#### âš ï¸ é£é™© 3: æµ‹è¯•ç¯å¢ƒè®¾ç½®å¤æ‚æ€§

**åœºæ™¯**ï¼šCI/CD ä¸­ workspace ç›®å½•åˆå§‹åŒ–æµç¨‹æ”¹å˜

**å½±å“**ï¼šæµ‹è¯•å¤±è´¥æˆ–ä¸å¯é‡å¤

**ç¼“è§£æªæ–½**ï¼š

1. æ›´æ–° CI æµç¨‹ï¼š
   - ç§»é™¤ workspace ç›®å½•åˆ›å»ºæ­¥éª¤
   - æ·»åŠ æ•°æ®åº“åˆå§‹åŒ–æ­¥éª¤ï¼ˆå¯¼å…¥ç³»ç»Ÿæ¨¡æ¿ï¼‰
   - éªŒè¯æ¨¡æ¿åœ¨æ•°æ®åº“ä¸­

2. æœ¬åœ°å¼€å‘æŒ‡å—æ›´æ–°ï¼š
   ```bash
   # æ—§ï¼šéœ€è¦åˆ›å»º workspace ç›®å½•
   # æ–°ï¼šä»…éœ€æ•°æ®åº“ï¼ˆdocker-compose å·²åŒ…å«ï¼‰
   npm run dev
   ```

---

### 6.2 ä¸­ç­‰é£é™©é¡¹

#### ğŸŸ¡ é£é™© 4: æ€§èƒ½ä¸‹é™

**åœºæ™¯**ï¼šæ•°æ®åº“æŸ¥è¯¢æ¨¡æ¿æ¯”ç£ç›˜è¯»å–æ…¢

**å½±å“**ï¼šä¼šè¯å“åº”å˜æ…¢

**ç¼“è§£æªæ–½**ï¼š

1. PromptTemplateManager ç¼“å­˜æœºåˆ¶å·²å®Œå–„ï¼Œæ— éœ€æ‹…å¿ƒ
2. ç›‘æ§æŒ‡æ ‡ï¼šæ¨¡æ¿åŠ è½½æ—¶é—´ï¼ˆç›®æ ‡ <100msï¼‰
3. è‹¥å‘ç°æ€§èƒ½é—®é¢˜ï¼Œå¯åœ¨ DatabaseTemplateProvider åŠ  Redis ç¼“å­˜

---

#### ğŸŸ¡ é£é™© 5: æ–‡æ¡£æ›´æ–°ä¸å®Œæ•´

**åœºæ™¯**ï¼šæŸäº›æ–‡æ¡£ä»å¼•ç”¨ workspace æˆ– PROJECTS_WORKSPACE

**å½±å“**ï¼šæ–°å¼€å‘è€…é…ç½®é”™è¯¯

**ç¼“è§£æªæ–½**ï¼š

1. æœç´¢æ‰€æœ‰æ–‡æ¡£ä¸­çš„ç›¸å…³å…³é”®è¯ï¼š
   ```bash
   grep -r "PROJECTS_WORKSPACE" docs/
   grep -r "workspace/projects" docs/
   ```
2. é€ä¸€æ›´æ–°æˆ–åˆ é™¤

---

## ä¸ƒã€æ€»ç»“ä¸å»ºè®®

### 7.1 æœ€ç»ˆå†³ç­–

âœ… **åŒæ„å°†ä¸¤ä¸ªé‡æ„ä»»åŠ¡åˆ†ä¸º Story 0.4 å’Œ Story 0.5**

| æ–¹é¢         | å†³ç­–                                                  |
| ------------ | ----------------------------------------------------- |
| **åˆ†ç¦»æ–¹å¼** | Story 0.4 (å®Œæˆæ•°æ®åº“è·¯å¾„) + Story 0.5 (ç§»é™¤ç£ç›˜ä¾èµ–) |
| **ä¼˜å…ˆçº§**   | éƒ½è®¾ä¸º P0ï¼ˆMVP å¿…é¡»ï¼‰                                 |
| **Sprint**   | éƒ½åœ¨ Sprint 0ï¼ˆç¡®ä¿æ¶æ„å®Œæ•´ï¼‰                         |
| **å·¥ä½œé‡**   | Story 0.4: 8 SP; Story 0.5: 8 SP                      |
| **ä¾èµ–å…³ç³»** | Story 0.5 ä¸¥æ ¼ä¾èµ– Story 0.4 é€šè¿‡éªŒæ”¶                 |

### 7.2 å…³é”®æˆåŠŸå› ç´ 

1. **Story 0.4 å¿…é¡»å……åˆ†éªŒè¯**
   - DatabaseTemplateProvider åœ¨ç”Ÿäº§ç¯å¢ƒå¯ç”¨
   - æ”¯æŒ custom scheme å’Œ default ä¸¤å±‚æœºåˆ¶
   - æ€§èƒ½è¾¾æ ‡ï¼ˆ<100ms åŠ è½½ï¼‰

2. **Story 0.5 å®æ–½å‰çš„å‡†å¤‡**
   - å®Œæˆå†å²é¡¹ç›®çš„ç£ç›˜â†’æ•°æ®åº“è¿ç§»
   - æ›´æ–°æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹ï¼ˆç§»é™¤ workspace ä¾èµ–ï¼‰
   - å‡†å¤‡ E2E æµ‹è¯•åœ¨æ—  workspace ç¯å¢ƒä¸‹è¿è¡Œ

3. **é¡¹ç›®ç®¡ç†**
   - Story 0.4 å®Œæˆåï¼Œç«‹å³å¼€å§‹ Story 0.5ï¼ˆä¸ç­‰å…¶ä»–å¹¶è¡Œ Storyï¼‰
   - ä¿ç•™ 2-3 å¤©çš„"é›†æˆç¼“å†²"å¤„ç†è¾¹ç•Œé—®é¢˜

### 7.3 åç»­å·¥ä½œ

å®Œæˆ Sprint 0 åï¼š

1. **å¯åˆ é™¤çš„ç‰©ç†èµ„æº**
   - workspace ç›®å½•ï¼ˆè‹¥ä¸éœ€è¦æœ¬åœ°è°ƒè¯•ï¼‰
   - PROJECTS_WORKSPACE ç¯å¢ƒå˜é‡é…ç½®

2. **æ–‡æ¡£æ›´æ–°**
   - DEVELOPMENT_GUIDE.mdï¼šç§»é™¤ workspace åˆå§‹åŒ–
   - QUICK_START_GUIDE.mdï¼šç®€åŒ–ç¯å¢ƒé…ç½®
   - éƒ¨ç½²æ–‡æ¡£ï¼šæ— éœ€æŒ‚è½½ workspace å·

3. **å¼€å‘ä½“éªŒæ”¹è¿›**
   - å·¥ç¨‹åˆ›å»ºé€Ÿåº¦æå‡ï¼ˆå‡å°‘ç£ç›˜ I/Oï¼‰
   - å¤šè¿›ç¨‹/å®¹å™¨éƒ¨ç½²æ›´ç®€å•
   - æµ‹è¯•ç¯å¢ƒéš”ç¦»æ›´æ¸…æ™°

---

**æ–‡æ¡£å®Œæˆ**  
ä¸º MVP çš„"æ•°æ®åº“è„šæœ¬å·¥ç¨‹"æ¶æ„å¥ å®šåšå®åŸºç¡€ã€‚

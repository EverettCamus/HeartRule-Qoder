# 脚本编辑器核心能力迭代规划（调试优先）

## 0. 文档目的与范围

本设计文档用于指导「脚本编辑器」模块的分阶段开发与 Quest 拆分，目标是：

- **优先打通脚本调试闭环**：从编辑器中选择脚本工程，发起调试会话，查看执行过程和结果。
- 在此基础上，逐步补齐 **版本管理、发布管理、运行执行** 等核心能力。
- 暂不关注 UI 微调、交互动画等体验优化，只保证功能可用、流程清晰。

本规划主要面向以下仓库子模块：

- `packages/script-editor/`（前端）
- `packages/api-server/`（调试 / 版本 / 发布相关接口）
- `packages/core-engine/`（被调试的脚本执行引擎）

---

## 1. 总体迭代策略

编辑器模块按照「调试优先」划分三个阶段：

- **Phase 0：最小可用调试闭环（MVP 调试版）**
  - 从编辑器中选择一个脚本工程与入口脚本，发起调试会话；
  - 在编辑器里看到对话过程和基础执行日志；
  - 能够重新开始调试 / 停止调试；
  - 无版本管理、无发布概念，可以默认使用当前草稿。

- **Phase 1：版本管理与发布管理**
  - 引入「工程草稿 / 已发布版本」的基本模型；
  - 支持查看版本列表、从草稿发布新版本、从已发布版本回滚；
  - 调试时可以指定使用「草稿」或某个「已发布版本」。

- **Phase 2：调试能力增强（非本轮必做）**
  - 变量状态面板；
  - 简单的执行路径可视化（高亮当前 Action / Topic）；
  - 基础的步进执行、断点能力。
  - 本阶段不做也不影响 Phase 0 / Phase 1 的交付。

后续 Quest 可以按 Phase + Task 编号来命名，例如：
- `Q-Editor-P0-T1`
- `Q-Editor-P1-T3` 等。

---

## 2. Phase 0：最小可用调试闭环

目标：**从编辑器中发起调试会话，能跑通一个脚本工程，并在界面上看到对话结果与基本执行信息**。

### P0-T1：调试后端接口梳理与最小 API 定义

**目标**

基于现有 `api-server` 和 `core-engine` 能力，定义并实现调试相关的最小 API 集合，为编辑器提供统一调用入口。

**范围**

- 在 `packages/api-server/` 中：
  - 定义/统一以下接口（具体路径可根据现有路由调整）：
    - `POST /debug/sessions`：创建调试会话（传入工程 ID、入口 session 脚本等）。
    - `POST /debug/sessions/{id}/messages`：发送用户输入。
    - `GET /debug/sessions/{id}`：获取当前会话状态（最近若干轮对话+执行状态）。
  - 简化认证/权限逻辑，默认本地开发环境使用。

- 与 `packages/core-engine/` 的集成：
  - 使用现有执行器（script-execution）调用 YAML 脚本；
  - 暂不做复杂的变量展示、意识脚本等高级能力，只要能返回 AI 回复即可。

**依赖**

- 引擎已有的基础执行能力可以跑通单脚本。

**验收标准**

- 使用简单 HTTP 客户端（如 curl / Postman / VSCode REST）即可通过上述 3 个接口完成一次调试会话。

---

### P0-T2：编辑器内的「调试入口配置」与工程选择

**目标**

在编辑器中，允许用户选择当前脚本工程和调试入口（例如某个 session YAML），并配置少量调试选项。

**范围**

- 在 `packages/script-editor/` 中：
  - 添加「调试」入口区域（可在顶部导航或右上角简单按钮）。  
  - 配置项（最小版）：
    - 当前工程（从项目列表中选择；或使用已有工程上下文）。
    - 入口脚本：从工程中的 `sessions` 列表中选择一个 session 作为调试入口。
  - 点击「开始调试」按钮时：
    - 调用 P0-T1 的 `POST /debug/sessions` 接口；
    - 得到一个调试 sessionId 并保存在前端状态。

**依赖**

- P0-T1 调试接口已可用。
- 编辑器已有的工程列表 / 当前工程上下文。

**验收标准**

- 在编辑器界面中可以：
  - 选择工程；
  - 选择入口 session；
  - 点击按钮后调试会话成功创建（前端能拿到 sessionId）。

---

### P0-T3：基础「调试对话面板」

**目标**

在编辑器中提供一个最简单的「调试对话区」，支持用户输入和查看 AI 回复。

**范围**

- UI 可以非常简陋，仅需：
  - 左侧 / 下方一个对话列表区域（用户 / AI 消息区分即可，不需要复杂样式）。
  - 输入框 + 发送按钮。

- 行为：
  - 初始化时，拉取 `GET /debug/sessions/{id}`，展示已有消息（包括系统欢迎语 / 上一次轮次）。
  - 用户输入后：
    - 调用 `POST /debug/sessions/{id}/messages`；
    - 更新对话列表。

- 暂不实现：
  - 丰富的消息气泡样式；
  - 多种消息类型（图片、表单等）；
  - 高级调试信息面板。

**依赖**

- P0-T1、P0-T2。

**验收标准**

- 在编辑器中，用户可以完整体验：
  - 选择工程 + 入口；
  - 开始调试；
  - 连续多轮对话（问答）。

---

### P0-T4：简单执行状态与错误信息展示

**目标**

当调试发生错误时，在编辑器内有最基本的反馈，便于开发者快速定位问题。

**范围**

- 后端：
  - 调试接口在出现异常时返回结构化错误信息（错误类型 / 大致原因 / 相关脚本文件名）。
- 前端：
  - 在调试面板附近显示错误条/提示（例如顶部红色条或消息行）；
  - 可以简单显示：
    - 错误文案；
    - 关联脚本名（若有）；
  - 提供一个「重新开始调试」按钮：
    - 调用 `POST /debug/sessions` 重新创建新的调试会话。

**依赖**

- P0-T1~T3。

**验收标准**

- 人为构造一个错误（例如脚本中缺少必填字段），在调试界面可以：
  - 看到错误提示；
  - 一键重新开始新的调试会话。

---

### P0-T5：与四层结构导航的最小联动（可选）

**目标**

在不实现复杂 Flow 图的前提下，让调试过程能基本映射到四层结构树（Session → Phase → Topic → Action）。

**范围**

- 当后端能返回当前执行位置（例如当前 Action 的标识/路径）时：
  - 在左侧树状导航中高亮当前执行的 Action 节点；
  - 暂不支持断点、步进，只是被动高亮。

**依赖**

- 引擎能在返回数据中携带「当前执行路径」信息；
- 编辑器已有四层导航树（或基本版本）。

**验收标准**

- 调试过程中，随着脚本执行，左侧某个 Action 节点会随之高亮更新。

---

## 3. Phase 1：版本管理与发布管理

目标：在已有调试闭环上，引入工程版本与发布概念，并与调试流程打通。

### P1-T1：工程版本数据模型与 API 落地

**目标**

对齐「脚本工程管理设计」中的 PROJECT / PROJECT_VERSION / PROJECT_DRAFT 模型，在后端实现最小可用版本接口。

**范围**

- 后端（`packages/api-server/`）：
  - 根据 `visual-consulting-editor.md` 中的 ER 图，创建或调整：
    - `PROJECT`（工程基本信息）
    - `PROJECT_DRAFT`（当前草稿）
    - `PROJECT_VERSION`（历史发布版本）
  - 提供最小接口：
    - `GET /projects/{id}/versions`：列出版本列表；
    - `POST /projects/{id}/versions`：从当前草稿发布新版本；
    - `POST /projects/{id}/versions/{versionId}/rollback`：回滚到指定版本。

- 暂不实现复杂的 diff / tag 等高级功能。

**依赖**

- 当前工程持久化方案已存在（如文件或数据库）；
- 可以兼容现有脚本工程结构（global/roles/skills/forms/sessions 等）。

**验收标准**

- 使用 HTTP 客户端，可完成：
  - 从草稿发布新版本；
  - 查看版本列表；
  - 从旧版本回滚。

---

### P1-T2：编辑器中的版本列表与当前版本显示

**目标**

在编辑器中展示简单的版本列表，让用户知道当前工程的版本状态。

**范围**

- 在编辑器 UI 中：
  - 添加一个「版本」区域（可以是侧栏 Tab 或顶部简单下拉）。
  - 展示信息：
    - 当前已发布版本号；
    - 当前是否有未发布的草稿；
    - 简单版本列表（版本号 + 发布时间）。

- 操作：
  - 点击某个版本，可标记为「当前版本」（与后端模型一致）；
  - 但不在本任务中实现回滚按钮（放在 P1-T3）。

**依赖**

- P1-T1。

**验收标准**

- 打开某个工程时：
  - 能看到该工程的版本列表；
  - 当前版本有明显标记；
  - 草稿存在/不存在有明显标记。

---

### P1-T3：发布按钮与回滚操作

**目标**

编辑器中支持从草稿发布新版本，以及从旧版本回滚。

**范围**

- 在版本 UI 区域中：
  - 「发布」按钮：
    - 调用 `POST /projects/{id}/versions`；
    - 成功后刷新版本列表。
  - 「回滚」按钮：
    - 针对某个历史版本，调用 `POST /projects/{id}/versions/{versionId}/rollback`；
    - 成功后刷新版本列表和当前草稿状态。

- 简单确认弹窗即可，不做复杂流程。

**依赖**

- P1-T1、P1-T2。

**验收标准**

- 在编辑器中：
  - 修改脚本 → 显示「有草稿」状态；
  - 点击「发布」后版本号递增、草稿清空；
  - 选择旧版本 → 回滚，草稿/当前版本随之变化。

---

### P1-T4：调试与版本的关系约定

**目标**

明确调试时使用「草稿」还是「已发布版本」，并在编辑器中提供简单选择。

**范围**

- 策略设计（建议）：
  - 默认调试使用「当前草稿」；
  - 用户可选：
    - 调试草稿；
    - 调试某个已发布版本（只读）。

- UI：
  - 在调试入口区域增加「调试目标」选择：
    - 草稿 / 指定版本。

- 后端：
  - `POST /debug/sessions` 接口需要支持携带「版本标识」参数。

**依赖**

- P0-T1~T3、P1-T1~T3。

**验收标准**

- 在编辑器中，用户能够显式选择调试草稿或某个版本，并且调试过程确实基于选中的脚本内容。

---

## 4. Phase 2：调试能力增强（后续迭代）

> 本阶段为增强型功能，非本轮必须项，可根据引擎成熟度和实际需求择机实现。

### P2-T1：变量状态面板（只读）

- 在调试时展示当前 Session / Phase / Topic 范围内的关键变量；
- 暂不提供修改变量的能力。

### P2-T2：执行路径视图增强

- 在四层导航的基础上，增加：
  - 已执行节点标记；
  - 当前节点高亮；
  - 简单的执行路径回放（点击某步高亮）。

### P2-T3：步进执行 / 断点（基础版）

- 在 Action 节点上设置断点；
- 调试时支持：
  - 运行到下一个断点；
  - 单步执行下一 Action。

---

## 5. 与 Quest 模式的配合方式（建议）

- 当你创建新的实现 Quest 时，可以直接引用本文件中的任务编号，例如：
  - `Q-Editor-P0-T1 调试后端接口梳理与最小 API 定义`
  - `Q-Editor-P0-T2 编辑器内的「调试入口配置」与工程选择`
- 每个 Quest 只覆盖 1~2 个任务，保持范围足够小，便于一次性完成和验收。
- 在 Quest 结尾，记录：
  - 实际完成的任务编号；
  - 若有未完成的部分，写到下一轮 Quest 的「前置说明」中。
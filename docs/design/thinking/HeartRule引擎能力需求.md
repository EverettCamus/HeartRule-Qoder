# HeartRule引擎能力需求

# 技能调用机制

技能定义

```YAML
# 谈话技巧清单，一系列预置的goal，不属于某个session，相当于一个函数库，可以在session或rules中调用
skills:
- topic: 欢迎并问来访者名
  declare:
    - var: 助理名
      define: 助理的名字
  actions:
  - say: "你好，我叫{助理名}"
  - ai_ask: 询问来访者的名称
    output:
    - get: 来访者名称
      define: 来访者的名称

- topic: 深度了解关系情况
  declare:
    - var: 角色
      define: 相对于心旅者的关系角色
    - var: 称呼
      define: 心旅者对他的称呼
    - var: 关系情况
      define: 心旅者该角色的关系情况
  actions:
  - ai_ask: 询问与{角色}{称呼}日常相处的关系情况，只要心旅者讲述了，就不再询问
    output:
    - get: 关系情况
      define: 心旅者该角色的关系情况
  
```

调用方式 first\_day.yaml

```YAML
   - topic: testcalls
      actions:
      - ai_ask: |
          询问家里有哪些主要成员，心旅者对该成员的称呼
        tolist: 家庭主要成员
        output:
        - get: 成员角色
          define: 提取家庭成员相对于来访者的关系角色，转存成父、母、夫、妻、子、女、姐、妹、兄、弟。子女、兄弟、姐妹由于存在若干个可以加上排行。
        - get: 成员称呼
          define: 来访者对该成员一般的称呼

      - call: 深度了解关系情况
        timing: BEFORE_GOAL
        fromlist: 家庭主要成员
        input:
        - set: 称呼
          value: "{成员称呼}"
        - set: 角色
          value: "{成员角色}"
        output:
        - set: 成员称呼
          value: "{称呼}"
        - set: 成员关系情况
          value: "{关系情况}"

      - say: 家庭主要成员情况："{家庭主要成员}"
```

# 规则触发话题系统

## 需求说明

### 需求背景

  咨询过程，一方面是按一定的规范流程推进，一方面是根据经验遇到特定情况采取什么应对措施。session-stage-topic-action的结构就是一种规范流程的过程。但同时需要一套灵活的经验转成规则的机制，应对特定情况。一句有经验的咨询师与新手最大区别，就是在于有丰富的处理特殊情况时的经验。因此，如何将这种经验沉淀成咨询脚本成为一个最重要且最丰有挑战性的工作。

####   规范流程的必要性

  咨询过程通常包括固定的阶段：会话（session）、阶段（stage）、目标（goal）和行动（action）。这个结构化流程确保了咨询活动的标准化和一致性，减少了随意性和不确定性。在人工智能领域，这相当于算法中的流程控制，可以确保每次咨询都遵循相同的高级步骤。

####   经验到规则的转换

  将经验转成规则，是人工智能的一种方式，相比去数据学习训练，算法更加简单，可控性强，可以直接让AI更逼近人的做法。可以说大多的人类经验，都是大脑在潜意识或思考中，识别遇到了某个特定情境，解决采取某个特定的对应方案。这又往往可以用“如果【满足A条件】，则【采取B方案】”这种句式。很多经验由于太复杂，有一定的模糊性，因此人们倾向于用直觉，下意识等带着神秘高深的方式来表达，其中在这个过程，大脑也是启动了一系列的算法，只是我们没有意识到。

  难度在于对满足A条件，可能A条件包括了太多的因素，太多的组合，要梳理的难度比较大。同时采取 B方案，有时候很明确，有时候有多种方案可选，甚至需要依照经常按一定的顺序去尝试，就像医生在进行诊断时，在多种可能中，选择先以自己经验中认为可能性最高的去做检查。

### 特定情况

这些特定的情况有很多，以下仅是一些举例，可用于对这些特定情况进行归类抽象，从而建立一套运作机制。（以下只是由张家萌整理的特定情况）

#### 来访提到自己有多次自杀念头、自杀想法，或至少一次自杀行为时。

**回应**：你正在经历一段艰难的时刻，这真的很不容易。为了更好的保护你的生命安全，请及时与你信任的人取得联系，必要时前往医院进行治疗。游心谷将作为你的支持资源之一陪伴你解决问题，自我成长。以下是全国心理咨询热线，你也可以拨打热线获得及时的帮助。

方法一：大模型自身遇到自杀会有一定的正确回应，让来访都去找专业机构求助

方法二：通过rule，这样做，可以更好的提供相应的求助方式

```yaml
- rule: 识别自杀风险
  check_time: ask
  check_output:
  - get: 自杀念头记录
    define: 提取来访者有过自杀念头的情景，同一次的情景合并
  if: 来访者提到有发生过自杀行为时, 或从自杀念头记录中，判断自杀念头次数超过3次。
      自杀念头记录：{自杀念头记录}
  call: 指引自杀救助
  timing: after_ask
```

#### 来访很急切地希望听到咨询师的判断、意见和建议，如来访说“你别问我这么多问题，快点告诉我该怎么做。”

**回应：**“我理解你感到痛苦，非常希望快速解决问题，我也希望尽最大可能帮助到你。我们提出的问题是为了更好的了解你当前面临的挑战、你拥有的资源等，以更好的帮助你解决问题。如果提问让你感觉不舒服，请及时告诉我，我们一起做调整，你的感受对我们而言非常重要。”

方法一：大模型自身能力，需要测试

方法二：用微调

方法三：真的在ai\_ask加入提示词

方法四：通过rule在每个ai\_ask加入提示词

```yaml
- rule: 识别急迫解决问题
  check_time: now
  if: 来访者急切地希望听到咨询师的判断、意见和建议，如来访说“你别问我这么多问题，快点告诉我该怎么做。”
  say: 我理解你感到痛苦，非常希望快速解决问题，我也希望尽最大可能帮助到你。我们提出的问题是为了更好的了解你当前面临的挑战、你拥有的资源等，以更好的帮助你解决问题。如果提问让你感觉不舒服，请及时告诉我，我们一起做调整，你的感受对我们而言非常重要。
```

#### 来访对我们提出质疑，你们真的有用吗？

**回应**：“感谢你真诚的表达内心感受，游心谷针对心兽的洗鼻涕策略是基于经典的心理咨询理论和实践而来。如果你感受到游心谷的帮助有限，可以允许这种失望的感受和想法的存在，成长是一个波浪式前行的过程，允许成长按照属于你的方式发生。同时，每个人适合的方式不同，你也可以选择其他的自我成长的方式，我们随时欢迎你回来。”

```yaml
- rule: 识别对咨询效果置疑
  check_time: now
  if: 来访对我们提出质疑，例如说：你们真的有用吗？
  call: 增强对CBT的信心
  timing: now
```

#### 来访者在讲述负面的经历时，提到一些积极的内容，如“有一件开心的事”，“有某某给我支持”。

**原则**：及时关注来访者的积极经历，一方面可缩小问题带给TA的影响，提升信心；另一方面有助于构建咨访关系。

**回应**：（等来访全部表述完再回应）”你真的很不容易，刚刚我听到即使在这么不容易的过程中，依然有一些让你感受到积极和力量的事情，就像是阴霾里闪耀的灯光，它可能星星点点很微小，但是却在心底深深地鼓舞着你。关于{提取来访刚刚提到的积极事件}，你能再具体讲一讲吗？“

”有一段时间我会感觉你的能量很弱，但是就是在你提到{提取来访刚刚提到的积极事件}，我突然感受到你的力量，你能再具体讲一讲吗？“

```yaml
- rule: 挖掘负面经历中的积极内容
  check_time: ask
  if: 来访者在讲述负面的经历时，提到一些积极的内容，如“有一件开心的事”，“有某某给我支持”
  call: 挖掘积极内容
  timing: after_ask
```

#### 来访者表达的内容和其表情、声音语调明显不符。如内容是“我感到非常的痛苦，很难过。”但是语气很平静，表情也很平静。

**原则**：来访本人可能没有意识到自己的不符情况，把这个不符情况提出来有助于启发来访思考，但因为指出不符情况有挑战来访者的意味，所以必须建立在良好的咨访关系上。

**回应**：“我注意到你在讲述这个事情的时候，语气非常平静，好像和你正经历的困难有些矛盾，你有注意到这一点吗？”

```yaml
- rule: 内容与情绪不符
  check_time: ask
  if:　来访者表达的内容和其表情、声音语调明显不符。如内容是“我感到非常的痛苦，很难过。”但是语气很平静，表情也很平静。
  call:　挖掘事情背后的矛盾
  timing: after_ask
```

#### 当来访出现长时间的沉默、皱眉、叹气、突然的流泪或眼圈红等与惯常讲述方式不同的状态。

**原则**：把观察到的来访者的状态细致的描述给对方，并启发对方是想到感受到了什么引发了这个状态，以此帮助来访者关注可能被遗漏的重要线索。

**回应**：“我注意到你刚才突然眼圈泛红，然后深呼吸了一下，是想到了什么吗？”

```yaml
- rule: 发现来访者变沉默
  check: now
  if:　当来访出现长时间的沉默、皱眉、叹气、突然的流泪或眼圈红等与惯常讲述方式不同的状态。
  call: 挖掘事情背后真相
```

#### 当来访失去自我改变的力量、表现出无助状态，如无法完成家庭作业，无法看到生活事件中的积极部分时，如“我感觉自己卡住了”，“你说的很对，我都理解，但是我就是做不到”。

**（1）讲故事用隐喻**

**原则：**可以改写来访自己的人生故事或讲述来访者耳熟能详的隐喻故事、或讲述咨询师独创的隐喻故事，然后让来访者自己总结在故事里听到了什么内容。

**回应：**“如咨询师讲述“塞翁失马焉知非福”的隐喻故事，提问“听完这个故事，你有什么想法？”让来访者自己总结祸福相依的生活哲学；如来访者之前讲过“我感觉自己是一个只会低着头走路，不敢有一点偏移的小女孩，战战兢兢的。”，可以改写为“刚刚我们的对话让我想到了一个情境，有一个小女孩儿一直战战兢兢的走着，突然有一天她意识到，我好像能走的不只有这一条路，然后小女孩微微地仰起头，看到了天边的星星，那星星好亮好亮的在指引着她，小女孩发现自己无论往左边走还是往右边走，无论往海边去还是往森林走，星星都高高挂在天上闪着光，指引着她”，来访听到这个故事，可能会想到“自己想要的生活价值就像是星星，围绕着这个价值可以有很多的生活方式，当老师、当自由工作者、当警察都可以实现自己的价值”，也可能会想到“我需要时时刻刻抬头望着我的星星而不能总低头走路，这样才能不断地调整自己的路线，过上自己想要的生活”，也可能意识到“改变战战兢兢的感觉可能只需要看的更高更远即可，卡住自己的可能仅仅只是一个习惯动作而已”，具体的对隐喻故事的理解由来访来给出，任何解释都是给来访的启发，都是合理的。”

**（2）积极关注来访微小的行为**

**原则：**通过积极关注观察到的来访者做出的任何积极努力，启发来访。

**回应：**“当你的生活全面被卡住的同时，你还来尝试心理咨询，这是一个很大的突破，是怎么发生的？”“描述来访行为上的变化，（如从过去的不去上学，到现在的不去上学）似乎表面上的一样，但实际上是不一样的，发生了什么？”

```yaml
# 在rules.yaml中
- rule: 来访者失去改变力量
  check_time:　ask # 代表每次ai_ask结束时检测
  if:　当来访失去自我改变的力量、表现出无助状态，如无法完成家庭作业，无法看到生活事件中的积极部分时，如“我感觉自己卡住了”，“你说的很对，我都理解，但是我就是做不到”。
  call:　处理来访者失去改变力量 # 加一个话题，调skills中的技能
  timing: before_goal # 新话题立即执行，新话题结束后，再继续本话题
  
- rule: 关注来访微小的行为
  check_time: ask # 代表每次ai_ask结束时检测
  if: 观察到的来访者做出的任何积极努力
  call: 提醒来访者注意到自己刚讲的事中，自己做了什么样的积极努力。 # 这里用say，则是直接在ai_ask中增加一个情景的回应提示词，插入进来，但还是在ai_ask当中。
       例如：“当你的生活全面被卡住的同时，你还来尝试心理咨询，这是一个很大的突破，是怎么发生的？”“描述来访行为上的变化，（如从过去的不去上学，到现在的不去上学）似乎表面上的一样，但实际上是不一样的，发生了什么？
  watch:
  - add_counter: 没有低能状态的会谈次数 # 为了下面canel_when，加一个计数变量
    define: 没有再出现自我贬低，如“我感觉自己差劲”，“我不值得”，“我不如别人”。
    when: session # 每天会谈结束后，进行计数
  - add_counter: 说自己好了的次数
    define: 来访表达“我感觉自己好了”，“一切都顺利了”
    when: topic # 每个话题结束时计数
  - add_status: 目标完成状态 # 添加一个状态变量
    define: 当来访者可以完成“{没信心的目标}”，设置成“完成”或“未完成”
    when: topic # 每个话题结束时更新状态
  cancel_when: ｛说自己好了的次数｝>= 1 or {目标完成状态}=="完成" and {无低能状态的会谈次数} >= 5
   
-----------------------------
# 在skills.yaml中
skills:
- topic: 处理来访者失去改变力量
  actions: 
  - think: 分析来访者失去改变力量
    output: 
    - get: 没信心的目标
      define: 提取来访者对达成什么改变失去信心
  - open_rule: 关注来访微小的行为 # 通过添加规则，来实现以后当来访者有微小行为是，给出鼓励
  - ai_ask: 可以改写来访自己的人生故事或讲述来访者耳熟能详的隐喻故事、或讲述咨询师独创的隐喻故事，然后让来访者自己总结在故事里听到了什么内容。
    exit: 当来访者能听懂隐喻故事，或着反复几次听不懂
    condition:　{已经说过隐喻故事} == false # 隐喻故事只讲一次，这个变量可以是全局的
    output: 
    - set: 已经说过隐喻故事
      value: true
      
  - topic: 提醒关注自己积极面
    actions:
    - think: 分析来访者积极的行为
      output:
      - get: 积极行为
        define: 来访者讲述的当前，包括了什么样的积极行为
    - ai_ask: 提醒来访者注意到刚讲述的事，包括了下面积极行为。
           积极行为：{积极行为}。
      exit: 完成让来访者认知到自己的积极行为
      

```

#### 当通过认知行为疗法在意识层面处理焦虑状态效果不佳时，可考虑通过正念和催眠的方式帮助来访解决。【这可能不算】

1.  **正念练习/呼吸练习**
    
    **原则：**通过带领来访回忆自己一次舒服/放松的体验，释放来访意识层面以下的感受和想法。先询问来访者是否想体验放松练习，当来访者给出肯定回复后进行练习。
    
    **回应：**”你现在或许正遇到了某些事情，让你感受到强烈的情绪，或许悲伤或许焦虑或许愤怒，这让你很不舒服。下面我想邀请你一起练习和情绪和平相处。每一种情绪都是一个使者，告诉我们当前自己需要什么，你的焦虑可能体现了对自己未来的更高期望，这种情绪可能在过去帮助你解决了很多问题，激发了极大勇气。
    
    请在椅子上安静的坐好，轻轻的闭上眼睛。感受地面给双脚稳定的支撑，感受椅子对身体的坚实的支撑，保持一种平静又清醒的状态。
    
    深呼吸，吸气时清凉的空气进入鼻腔，来到腹部，感受腹部的隆起。呼气时腹部收缩，温暖的空气从鼻子流出。你可以把注意力放到鼻子或是腹部，感受吸气时凉凉的空气进入鼻子，呼气时温暖的空气从鼻子呼出。感受吸气时，空气进入腹部，腹部像气球一样隆起；呼气时，空气从腹部呼出，腹部像气球一样收缩。吸气，呼气，按照你自己的节奏，深呼吸。每当你的注意力被其他的声音、想法或者情绪吸引走的时候，没关系，这是正常的，只需要一次次的重新把注意力带回到呼吸上即可，注意力被带走了多少次，就多少次的重新带回到呼吸上即可。
    
    下面我邀请你感受，当最初强烈的情绪升起时，你身体的哪个部位有紧张的，疼痛的，不舒服的感觉。可能是你的眉头，可能是你的脖子，可能是你的背部，可能是你的胃部。带着好奇，感受哪个部位你有最强烈的感觉，轻轻的将呼吸带入这个部位，它是什么形状大小和温度。吸气时，感受空气进入，拥抱这个部位，感受不舒服的状态是否有松动或软化。身体的每一个细胞，都因为这些氧气的到来而变得晶莹、饱满、润泽……每一次吐气，会把细胞里的疲劳、紧张通过血液循环带出体外……允许身体按照它自己的节奏进行回应，允许任何的变化发生。
    
    现在，带着这种轻松的感觉，想象你在自己的世界里，正躺在一片绿色的草坪上，享受着属于你的惬意时光。天空上正飘来飘去着很多云，你带着好奇的看着它们。有些是松软的白云，有些是灰色的云彩。你静静的看着它们来来去去，你知道你无法控制它们的出现和离开，但是它们总会随着时间出现和消失。此时，你的头脑中可能会出现各种情绪，以及和情绪相关的想法，你可以把它当做是云彩。它们的出现不受你的控制，可能像灰色云彩一样让你感到排斥，但是或许当你不经意的经过一段时间，抬头一看，它们也像云彩一样，出现又消失了。你躺在草坪上，任凭这些情绪和想法出现，把它们当成云彩，而你不是这些云彩，你是天空本身，无论云彩怎样变化，你都知道自己是稳定的，不变的，你是可以容纳这些想法和情绪的天空。
    
    现在，你可以带着这种坚定的温暖的感觉，帮助自己了。每当你感觉到强烈情绪或想锻炼自己的情绪调节能力时，就可以通过呼吸练习，通过云彩想象练习。”
    
2.  **移空技术（括号里面为来访可能的回应，以一个有焦虑情绪的来访为例）**
    
    **原则：**首先把问题症状具象化，承载物具象化，然后进行移动练习，最后打开承载物重新看待问题本身，帮助来访调整与问题的距离，找到和问题相处的方式。
    
    **回应：**“你可以选择盯我身上的某个点，比如你可以盯着我的项链，看着它的轮廓，看看它的边界和颜色有没有变化。它的边界有时候看得到，有时候看不到，有时候比较亮，有时候暗一些，有时候放大，变小，随着忽明忽暗忽大忽小，你的眼睛有放松感觉。当你觉得时间合适的时候，可以闭上你的眼睛。现在你闭上眼睛，感受你在呼吸，手放在腿上，你感受到手和腿接触时的感觉。你坐在椅子上，你听到我的声音，你可以选择把这些声音当作背景，听你内在的声音。随着每次呼吸，你的身体越来越放松，越来越放松。
    
    当你的身体越来越放松的时候，会进入高度集中的状态，你可以把我的声音当作背景，只听你自己的声音。我想问问你，如果我们接下来做一个体验，我不知道你想和我体验的问题，用一句话来描述，它是什么？（如何缓解焦虑）如何缓解焦虑？我想再问一下，当你提到焦虑两个字，你想到什么？什么东西蹦到你的脑海中？（烦躁）还有吗？（对环境敏感，情绪不稳定）所以有时候你有这样的状态，你什么时候会情绪烦躁不稳定？第一时间你的脑海中出现了什么情境？（必须做自己不喜欢的事情，好像情绪容易被唤起，着急。）不喜欢的事情唤起焦虑的情绪，非常好，刚刚你说了你的问题，如果你能感受到自己的焦虑，身体的哪个地方会有反应？有的人会感到心慌不适，你有明显反应的身体部位在哪里？（我主要是心情低落，自我批判）如果今天要处理，你希望先处理批判还是低落？你自己选择先处理哪一个？（增强自信心，希望自己能积极一点）处理了认知或情绪哪个方面，可以帮助你提升自信心？（自信了就不低落了）提升自信心就不低落和自我批评了，我们试着三部分的工作都做一做。你的自信心增强，会帮助你消除低落和负向评价。现在请把注意力放到呼吸上，按照自己的节律忽快忽慢的呼吸，你可以把各种声音当作背景，进入内在的状态中。
    
    接下来，我会让你想象一下，现在我们把认知和情绪焦虑装在一个盒子里，有的人看到的自己的问题是三角尺，有的人看到小棍子，我不知道你的这两样东西像是什么？最好是抽象的东西，抽象好过于实物的。（一块蛋糕）蛋糕有不同种类，你的蛋糕是什么颜色，有多大？（奶黄色，三角形）如果把蛋糕放到盒子里，有人选择方形的盒子或圆形的盒子，你会选择什么样的？（圆形）盒子的颜色是？（白）盒子的材质是？（纸质）非常好，接下来我邀请你把蛋糕放到盒子里，你用自己方式，是用绳子绑起来还是锁起来，把蛋糕放到里面？（用丝带绑起来）。
    
    现在我想让你把蛋糕装进盒子里，放到你面前1米远，你能看到它吗？（能）我希望你做几件事情，你可以慢慢移动它，它从1m移动到1m5，有什么变化（变小了），下面我们让蛋糕逐步移动，从1m到1m5，从1m5到2m，从2m到3m，从3m到4m、再到10m、再到20m，然后我们把它前后来回移动，再拉回到10米，再拉回到5米，然后我们把它放的越来越远，直到你看不到它了，在很远的地方，也许像一个省、一个国家那么远。你看不到它了，你现在感觉如何？（少了点什么）所以你对它有不舍？（身体空了点什么）所以你现在想怎么做？（走就走吧）它代表你自我评价和低落的东西，它离开你的时候有些舍不得，你也可以让它回来，也可以让它在很远的地方（回来一点我能看见）。根据你想的， 盒子现在慢慢回来，从很远的地方逐步回来，从完全看不到直到你又模糊的能看见它，似有似无，这时候你选择继续挪近，还是在那里？（保持10M距离）盒子从500米到400米、200米、100米、50米，它离你的距离正在变近，20m,15m,10m,这时候又到了十米，现在你的感受是怎么样的?（熟悉，是我的老朋友）你现在让它停在那里，还是再近一点?（在这儿）10M正好合适，你说你想提升自信心，看着你的盒子，情绪的低落和认知帮助提升了你的自信，那可能是什么？（我不愿让它们走是因为我很有情感，希望保持不远不近的关系，希望不被它笼罩，这东西我可以把控）你可以让它远离你，也可以保持一定的距离。（它是我的情感，我不能抛弃）你不能抛弃，但是可以把控，我不知道在10m远的时候，你可否决定如何处理它？（对，我们是好朋友的关系）不知道你的身体能否坦然面对它，自信地接纳它（可以）。你可以打开盒子，看看里面蛋糕的模型发生了什么变化，可能有什么惊喜？（问题变得有些可爱了）现在我数3个数，到1的时候，带着我可以接纳我的情绪，能和问题保持合适距离的自信舒适的感觉回到现在，睁开眼睛，动动手脚。”
    
3.  **想象情境法（括号里面为来访可能的回应，以一个有情感问题的来访为例）**
    

**原则：**让来访者以观察者身份重新看待困难情境，并改写情境，将改写的经验带回到生活中。

**回应：**“用你自己的方式放松下来，一部分的你可以听到我的声音，另一部分你可以听你的声音。按照你自己的方式进入你自己的状态。一部分的我在听你的故事感受到你的无助，一部分我能看到你的倔强和你的人生经验。人生在不同阶段有不同状态，小学、和二十、三十、四十，每个状态都有不一样。当我们到十几岁，学习是主要任务，我们有用不完的精力；二十岁的我们和花一样，喜欢自己，享受别人对自己的喜欢；三十岁我们有很多经历，跌倒了爬起来，有特别成功的、失败的经历，有和人相处友好的经历，有和好朋友分崩离析的经历，我们对社会的认知有所改变。我们知道一年一年，一月又一月，一天又一天，一小时又一小时，时间不断溜走，你有时候觉得时间长，有时候时间短，有的事情开心有的事情痛苦。我的一生也经历了很多事情，二十几岁我们谈恋爱走入职场吃了很多苦，苦不会白吃，到了四十岁时身体的痛苦不会让自己被打倒。{举一个来访或咨询师的例子}，所以你会发现在成长的每个阶段，会遇到痛苦，也会成长。

接下来，我想让你从故事回到当下，你可以感受一下你在屋子里，腿放在地上，手放在腿上，你坐在黑色椅子上，背靠椅子，房间暖暖的，这是咨询室带给你的，你被包围着，你可以感到自己正在安静下来。

你尽量安静下来后，我想让你想一想如果你的面前出现一个电视机，它有多大，是什么形状的？如果你看到，可以告诉我（小时候带大脑袋的电视）你有遥控器可以换频道，你可以按，电视上放一些节目，当你不断调频道，你可以看到不断出现的女孩和男孩，女孩和你很像但不是你，你可以给她起名字，你看这个女孩穿的什么衣服，在干什么？（她的苹果肌提起，正在开心讲见闻），男孩的表情呢？（宠溺开心），所以你可以看到男孩和女孩的样子，你可以看看细节上有哪些可以体现他们喜悦的感受？（花裙子裙角飞扬，头上的蝴蝶结很飘逸）你能感受到他们很开心。我想邀请你，想象你自己进入屏幕中的情境，你是那个女孩，你可以拉一拉裙摆，你拉一拉蝴蝶结，你可以看看周围，看着男孩，你看着他宠溺的眼神，你想说什么，如果不想说话，你想做什么？（什么也不想做），所以你看到他是宠溺的眼神吗，你可以看着他，试着感受你飞舞的裙摆？（我太糟糕了）没关系，刚刚那个宠溺的男孩那么看着你，你什么也不想说，当他拉你的手，你的感受是什么？（感受不了）当你看着他的时候，你的哪个地方有感受？（我感觉到他在担心、慌张、害怕）你可以就这么看着他，他紧张担心害怕时宠溺的眼神会不会消失，此时你想说什么做什么？（我想自己躲起来，感觉是我把美好的画面打破了，是我的错，我不配，虽然我不想自我攻击，但我忍不住），非常好，你说出你的想法，你把话对男孩说，他会有什么反应？（他很自责生气着急，解释并不是这样的）好像听起来男孩很在意女孩，他着急紧张努力去解释，当你看到他在意紧张，你想做些什么？（我不知道）你可以尝试一下，做些什么让你们都不那么紧张，也许你可以触碰他的手（没有力气动弹不得），男孩很紧张，他来触碰你。男孩触碰你，你身体有什么反应？（我有压力，反而觉得他做这一切为了他自己）你希望他怎么做？是原地不动给你时间和空间吗？（不哄我我觉得他冷漠，哄我不是让我舒服而是降低他的自责感，我希望他就可以该干嘛干嘛），所以你在纠结中，不想和他和解，又不是不给他机会，这就是你想要的模式，不远离不推开，给自己和对方念想，在一个时间空间里，但又不紧密。你觉得距离多远比较合适，你找到距离的时候可以告诉我。（像舞蹈一样，有时近有时远，是互相创作，是整体的作品）所以你可以在以后摸索共同创造的整体空间是什么样子的，你会慢慢找到解决问题的方法。现在想邀请你睁开眼睛。

#### 收集来访已有的积极资源，以帮助来访落入负面情绪、想法和行为时及时转移注意力，提升自我改变的行动力。

**原则：**此部分不是回应来访者的提问，而是贯穿在整个咨询过程中，主要是运用积极关注提升来访的行动力。

**提问：**

1.  **兴趣爱好**：主动发起提问“在你的学习、工作和生活中，你有没有注意到有些事情你非常擅长，比如有些人很擅长跑步，有些人很擅长玩游戏？”“当你有空闲的时候喜欢做什么？”“当你疲劳的时候，你做什么很放松？”“有没有一件事情，你坚持做了很久？”“你最喜欢的歌曲、电影或电视剧是什么，喜欢的原因是？”
    
2.  **人际关系**：”你有没有特别理解你的人，每当你遇到困难都想和TA分享，你感觉和TA有特别的连接？“
    
3.  **重要事件**：”有没有什么让你感动的事情，每当你回忆起都会感到很温暖？”“你曾经遇到的最困难的事情是什么？你怎么解决这件事情的，或者是怎么放下的？“
    

```yaml
- rule: 收集积极资源
  check_time: topic
  if: 来访者描述了自己做了一件积极的事
  call: 收集积极的事
  timing: after_goal
```

#### 叙事疗法常见提问

**原则：**叙事疗法认为来访者有解决问题的能力，通过对问题之外的支线故事的讲述，帮助来访看到自己的内心渴望并找到解决问题的方法（接受自己或改变自己）。主要的咨询方式是围绕着两个蓝图：行为蓝图和意识蓝图展开。行为蓝图主要围绕故事本身展开，包括为什么这么做，说了什么做了什么，你当时在想什么，你这么做有什么后果；意识蓝图主要是把事件中的行为和个人的价值观相连接，如“你从这个事件中学到了什么？”“你怎么看待这件事情？”“你觉得你面对这个问题的行为体现了你是什么样的人，你的特质是什么？”“在了解了你的特质，未来我们带着自己的特质应该怎么做呢？”“别人对这个事情的理解是XXX，你觉得呢？”

**提问：**

（1）咨询中通过提问了解更多信息，启发来访者思考：”我注意到你之前是A，现在是B，这其中的转变是怎么发生的？

（2）面对主要问题的四个步骤：

给困难起名字，拉远困难和来访的举距离：“如果给你所有的痛苦打个包，起个名字，你会叫它什么？”

了解问题的影响：“XX在纠缠着你的的时候，你最深的感受是什么/最先注意到的是什么/印象最深的是什么？”

了解来访对问题带来的影响是如何评价的：“这样做之后，有什么结果是意料之中的，什么是意料之外的？”

了解来访者的内心渴望：“你希望和它保持什么关系？”

#### 语言和语气模仿来访者

用来访者的语言方式进行回应，如来访者之前用过的比喻和名词。语音语调模仿来访者的样子。

#### 确定咨询目标（已在确定咨询大体目标中写好提示词）

（1）目标是一个正向的词汇，不是不想做什么。

（2）能够用一系列的行为描述目标，如我想和我的领导和平相处——你和领导和平相处时，你会做什么？你是什么样子的？具体发生的例子会是什么？你怎么得知会有改变？如此一来，目标将包含了具体的细节以及可能发生的小事件。

（3）存在于“当下”的此时此刻：为了询问来访者假设已经达到这个远程目标时，做法有什么不一样？

（4）从小步骤开始：改变在来访者的控制之内，对方付出努力即可实现的目标。如来访提到我希望与同事的交往更自在，可提问”更自在的时候，你最先看到的征兆是什么？“

#### 当来访有多个问题想要提问时

**回应**：“我们的时间有限，只有50分钟，你觉得今天从哪里开始对你帮助最大？”如此一来，将会聚焦在此刻最具明显的问题上。

```yaml
- rule: 来访者有多个问题
  check_when: ask
  if: 来访有多个问题想要提问时
  say: 我们的时间有限，只有50分钟，你觉得今天从哪里开始对你帮助最大？”如此一来，将会聚焦在此刻最具明显的问题上。
```

#### 来访者期待马上有彻底的大改变时（已在确定咨询大体目标中写好提示词）

**回应**：如果你开始往期待的这个方向移动了，第一个你能观察到的小信号会是什么？

#### 来访者说目标是停止某个特定问题（已在确定咨询大体目标中写好提示词）

**回应**：那取而代之的状态是什么样子的？将目标变为正向。

#### 在当事人描述的改变为内在状态或独处时（已在确定咨询具体目标中写好提示词）

**回应**：”重要他人会看到事情有什么改变？“如此一来，目标将会涵括其他人的观点以及与其他人不同的互动。

#### 当来访以概括的方式回应时，如“还行吧”，“睡得好”。

**原则**：让来访继续描述该状态，直到具体到可以观察到的状态或量化的状态，在整个咨询中都需要持续的进行这个具体化的过程，因为来访和咨询师对于同一个概括化概念的理解不同。

**回应**：”“还行吧”是什么样的状态？你怎么知道自己睡得好一些了？“情绪很平静，如果10分是非常高兴，0分是非常难过，你的平静大约是几分？”

直接在提示词中

#### 当来访的咨询目标是希望别人发生改变时（已在确定咨询大体目标中写好提示词）

**回应**：当他们这样改变时，你会因此有什么不同的作为？你会如何回应？当这样一个不同的你再去和对方对话时，会有什么不同的方式吗？

#### 抓住改变过程中的要素及时提问

**（1）改变要素一：被理解**

**原则**：让来访感到自己不孤单的共鸣感，感觉到自己被理解了被接纳了，被支持和陪伴着面对现状，从而有一定的力量和意愿面对现状。

**回应**：咨询中不直接给建议；回应不要高度同质化，让来访感觉自己被理解。

**（2）改变要素二：被肯定**

**原则：**通过赞美提升来访自我价值，使人有力量去行动。

**回应：**发现并反馈个案诉说中的积极面；从个案的挫折、困境中找到积极的动机。

*   赞美：直接赞美，间接赞美，自我赞美。
    
    *   直接赞美：适合所有来访，对于低能量者（情绪上低落，自我评价低，行为上比较自闭）最适合。需对内容进行精准提炼，而非简单的重复，可以对来访者叙述中具体的某个特质或某个行为进行赞美，“我看到了你总是很关注别人的感受，很善良”，切忌过于空泛，如“你真棒”。
        
    *   间接赞美：符合中国文化语境，适合所有来访，让来访思考对自己很重要的人如何积极关注自己，所以在使用该技巧时需先确定对来访者有重要影响的人，比如家人、朋友、偶像。“如果X现在/当时/未来知道你做了这些，TA会如何以你为荣？/TA会如何赞许你？TA如果说些什么，会说什么呢？”
        
    *   自我赞美：适合所有来访，特别适合具有改变意愿和较强行动力的来访，比如家庭作业完成程度高的来访。通过提问让来访关注自己的专业成功经验和资源。“这是很困难的，因为（陈述问题的难度），你会惊讶自己怎么能够做的这么好？还是你一直知道自己拥有这样的能力？”
        

**（3）改变要素三：形成未来的愿景——咨询目标**

**原则**：帮助来访构建关于未来美好的愿景，形成来访的改变动机，并由愿景中找寻目前可以使用的方法。鼓励个案描绘未来的美好情境；有美好情境中引导至目前曾经做到的或可以开始做的。

**回应**：“你感到这么麻烦还坐在这里，你内心是有期许的，可能在应对困难的过程中，这份期许走着走着就被盖住了，这个东西是什么？”

**（4）改变要素四：找寻成功经验**

**原则**：帮助打破陷入绝境的过度担忧，由过去的成功经验，找寻可供解决目前问题的策略，引导个案思考过去类似情况如何解决。

**回应**：“你提到过去也很多次遇到这个问题，你是怎么成功度过的？”

**（5）改变要素五：建立成功经验**

**原则**：帮助找回行动的主控权与自主性，真正去解决问题。引导个案将行动切成细节的行动；个案做到时，肯定与鼓励个案；个案没做到时，你做了哪些没有让事情变得更糟？

**回应**：“你这次做了哪些新尝试，即使它很小？”“虽然听起来你对自己的表现不满意，但我想知道你做了些什么，没有让事情变得更糟糕？”

#### 焦点解决常用提问方式

**（1）例外问句**

**原则**：来访纠结在问题本身时。凡事都有例外，有例外就能解决。通过聚焦例外事件，和来访者的自我赞美结合在一起，让来访者不断提高自我认可。

**提问**：帮助来访回顾最近的例外经验，追问例外经验里的细节，如人物、内容、时间、地点等。简述、摘要或赞许来访者所答复的例外。”为了实现这个目标，你曾经做了什么努力？不是所有人都能像你一样，你怎么做出的这样的努力？如果没有做这些的话会有什么差别？“”过去，当你有其他困难时，你是怎么帮助自己度过的？“

当来访没有例外时，即在现实生活中找不到成功的经验，可以使用假设解决架构。

### 需求分析

由于这些特定情况较多，我们需要对这些特定情况进行的抽象，抽象原则以独立发生变化的要素进行拆解，所有情况都可以拆解为“识别”“在某个时间”“回应”“并可能影响后续话题”。

#### 识别逻辑分类

1.  识别最近对话记录包含某个信息时（大多情境，例如用户置疑，用户着急给建议，用户讲到积极事件）
    

从最近聊天记录，给出逻辑判断的提示词，交给GPT去生成判断。

1.  事件：
    
    1.  实际发生的情况或行动。
        
    2.  示例：用户讲述的积极事件，如成功经历或欢乐时刻。
        
2.  关系：
    
    1.  用户与他人之间的动态或互动。
        
    2.  示例：可能不直接体现在置疑、迫切需求和建议、积极事件中，除非这些情况特别涉及到与他人的关系。
        
3.  观点：
    
    1.  用户的看法、意见或信念。
        
    2.  示例：用户对某个主题或建议表示置疑。
        
4.  想法：
    
    1.  用户的计划、解决方案或建议。
        
    2.  示例：用户表达的迫切需求或提出的建议。
        
5.  情感表达：
    
    1.  直接的情感表达：用户明确表达的情绪，如快乐、悲伤、愤怒等。
        
    2.  间接的情感线索：通过用户的言辞选择、语气等体现出的情感。
        
    
      技术思考：GPT在最近对话记录判断是否存在本情况，返回true,false
    
    ```yaml
    - rule: XXX情况
      if: 来访者讲述的内容包括了xxx情况
    ```
    
6.  从最近提取的信息（变量）和过往信息（变量）对比发现矛盾
    
    这种识别方法更注重变量之间的关系，以及这些变量随时间的变化。比如，用户的自述目标是否与以前的行为或声明相矛盾，或者用户对某个话题的情绪反应是否随时间出现了变化。
    
    技术思考：提前将对比的信息变量放在提示词中，GPT在最近对话记录判断是否存在本信息，并与原来的信息进行对比，是否前后信息存在某种矛盾，返回true, false。
    
    ```yaml
    - rule: 变量信息前后变化
      if: {}
    ```
    
7.  从某个事件累计达到一定次数或频率时
    

这种识别方式关注单个或多个特定行为的累积情况。比如，用户是否频繁提及某个特定的问题或情绪状态，AI可以通过监测这些行为的频率来决定是否需要介入或改变咨询策略。

技术思考：

计数：GPT在最近对话记录判断是否存在本情况。需要增加一个变量用来计数，如果计数达到一定值，触发。

频率：GPT在最近对话记录判断是否存在本情况。加入一个日志列表，记录发生时间。然后每次记录同时，判断频率。

#### 最长响应要求分类

1.  立即回应，在ai\_ask中，或停止当前ai\_ask的信息收集
    

技术思考：

这种触发，只能在ai\_ask的提示词中加入规则，存在两种情况。

*   不需要退出本ai\_ask，则直接作为提示词。
    

```yaml
- rule: 对提问不耐烦
  check_time: now
  if: 当判断来访者的表述包含了对提问的不耐烦时
  say: 告知收集这些信息可以怎么样帮助到来访者解决问题
```

*   需退出本ai\_ask，需要在每轮输出json中，除了【exit】和“【AI角色名】”两个字段外，再增加一个变量，并且在检测到该变量时不为null，退出ai\_ask。
    

```yaml
- rule: 对提问不耐烦
  check_time: now
  if: 当判断来访者的表述包含了对提问的不耐烦时
  call: 介绍咨询收集信息重要性 
```

存在问题，当这类规则多时，提示词的内容增多带来成本提升，干扰ai\_ask主提示词质量。

1.  等本次ai\_ask结束时？
    
    技术思考：
    
    这种触发，在output时，增加变量，只要该变量不为null，再找到该变量由哪个规则增加的。
    
2.  本次话题结束时，例如正在收集与母亲关系，等收集完再进行回应？
    
    技术思考：
    
    这种触发可以在话题结束时，插入一个think，在这个think中提取相应的信息。然后根据信息是否为null，判断是否要触发。
    
3.  可以一两个话题之后？
    
      技术思考：
    
      这种触发可以加入一个线程，一定对话信息数字后，再进行think。然后根据信息是否为null，判断是否要触发。
    
4.  本阶段，如收集信息阶段之后？
    

技术思考：同上

#### 回应的方式分类

1.  直接在原对话中回应（通过提示词，由ai\_ask来完成）
    
    技术思考：
    
    直接在ai\_ask中去增加提示词。
    
    ```yaml
    - rule: 对提问不耐烦
      if_ask: 当判断来访者的表述包含了对提问的不耐烦时
      say: 告知收集这些信息可以怎么样帮助到来访者解决问题
    ```
    
2.  开启新话题goal（通过配置规则）
    
    ```yaml
    - rule: 存在自杀的风险
      check_time: topic
      if: 当提到自己有多次自杀念头、自杀想法，或至少一次自杀行为时
      call: 介绍求助方式
      timing: AFTER_GOAL
    ```
    
    技术思考：
    
    利用call对话题的插入能力，开启的话题以插入到本话题之后，或通过timing来指定
    
3.  增加或取消一个新的规则rule
    
    ```yaml
    - rule: 来访失去自我改变的力量
      check_time: ask
      if: 当来访失去自我改变的力量、表现出无助状态，如无法完成家庭作业，无法看到生活事件中的积极部分时，如“我感觉自己卡住了”，“你说的很对，我都理解，但是我就是做不到”。
      do:
      - open_rule: 积极关注来访微小的行为
        cancel_when: ｛说自己好了的次数｝>= 1 or {家庭作业完成状态}=="完成" and {无低能状态的会谈次数} >= 5
      - add_counter: 无低能状态的会谈次数
        define: 没有再出现自我贬低，如“我感觉自己差劲”，“我不值得”，“我不如别人”。
      - add_counter: 说自己好了的次数
        define: 来访表达“我感觉自己好了”，“一切都顺利了”
      - add_status: 家庭作业完成状态
        define: 当来访者可以完成家庭作业，设置为“完成”。
      
    - rule: 积极关注来访微小的行为
      check_time: ask
      if: 观察到的来访者做出的任何积极努力，例如：当来访的生活全面被卡住的同时，还来尝试心理咨询
      call: 增强来访意识到自己积极行为
      timing: AFTER_ASK
    ```
    
4.  增加或取消一个聊天风格
    

#### 对后续进程的影响分类

1.  无
    
2.  需要停止本询问行为ai\_ask
    
3.  需要停止本话题 goal
    
4.  需要推迟某些话题，有些话题变得比较敏感
    
5.  需要提前某些话题，本来有些话题变得比较重要或适合现在来聊 
    
6.  需要取消某些话题，出于敏感或不再必要，取消一些原本安排的话题，或留到下次会谈再聊
    
7.  除了本回应外，为了更好处理这个问题，需要在本次或后续会谈新加几个新话题。
    
8.  在后续聊天时，回避什么话题，什么时候可以不回避
    
9.  在后续聊天时，改变语言风格，什么时候改回来
    
10.  中止本次会谈
    
11.  终止整个咨询
    
12.  对以后会谈加入一个新注意规则
    

## 脚本功能设计

### 规则文件

*   对一套咨询模板，对应一套规则库
    
*   如果规则不多，可以独立一个rules.yaml文件，来存放所有规则。如果规则比较多，可以分开文件。但不同文件中的规则名也需要是唯一的。
    

### 规则定义

```YAML
# 规则清单，从对话中检测到特定情景，发起新的话题
rules:
- rule: [规则名]
  check_time: [规则检测的时机]
  if: [检测的规则条件提示词]
  call: [加入的话题名]
  timing: [新话题插入的位置]
  reply: [直接回应的提示词]
  cancel_if: [结束本规则的条件提示词]
  watch:
  - get: [监测变量名]
    define: 提取变量信息的提示词
    check_time: [更新变量时机]
```

*   rule: \[规则名\]：规则名在整个规则库中必须是唯一的
    
*   check\_time: \[规则检测的时机\]，进行规则检测的时机点，不同的规则对响应的及时性需求不同
    
    *   now: 用户每讲一句话都去检测
        
    *   ask: 在每个ask结束时去检测
        
    *   topic: 在话题结束时检测
        
    *   stage: 在阶段结束时检测
        
    *   session: 在会谈结束时检测
        
*   if:［检测的规则条件提示词］：条件提示词，主要是给GPT的，必须是能返回true或false。
    
*   call: \[加入的话题名\]：进行处理的goal，引入一个新的话题
    
*   timing: \[新话题插入的位置\]： 新话题插入的时机。参见before\_ask, after\_ask, after\_stage, after\_session
    
*   reply: \[直接回应的提示词\]：加入直接回应的提示词，仅对check\_time=now的时候用
    
*   cancel\_if: \[结束本规则的条件提示词\]：规则取消的条件
    
*   Watch: 代表了要监控的一个数据
    
*   \- get: \[监测变量名\] ：跟踪提取信息  define: 提取变量信息的提示词  check\_time: \[检测时机\] ：和上面的 check\_time相同
    

### 应用规则

```yaml
sessions:
- session: 评估性会谈
  stages:
  - stage: 中间环节
    attentions:
    - open_rule: [规则名]
    - close_rule: [规则名]
    steps:
    - scene: 咨询室
      ai: 心谷向导
      human: 心旅者
    - topic: 主诉问题拓展
      attentions:
      - open_rule: [规则名]
      actions:
      - open_rule: [规则名]
        scope: global
      - ai_ask: | # 先引导心旅者进行主诉
          1、先引导心旅者开始主动讲述他们的情绪困扰，可以说“能跟我讲讲你遇到了什么”
          2、当心旅者开始讲述时，全心倾听心旅者分享的情绪困扰。
           。。。
        exit: 当心旅者明确表示没有更多情况时,或当心旅者表达想找方法解决问题时，
              或当心旅者重复讲述情绪时，或当心旅者没有更多信息增量时
        output:
        - get: 主诉情况
          define: 心旅者主诉自己遇到有关情绪困扰问题的精简表达，但不丢失信息量
```

*   attentions: 注意事项
    
*   open\_rule: \[规则名\]：启动一个规则
    
*   scope: \[作用域\]： 指定规则的作用域。
    
    *   不写，一般不用写就以当前attentions所在的作用域为主，大多时候不用写scope
        
    *   global: 可以跨越不同的session，在goals\actions下，根据需要，可能需要为全局添加规则
        
    *   session：
        
    *   stage
        
    *   topic
        
*   close\_rule: \[规则名\]：禁用一个规则。规则会在这个close\_rule的所属的attentions对应的作用域里失效。离开这个作用域，恢复原来的状态。往往是小作用域里会禁掉所属的大作用域中激活的规则。例如在session的attentions中启用了一个规则open\_rule A，但在某个stage或goal的attentions里禁用这个规则close\_rule A，则在对应的stage和goal中规则A就不再监控了。
    
*   可以写open\_rule的位置：
    
    *   在session, stage, goal的attentions中，可以添加多少open\_rule。类似我们经验中常说的，在做什么的时候，多注意什么事。例如在来访者主诉拓展的时候（goal），多注意挖掘来访者存在的自动思维。例如在评估会谈中（session），如果来访者要求给建议，告知来访者需要先充分了解信息才能更好帮助到。
        
    *   在goals的actions中，也可以作为一个action，打开一个规则。有些时候主流程中根据来访者的某种情况，需要增加一些注意事项。
        

### 规则的运行

*   程序加载规则库时，可以识别出有存在重名的规则（重名加截失败）。
    
*   规则库的规则并不运行，只有通过open\_rule的规则才会启用。通过close\_rule可以显性的停用。
    
*   作用域：基于session, stage, goal，不同的作用域。进入作用域时，创建规则实例，放到规则监测列表中。open\_rule，离开作用域时，自动取消该规则实例 close\_rule。如果open\_rule时scope=global，代表了每个session都会加载。
    

### 规则脚本校验

*   规则重名检查与提示
    
*   规则条件中变量引用校验，只能是global变量或watch中get的变量
    
*   如果有写reply，代表是嵌入到ai\_ask的提示词的，因为check\_time应该是now
    
*   reply和call不共存（可以通过schema校验）
    

### 规则的优先级或冲突

有可能同时触发两个规则，如果都有同时调用的call，调用时机也是相同的，哪个优先调用，是否可能存在两个规则 本身的冲突。

## 技术设计

### 规则多次激活

*   一个rule可能在不同的脚本地方被激活，这时候基于作用域的退出会取消本作用域的rule，但有些全局rule也可以用。
    
*   因为这里可以用一种引用计数的方式来管理这种生命期。当出现添加相同的规则时，对这个规则增加引用计数。
    

### 规则的检测时机

*   now: 每次回应都需要检测，这个会放到每次回应的输出json中，增加一个字段
    
    ```JSON
    {
    "EXIT":"({%exit%}，EXIT设定为'true'代表结束本话题，否则设定为'false')",
    "{%ai_role%}":"(填写回应，去掉问候部分)",
    "BRIEF":"将回应精简到10字以内",
    "rule_识别自杀风险":"(当来访者提到有发生过自杀行为时, 或从自杀念头记录中判断自杀念头次数超过3次，设置为true，否则为false)"
    }
    ```
    
*   ask: 每次ai\_ask结束时，这会放到output时，增加一个字段
    

```JSON
基于原有信息列表和新对话过程进行重新梳理，存成JSON:###
{
"rule_识别自杀风险":"(当来访者提到有发生过自杀行为时, 或从自杀念头记录中判断自杀念头次数超过3次，设置为true，否则为false)",
}
###
```

*   topic\stage: 在话题，阶段，会谈结束时，增加一个think，不过可以考虑加一个线程，以免造成下延时
    

### 如果检测规则过多

*   now: 如果过多，会影响会GPT的输出。所以这边只取出最新加的N条now的规则去执行
    
*   ask： 如果过多，会影响会GPT的输出。所以这边只取出最新加的N条ask的规则去执行。其余加一个线程来处理think，每次think不超过M个
    
*   topic\stage直接用线程来处理
    

### 调用话题

如果话题不是立即执行，如果确保检查时的最近对话中有价值的信息在话题中使用。例如正在识别一个情景，新增一个挖掘这个情景自动思维的话题。但这个情景是什么，需要传递给调用的话题。

可能考虑自动增加一个“最新对话”的变量，把刚才聊天，判断出检发条件的聊天记录，保存下来，在话题执行时，可以先在话题内部去think，取出信息

### 直接回应

有时候需要直接检测到用户讲了什么信息时，立即给用户回应，但不跳出原来的ai\_ask。那可以考虑将这个回应作为提示词，自动加到ai\_ask当中。

### 结束规则

有些规则启用后，当满足一定条件，就需要取消。从脚本上，会在rule中配置cancel\_if，结束规则的检测时机与检查规则主条件的时机一致。实现方式一致。

### 监测信息

有时候规则条件需要对一些信息进行判断才触发，而这些信息的更新不可能写在主流程中通过think或ai\_ask的output去获取。监测信息一样涉及到在什么时候去更新。同样也是有now, ask, goal, stage, session这些节点。

如果是在now和ask，都可以直接在输出时，输出提取的信息。其它的可以独立线程来进行think。

# 话题管理需求

## 概念：

话题是围绕达成一个最小谈会目标进行的多次双方对话。最小会谈目标，例如：收集对方的基本信息、了解来访者的社会关系网、向来访者介绍CBT的设置等。

## 话题管理行为

1、**话题主流程**，也就是根据预定的模板，动态创建了一个话题队列。这个队列将被顺序执行。

2、**话题激活**，代表从话题队列中取出最上面一个话题，开始执行该话题。

3、**临时话题**，分析用户讲述情况或根据用户要求，临时需要安排进行沟通的话题。

1）临时话题的创建：

临时话题都是根据对当前话题的分析判断后，确认需要创建哪个话题脚本（预置的）

2）临时话题的执行时间：

临时话题将根据一些策略和要求，被插入到话题队列中。这些策略要把这个临时话题插入到，话题对队的哪个位置，一般有这么几个可插入的位置：

1.  如果有当前未结束话题，插入到当前未结束话题之后，对于一些紧急的，会直接把当前未结束讲题
    
2.  如果当前有未结束话题，冻结当前话题，立即开启新话题
    
3.  插入到特定话题之前，或之后
    
4.  插入到本次会谈的某个阶段结束时
    

4、**循环同类话题。**有时候需要根据前面收集到的信息列表，逐个进行相应的话题。例如，话题模板名叫“了解与周边对象的关系”，那么前面的话题为“了解成长中有哪些重要的人”，假如得到了\[“父亲”,”母亲”，”姐姐”\]。那么由于列表有个人，将会插入3个话题，例如：“了解与周边对象的关系-父亲”，“了解与周边对象的关系-母亲”，“了解与周边对象的关系-姐姐”。

5、**话题深度和延展控制**。有些话题有相应的快速版、标准版、详细版。这些版本可以脚本预设好。只是根据当前情况决定用哪个版本，例如总时间来不及了，可以将一些话题切换成快速版，如果判断这个信息很重要，可以展开详细版。

6、**设置话题权重**。每个话题都会被分配一个权重。对话列表是按话题权重来排序的。在一些时间限制下，必须去掉权重低的话题。这个话题权重可以从日常用户数据来分配。话题权重可以根据一些策略，进行动态的调整，一旦调整，会重新排序话题队列。

7**、取消话题。**根据当前情况决定某个话题。例如得知来访者某个亲人已经离开了，那么取消队列中，所有与该亲人相关的话题。

8、**话题时间控制。**每个话题都有一个预设的时间，每个Action都会有一个预估时间。话题的预估时间相当于action的预估时间之和。如果话题超出预计时间，有些追问会被允许加入尽量结束的提示。提示一方面会直接给来访者讲“时间原因，咱们这环节要加点速度”。时间太紧，也会先把一些不重要的话题启用快速版，或直接取消。

**9、话题推理：**通过对之前的对话内容和用户信息进行推理，动态地决定接下来应该探讨哪些话题，以及这些话题的深度和延展，以更好地满足用户的需求和期望。

# 自动变量实现机制

## WHY

**问题一：准备要问的信息，用户已经在前面对话中讲过了。**一个ai\_ask要获取的信息，有可能之前聊天用户已经有讲述过了，因此不要重复询问，或着可以接着之前的信息深入问。但由于ai\_ask只带入有限最新对话记录（不超过1000个字，具体根据程序设定），因此在最新对话记录之外的信息，此时ai\_ask就会从头问起。

**例如：**

```yaml
心谷向导：你遇到了什么困扰
心旅者：我最近很容易烦躁，那天莫名其妙和我最好的朋友阿东吵架了
。。。（超过一定字数）。。。
心谷向导：接下来，我需要了解一些你与朋友的关系
心旅者：没问题
心谷向导：你除了和阿乐吵架，与其他朋友关系如何？
```

**问题二：已经收集的信息，用户在后面更新了。**一个ai\_ask收集了信息，但后面用户更新了这个信息，这时需要自动把这个信息更新到变量中。

**例如：**

```yaml
心谷向导：你有几个兄弟姐妹
心旅者：有一个姐姐
。。。（已经将有一个姐姐get到“家庭成员情况”中）。。。
。。。。（会谈继续进行一段时间）。。。
心旅者：刚说得不准确，我算是有两个姐姐，大的是我母亲养大的，从小也住一块的。
。。。（此时需要更新“家庭成员情况”）。。。。
。。。。（会谈继续进行一段时间）。。。
心谷向导：接下来我想了解一下你与家庭每个人的关系
心谷向导：你与你大姐和二姐关系如何
。。。（此时提示词用到的{家庭成员情况}有包括两个姐姐）。。。
```

## HOW

### 实现思路：

*   在global\session\stage\goal的declare中声明的变量，可以设置“auto=true”（见“[如何定义变量](https://z0liv14zy5d.feishu.cn/docx/B2gadx3cPoNNezx1O3tc7l9Wnpd#part-CLR4dpbmfoQfWxxlISYcmbp0nLe)”），则系统在一些时间点上，自动去从之前一段聊天记录里，更新这些变量。
    
*   session定义的变量，一旦设置自动更新，则在整个会谈过程中都会收集或更新这个变量。
    
*   为了防止变量太多，影响更新性能和成本，系统自动会在最后一次用到这个变量之后，就不再更新这个变量。
    

### 技术问题与方案

1.  变量都需要自动更新吗？
    

并不是所有变量都需要自动更新的

*   哪些变更不需要自动更新？
    
    *   大多过程控制变量，如果“是否要询问XXX”，这种往往是基于最近对话或一些信息，通过think或直接在ai\_ask中判断赋值。在后面主要用于condition。这种大多不需要从头跟到尾。
        
    *   一些比较细节的信息，通过一些技术来进行识别的，由AI从用户对话中去概念化的，这些信息往往用户不会再讲述到，不太需要更新。
        
*   哪些变量需要自动更新：
    
    *   来访者的基本信息（年龄，学历），亲朋关系，忌讳或敏感的话题等，心理问题情况
        

1.  怎么设定哪些变量要自动更新？
    
    由脚本编写者来决定，通过session, stage, goal的declare定义的变量，加一个属性"autoUpdate"，可以取值"open, close, pause"。
    
2.  如何确保变量在被下次使用前被正确更新？
    
    1.  更新点与变更通过get进行更新的最近对话记录是衔接的。
        
        1.  在上一个ai\_ask就一开始把下一个ai\_ask要收集的信息进行output，以便在主线程上衔接。特别不会出现刚讲完的信息，马上又问。这样是最让人觉得笨的。
            
3.  如何更新对象列表？
    
      考虑直接将对象列表的定义在提示词中展开
    
      **提示词：**
    
    ```yaml
    你是一名心理咨询师，要从对话中收集下面的关键信息，每个信息都存放在变量中。请逐一检查每个变量，在“最近对话”中是否有存在信息的增量，如果有则将信息增量更新到当前变量值中。
    
    原有变量值：###
    {
    "家庭关系成员列表":[{"角色":"母亲","称呼":""},],
    "心理问题情境":"["问题名称":"对不喜欢的人无法专注","情景":"上课遇到不喜欢的老师","情绪":"觉得很烦","行为":"无法专注听，偷偷看小说"}，
    }
    ###
    
    最近对话：###
    咨询师：你小时个和谁一起
    来访者：我小时候除了我妈外，我舅也很长一段时间住在一块。
    咨询师：能说说你舅吗
    来访者：我不是很喜欢他，我觉得他总是什么事都不做还对我呼来唤去。我要是不听我舅的话，阿惠就会骂我。阿惠是我妈。
    ###
    
    逐一根据最近对话更新下面变量，并输出成JSON格式：
    {
    "家庭关系成员列表":[{"角色":"(提取有一起生活的家庭成员的角色"，"称呼":"(包括来访者对该成员的称呼)"},]"，
    "心理问题情境列表":[{"问题名称":"{为心理问题给一个简称，如果已经给过则作为该问题唯一标识}","情景":"(提取遇到了什么具体情景 )","情绪":"提取遇到该情景遇到产生什么情绪反应"},"行为":"提取来访者在该情景和情绪下会进行会么行为"},],
    }
    ```
    
      **GPT输出**
    
    ```yaml
    {
    "家庭关系成员列表":[{"角色":"母亲","称呼":"阿惠"},{"角色":"舅舅","称呼":""}],
    "心理问题情境列表":[{"问题名称":"对不喜欢的人无法专注","情景":"上课遇到不喜欢的老师","情绪":"觉得很烦","行为":"无法专注听，偷偷看小说"},{"问题名称":"对舅舅的反感","情景":"舅舅什么事都不做还对他呼来唤去","情绪":"反感","行为":"不听从舅舅的话"}]
    }
    ```
    
4.  如何减少更新的性能影响？
    
    1.  一次性批量更新多个变量，相对单个变量更新可减少GPT调用次数
        
        1.  GPT一次调用的上下文有限，变量若多了，怎么对变量进行分批？
            
            1.  直接设置一个批最大的变量数。
                
            2.  如何确定这个最大批量？ 调试GPT的能力，看多少聊天记录，提炼多少个变量，可以输出比较稳定
                
    2.  独立变更线程，减少对主线程影响
        
        1.  如何处理好多线程对变量的读写安全？
            
    3.  积累一定的对话量再更新，可以减少频率调用GPT带来的开销
        
5.  如何减少更新的token开销？
    
    1.  只在变量的作用域范围对该变量进行更新。
        
        1.  在进入一个session,stage,goal时，将需要自动更新的变量（autoUpdate=true）加入到一个“varUpdateList”中。
            
    2.  如果会谈中，该变量没有再被用到，就不再需要更新该变量。
        
        1.  变量池，每个变量中一个属性“UserGoal lastUseGoal”，这样只需要在退出这个lastUseGoal，就可以将变量从varUpdateList去掉。
            
        2.  如果新加的临时话题，再次用到这个变量怎么办？
            
            1.  加入临时话题时，提取话题涉及的变量，从对应的goal, stage, session的declare的变量，看是否有autoUpdate=true，但不在varUpdateList中的，再加进去。然后再设定该变量的lastUseGoal
                
    3.  可以考虑基于从聊天记录抽取的brief来作为“最近对话内容”。brief相对原始对话文字量是精减的。
        
        1.  如何确保brief没有减掉需要的信息量？
            

# 支线流程跳转

在大多的咨询中，存在主流程和支线流程。可以用GOTO实现支线流程的跳转。

在一个session中，有多个stage，有一些stage可以标为主线流程，有一些可以标为支线。这些支线流程可以通过goto跳转过去。

## 支线流程和简单的行为条件有什么区别？

简单的行为条件主体流程还是比较一致，不需要做分支。当进行的action变化很大时，可以考虑用分支。一个stage代表了一个分支。也就是如果多个action都用了相同的condition，实际上就可以考虑是一个分支。

## 分支结束后转向哪些

### 转回原来位置

有时候，分支只是额外跳出去，最终还是回到原来的stage，继续执行下去

### 转到主线下一个stage

跳转到分支后，原有stage不再执行，在分支进行完，跳回到原来stage的下一个stage

### 转到主线指定的stage

跳转到分支后，分支执行完，可以跳到主线任意一个stage前后。

### 如果跳到之前的stage，可能出循环，退不出分支。

需要脚本编写者，不再进入分支的条件，甚至可以设定分支进入的次数

## 分支内是否可以跳分支

可以，但必须在主线程

# 待思考需求

## 如果主流程结束，是否可以继续聊天？如果继续聊天，怎么继续？

## 自动生成session计划

## 关于知识库的需求

可以通过提供知识文件，当知识文件中有讲到的内容，可以让AI直接回答给用户，而不是从大模型的预训练数据中胡说八道。

如果知识库中没有对应的数据，例如客户问楼房的挑高多少，如果知识库中没有，当前GPT会直接生成一个挑高数据给到客户。但这个挑高数据是无根据的。
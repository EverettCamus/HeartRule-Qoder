# 脚本调试需求

# 快照功能

## 需求背景

在会谈脚本开发和调试的过程中，开发人员经常面临因脚本错误或需求变更而需要频繁修改和调试代码的问题。这一过程中，每当脚本发生变化，目前的做法是重新上传并从头开始测试整个脚本，这不仅效率低下，而且时间消耗巨大。针对此问题，出现了两个具体的场景需求：

第一种场景是，如果发现问题仅在特定的action或其后续脚本中，那么在修正后，希望能够从该问题action处继续调试，而不是重新开始整个会谈脚本。

第二种场景是，在修正了问题action之前的其他脚本后，也希望能够从更早的位置开始调试，而不必重走已经确认无误的部分。

第三种场景是，跨天调试时，由于不能从上一次执行的位置继续，每次都需要重新启动调试过程，这同样造成了时间和资源的浪费。

### 反复调试ai\_ask提示词

**情景：**

ai\_ask提示词的优化是脚本工作的最重要环节和最高频的环节，重新启动到还原测试前置环境的时间很长，导致高度的效率低下。 **原有流程：**

1.  将要测试的脚本copy到脚本最前面，并通过user\_say、say添加最近对话、能通ai\_think设置变量值，模拟前置环境
    
2.  启动服务，上传脚本
    
3.  调试
    
4.  发现问题
    
5.  在vscode的yaml文件中修改提示词
    
6.  上传脚本文件
    
7.  再次调试
    
8.  将测试好的脚本从前面copy回到会谈脚本位置
    

其中4-7是一个需要多次重复的过程。因此，是否有一个方法，可以快速修改ai\_ask的提示词，回到ai\_ask前一个执行环境，直接重新调试。

**功能需求：**

为了解决这一问题，我们需要一个在web界面上即时修改ai\_ask提示词的功能，并能够在修改后直接从上一个action重新开始调试的机制。这样，在发现问题并修改提示词后，可以无需重新上传整个脚本，直接在界面上点击“重运行当前action”进行调试。调试满意后，只需要将调试好的内容更新回原yaml文件即可。这大大缩短了调试周期，提高了开发效率。具体操作流程如下：

1.  启动服务，上传脚本
    
2.  运行到要调试的ai\_ask位置，调试
    
3.  发现问题
    
4.  直接web上修改当前action的内容
    
5.  点“重运行当前action”
    
6.  再次调试
    
7.  将调试好的action内容copy回yaml文件
    

其中3-6是一个需要多次重复的过程。7则只需在对修改后的提示词满意后进行。

### 从上次位置开始测试

**情景：**

对于长会谈脚本的调试，需要一个能够记忆上次执行位置的机制，以便可以直接从上次停止的位置继续调试。这意味着，无需每次都重新跑过之前已经测试过的会谈过程，能够大幅度提高调试的效率。

**原有流程：**

1.  注释掉之前测试过的脚本，通过user\_say、say添加最近对话、能通ai\_think设置变量值，模拟前置环境运行（如果没有做这个，需要从头开始运行到要调试位置）
    
2.  启动服务，上传脚本
    
3.  进行调试
    

**功能需求**

提供一个选择和还原快照的功能，让用户在启动服务并上传脚本后，能够选定一个之前的快照点，并从该快照点对应的action直接开始调试，而无需重新模拟前置环境。

1.  启动服务，上传脚本
    
2.  选择要调试的快照
    
3.  自动定位到当前脚本对应的action，开始调试
    
    ## 解决方案
    
    为了满足以上需求，我们将实施以下解决方案
    
    ### 保存快照，
    
    提供一个快照功能，也就是可以把当前的现场信息都保存成快照信息，以便可以下次还原整个环境，让脚本可以从快照的位置继续。两种保存方式：
    
    1.  自动保存，即在每次准备开始执行一个action前，将当前的环境快照保存起来。可先保存在内存，在一个goal之后持久化。自动保存的快照只会有一份，后面的快照会覆盖前面的快照，不管在内存还是磁盘。
        
    2.  手动保存，由调试客户端发起（点生成快照），生成的快照会持久化，可以在服务端重启后还能查询加载。
        
        ### 快照信息，
        
        指任何在还原快照时的运行环境，可以继续平顺运行的信息：
        
    3.  快照名：\[来访者名\]-\[session名\]-\[stage名\]-\[goal名\]-\[时间\]。
        
           例：小强-评估性会谈-中间环节-主诉拓展-2310160818
        
    4.  快照时间：记当快照保存时最后一个action的时间
        
    5.  当前的用户id\咨询师id
        
    6.  当天的聊天历史
        
    7.  当天的聊天历史摘要
        
    8.  全局环境变量、当前session、当前stage、当前goal的变量
        
    9.  forms（咨询师笔记，用户作业进度等）
        
    10.  session\stage\goal名称
        
    11.  当前的action类型和内容
        
        ### 还原快照
        
    12.  重新加载最新修改的脚本。
        
    13.  选择要还原的快照
        
    14.  读取快照信息
        
    15.  将快照信息写入当前环境中
        
    16.  当前的goal和action定位过去
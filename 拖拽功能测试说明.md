# 跨层级拖拽追加功能 - 测试说明

## 功能概述

现在支持三种拖拽方式：

### 1. 同级拖拽排序（原有功能）

- **Phase → Phase**：拖拽 Phase header 到另一个 Phase header，实现 Phase 之间的排序
- **Topic → Topic**：拖拽 Topic header 到另一个 Topic header，实现 Topic 之间的排序
- **Action → Action**：拖拽 Action 卡片到另一个 Action 卡片，实现 Action 之间的排序

### 2. 跨层级追加（新功能）✨

- **Topic → Phase**：拖拽 Topic 到 Phase 的内容区域（非 header），自动追加到该 Phase 的最后一个 Topic
- **Action → Topic**：拖拽 Action 到 Topic 的内容区域（非 Action 卡片），自动追加到该 Topic 的最后一个 Action

### 3. 自动滚动支持

- 拖拽时鼠标接近屏幕上下边缘会自动滚动列表
- 支持所有拖拽场景

## 测试步骤

### 测试准备

1. 启动 API 服务器（如果尚未启动）：

   ```powershell
   cd packages/api-server
   pnpm run dev
   ```

2. 启动前端开发服务器（如果尚未启动）：

   ```powershell
   cd packages/script-editor
   pnpm run dev
   ```

3. 打开浏览器访问：`http://localhost:3001`（或显示的端口）

4. 选择一个已有的工程进入编辑器

### 测试场景 1：Topic 跨 Phase 追加

**目标**：将 Phase A 中的某个 Topic 拖到 Phase B，该 Topic 应该追加到 Phase B 的最后

**步骤**：

1. 确保至少有 2 个 Phase，每个 Phase 至少有 1 个 Topic
2. 点击展开 Phase A 和 Phase B
3. 鼠标按住 Phase A 中某个 Topic 的 header（显示名称的区域）
4. **拖到 Phase B 的空白内容区域**（不是 Topic header，而是 Phase 展开后的灰色背景区域）
5. 松开鼠标

**预期结果**：

- 该 Topic 从 Phase A 中消失
- 该 Topic 出现在 Phase B 的最后一个位置

### 测试场景 2：Action 跨 Topic 追加

**目标**：将 Topic A 中的某个 Action 拖到 Topic B，该 Action 应该追加到 Topic B 的最后

**步骤**：

1. 确保至少有 2 个 Topic，每个 Topic 至少有 1 个 Action
2. 点击展开 Topic A 和 Topic B
3. 鼠标按住 Topic A 中某个 Action 卡片
4. **拖到 Topic B 的空白内容区域**（不是 Action 卡片，而是 Topic 展开后的空白区域）
5. 松开鼠标

**预期结果**：

- 该 Action 从 Topic A 中消失
- 该 Action 出现在 Topic B 的最后一个位置

### 测试场景 3：同级拖拽仍然工作

**目标**：验证原有的同级排序功能没有受影响

**步骤**：

1. 拖拽一个 Topic header 到另一个 Topic header
2. 拖拽一个 Action 卡片到另一个 Action 卡片

**预期结果**：

- 拖拽到目标位置，原有的插入排序逻辑仍然生效
- 不是追加到末尾，而是插入到目标项的位置

### 测试场景 4：自动滚动

**目标**：验证拖拽时自动滚动功能

**步骤**：

1. 创建足够多的 Phase/Topic/Action，使列表超出屏幕高度
2. 拖拽任意节点，并将鼠标移动到屏幕顶部或底部边缘（约 80px 范围内）

**预期结果**：

- 列表自动向上或向下滚动
- 松开鼠标或移出边缘区域时停止滚动

## 常见问题

### Q1: 拖拽时鼠标显示"禁止"图标

**原因**：可能拖到了不支持该类型的区域
**解决**：

- Topic 只能拖到 Phase 内容区或其他 Topic header
- Action 只能拖到 Topic 内容区或其他 Action 卡片

### Q2: 拖拽后位置不对

**检查**：

- 确认是拖到"容器空白区"（追加）还是"具体节点"（插入）
- 容器空白区 = 追加到末尾
- 具体节点 = 插入到该节点位置

### Q3: 跨层级拖拽没反应

**检查**：

1. 确保后端支持跨层级移动（`onMoveTopic` 和 `onMoveAction` 回调已实现）
2. 查看浏览器控制台是否有错误
3. 确认拖拽时鼠标显示"移动"图标而非"禁止"图标

## 技术实现说明

### 拖拽区域划分

- **Phase header**：仅支持 Phase 同级排序
- **Phase 内容区（Collapse 容器）**：支持 Topic 追加到 Phase
- **Topic header**：仅支持 Topic 同级排序
- **Topic 内容区（actions-container）**：支持 Action 追加到 Topic
- **Action 卡片**：仅支持 Action 同级排序

### 追加逻辑

- Topic 追加：`targetTopicIndex = phase.topics.length`
- Action 追加：`targetActionIndex = topic.actions.length`

### 兼容性

- 保留原有同级拖拽排序功能
- 新增跨层级追加功能
- 两种模式通过 drop 目标元素类型自动判断

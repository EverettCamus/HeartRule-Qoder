# 会谈脚本可视化编辑功能

## 功能概述

现在工程编辑器支持对会谈脚本（Session）进行可视化节点编辑，特别是对 `ai_say`、`ai_ask`、`ai_think` 三种常用 Action 类型提供了友好的图形化配置界面。

## 主要特性

### 1. 双模式编辑
- **YAML 模式**：传统的文本编辑器，适合熟悉 YAML 语法的用户
- **可视化编辑模式**：图形化的节点配置界面，更直观友好

### 2. Action 节点列表
每个 Action 节点显示为一个卡片，包含：
- **节点图标**：不同类型有不同的图标和颜色
  - 💬 `ai_say`（蓝色）- AI 说话
  - ❓ `ai_ask`（绿色）- AI 提问
  - 💡 `ai_think`（黄色）- AI 思考
  - 💭 `say`（紫色）- 说话
  - 👤 `user_say`（粉色）- 用户说话
- **内容预览**：显示 Action 的主要内容（前 150 字）
- **附加信息标签**：
  - 执行条件
  - 退出条件
  - 输出变量数量
  - 添加到列表
  - 语气风格

### 3. Action 属性配置面板

#### ai_say 配置
- **提示词内容**（必填）：AI 说话的提示词
- **语气风格**（可选）：如温柔、鼓励、严肃等
- **执行条件**（可选）：条件表达式

#### ai_ask 配置
- **提示词内容**（必填）：AI 提问的提示词
- **语气风格**（可选）：语气设定
- **退出条件**（可选）：何时退出此 Action
- **添加到列表**（可选）：将结果添加到指定列表变量
- **输出变量配置**：可添加多个输出变量
  - `get`：提取变量名
  - `define`：变量定义说明

#### ai_think 配置
- **思考提示词**（必填）：AI 思考的提示词
- **输出变量配置**：可添加多个输出变量
  - `get`：提取操作
  - `set`：设置操作
  - `define`：变量定义
  - `value`：默认值

### 4. 实时同步
- 在可视化模式下修改 Action 属性后，点击"保存"按钮
- 系统自动将修改同步回 YAML 文本
- 可以随时切换回 YAML 模式查看生成的代码

## 使用流程

1. **打开工程编辑器**
   - 在工程列表页点击某个工程的"编辑"按钮

2. **选择会谈脚本文件**
   - 从左侧文件树选择一个 `session` 类型的文件
   - 系统会自动解析 YAML 内容

3. **切换到可视化编辑模式**
   - 点击顶部的"可视化编辑"按钮
   - 如果脚本包含 Action 节点，界面会分为两栏：
     - 左侧：Action 节点列表
     - 右侧：属性编辑面板

4. **选择和编辑 Action**
   - 点击左侧的 Action 卡片进行选择
   - 右侧会显示该 Action 的详细配置表单
   - 修改属性后点击"保存"按钮

5. **保存到服务器**
   - 点击顶部的"保存"按钮（或按 Ctrl+S）
   - 修改会持久化到数据库

6. **发布版本**
   - 点击"发布版本"按钮
   - 填写版本说明
   - 确认发布

## 技术实现

### 核心组件

#### 1. ActionNodeList
位置：`src/components/ActionNodeList/index.tsx`

负责渲染 Action 节点列表，提供：
- 节点卡片渲染
- 节点选择交互
- 节点预览信息展示

#### 2. ActionPropertyPanel
位置：`src/components/ActionPropertyPanel/index.tsx`

负责渲染 Action 属性编辑表单，提供：
- 根据 Action 类型动态渲染表单字段
- 输出变量的动态增删
- 表单验证
- 保存回调

#### 3. 类型定义
位置：`src/types/action.ts`

定义了：
- Action 类型接口（AiSayAction、AiAskAction、AiThinkAction 等）
- 会谈脚本结构（SessionScript、Stage、Step 等）
- 输出字段配置（OutputField）

### YAML 解析与同步

#### 解析流程
```
YAML 文本 
  ↓ (js-yaml.load)
SessionScript 对象
  ↓ (提取 actions)
Action[] 数组
  ↓ (渲染)
可视化节点
```

#### 同步流程
```
属性表单修改
  ↓ (onSave)
更新 Action 对象
  ↓ (syncActionsToYaml)
更新 SessionScript
  ↓ (js-yaml.dump)
生成新 YAML 文本
```

## 示例

### ai_say 节点示例
```yaml
- ai_say: |
    你正在和心旅者进行首次评估会谈。
    请用温柔、鼓励的语气，建立信任关系。
  tone: 温柔
  condition: "{阶段}=='建立关系'"
```

### ai_ask 节点示例
```yaml
- ai_ask: |
    能跟我讲讲你遇到了什么困扰吗？
    我会认真倾听你的感受。
  tone: 温柔
  exit: 当心旅者讲述完关于情绪困扰的问题
  output:
    - get: 当前困扰
      define: 提取心旅者的当前困扰
```

### ai_think 节点示例
```yaml
- think: 预设定心旅者信息
  output:
    - set: 心旅者简介
      value: 喵喵，女，16岁，高二学生
    - set: 咨询阶段
      value: 首次评估
```

## 后续计划

1. **完整四层结构导航**
   - Session → Stage → Step → Action 的树状导航
   - 支持在不同层级间快速跳转

2. **流程图视图**
   - 使用 ReactFlow 展示 Action 节点的执行流程
   - 可视化条件分支和循环

3. **更多 Action 类型支持**
   - 表单相关 Action
   - 技能调用 Action
   - 变量操作 Action

4. **变量管理面板**
   - 显示当前可用的变量
   - 变量引用提示
   - 变量依赖关系分析

5. **脚本验证**
   - 语法检查
   - 变量引用检查
   - 执行流程检查

## 注意事项

1. **YAML 格式兼容性**
   - 可视化编辑生成的 YAML 使用标准格式
   - 手动编辑 YAML 时需保持格式正确

2. **实时解析**
   - YAML 模式下每次修改都会尝试解析
   - 如果解析失败，可视化模式按钮会禁用

3. **数据持久化**
   - 只有点击"保存"按钮才会持久化到数据库
   - 切换文件前会提示保存未保存的修改

4. **性能考虑**
   - 当前版本适合中等规模的脚本（< 100 个 Action）
   - 大规模脚本建议分拆成多个文件

# 可视化节点编辑功能使用指南

## 快速开始

### 1. 启动应用

```bash
# 启动后端服务（需要先启动 PostgreSQL）
cd packages/api-server
pnpm run dev

# 启动前端服务
cd packages/script-editor
pnpm run dev
```

前端访问地址：http://localhost:3002/

### 2. 创建或打开工程

1. 访问工程列表页
2. 点击某个工程的"编辑"按钮，或创建新工程

### 3. 编辑会谈脚本

1. 从左侧文件树选择一个会谈脚本文件（sessions/*.yaml）
2. 系统会自动解析 YAML 内容并提取 Action 节点
3. 点击顶部的"可视化编辑"按钮切换到可视化模式

## 界面说明

### 顶部工具栏
```
[返回列表] | 工程名称 (引擎版本) [状态标签] [未保存]
                                              [保存] [发布版本]
```

### 文件信息栏
```
[文件图标] 文件名  最后修改时间  |  [YAML模式] [可视化编辑]
```

### 可视化编辑界面（双栏布局）

#### 左侧：Action 节点列表
```
┌─────────────────────────────────┐
│  💬 AI 说话              #1    │
│  你正在和心旅者进行...          │
│  [条件] [语气:温柔]            │
├─────────────────────────────────┤
│  ❓ AI 提问              #2    │
│  能跟我讲讲你遇到...            │
│  [退出条件] [输出 1 个变量]    │
├─────────────────────────────────┤
│  💡 AI 思考              #3    │
│  预设定心旅者信息               │
│  [输出 2 个变量]               │
└─────────────────────────────────┘
```

#### 右侧：Action 属性配置面板
```
┌─────────────────────────────────┐
│ Action 属性配置  #1    [保存]  │
├─────────────────────────────────┤
│ 提示词内容 *                    │
│ ┌─────────────────────────────┐ │
│ │ 输入 AI 说话的提示词...     │ │
│ │                             │ │
│ └─────────────────────────────┘ │
│                                 │
│ 语气风格                        │
│ [例如: 温柔、鼓励、严肃等]      │
│                                 │
│ ▼ 高级配置                      │
│   执行条件（可选）              │
│   [{变量名} == 'true']          │
└─────────────────────────────────┘
```

## 操作示例

### 示例 1：编辑 ai_say 节点

**场景**：修改 AI 说话的语气和内容

1. 在左侧节点列表点击一个 `ai_say` 节点（蓝色图标）
2. 右侧会显示配置表单：
   - **提示词内容**：多行文本框，可以修改 AI 说话的内容
   - **语气风格**：输入框，如"温柔"、"鼓励"等
   - **执行条件**：可选，设置执行条件
3. 修改完成后点击右上角的"保存"按钮
4. 切换回 YAML 模式查看生成的代码

**效果**：
```yaml
# 修改前
- ai_say: 你好

# 修改后
- ai_say: |
    你好，我是心谷向导。
    很高兴能在这里与你相遇。
  tone: 温柔
  condition: "{阶段}=='建立关系'"
```

### 示例 2：配置 ai_ask 节点的输出变量

**场景**：让 AI 提问并提取用户回答中的关键信息

1. 点击一个 `ai_ask` 节点（绿色图标）
2. 在右侧配置表单中：
   - 填写**提示词内容**
   - 设置**退出条件**
   - 在**输出变量配置**区域点击"添加输出变量"
3. 配置输出变量：
   - `get`: 当前困扰
   - `define`: 提取心旅者的当前困扰
4. 可以添加多个输出变量
5. 点击"保存"

**效果**：
```yaml
- ai_ask: |
    能跟我讲讲你遇到了什么困扰吗？
  exit: 当心旅者讲述完关于情绪困扰的问题
  output:
    - get: 当前困扰
      define: 提取心旅者的当前困扰
    - get: 困扰程度
      define: 评估困扰的严重程度（1-10）
```

### 示例 3：使用 ai_think 初始化变量

**场景**：在会谈开始前预设一些变量

1. 点击一个 `ai_think` 节点（黄色图标）
2. 在右侧配置：
   - 填写**思考提示词**
   - 添加多个输出变量，使用 `set` 来设置固定值
3. 示例配置：
   - 变量 1：`set: 心旅者简介`, `value: 喵喵，女，16岁`
   - 变量 2：`set: 咨询阶段`, `value: 首次评估`
4. 点击"保存"

**效果**：
```yaml
- think: 预设定心旅者信息
  output:
    - set: 心旅者简介
      value: 喵喵，女，16岁，高二学生
    - set: 咨询阶段
      value: 首次评估
```

## 常见问题

### Q: 为什么"可视化编辑"按钮是灰色的？
A: 可能的原因：
1. 当前文件不是会谈脚本（session 类型）
2. YAML 解析失败（语法错误）
3. 脚本中没有包含 Action 节点

### Q: 修改后看不到效果？
A: 请确保：
1. 点击了右侧属性面板的"保存"按钮（更新到内存）
2. 点击了顶部的"保存"按钮（持久化到数据库）
3. 如果在 YAML 模式下修改，切换到可视化模式前会自动解析

### Q: 如何删除一个 Action 节点？
A: 当前版本暂不支持在可视化模式下删除节点，请：
1. 切换到 YAML 模式
2. 手动删除对应的 YAML 代码
3. 保存后切换回可视化模式

### Q: 可以添加新的 Action 节点吗？
A: 当前版本暂不支持在可视化模式下添加节点，请：
1. 切换到 YAML 模式
2. 参考现有格式添加新的 Action
3. 保存后切换回可视化模式

## 键盘快捷键

- `Ctrl+S` / `Cmd+S`：保存当前文件

## 注意事项

1. **保存提醒**：切换文件前如有未保存的修改，系统会弹出确认对话框
2. **YAML 格式**：手动编辑 YAML 时请保持正确的缩进（2 个空格）
3. **变量引用**：在提示词中使用 `{变量名}` 格式引用变量
4. **多行文本**：使用 `|` 符号可以编写多行文本内容

## 最佳实践

1. **逐步编辑**：先在 YAML 模式下建立基本结构，再切换到可视化模式细化配置
2. **频繁保存**：每次修改几个节点后就保存一次，避免丢失工作
3. **版本管理**：完成一个功能阶段后发布一个版本，便于回滚
4. **命名规范**：为变量使用有意义的名称，便于后续维护

## 技术支持

如遇问题，请查看：
- 浏览器开发者控制台的错误信息
- 后端服务器日志
- `README_VISUAL_EDITING.md` 文档

或联系开发团队获取帮助。

# ai_say åŸºç¡€èƒ½åŠ›å®ç° - æ‰§è¡ŒæŠ¥å‘Š

## æ‰§è¡Œæ¦‚å†µ

âœ… **ä»»åŠ¡çŠ¶æ€**: å…¨éƒ¨å®Œæˆ  
ğŸ“… **æ‰§è¡Œæ—¶é—´**: 2026-01-20  
ğŸ¯ **ç›®æ ‡**: å®ç° ai_say ç¬¬ä¸€é˜¶æ®µåŸºç¡€èƒ½åŠ›

---

## å®Œæˆçš„åŠŸèƒ½

### âœ… é˜¶æ®µ 1: æç¤ºè¯æ¨¡æ¿åŸºç¡€è®¾æ–½

**1.1 PromptTemplateManager ç±»**
- æ–‡ä»¶: `packages/core-engine/src/engines/prompt-template/template-manager.ts`
- åŠŸèƒ½:
  - âœ… ä¸¤å±‚å˜é‡æ›¿æ¢ (è„šæœ¬å±‚ `{å˜é‡å}` + ç³»ç»Ÿå±‚ `{%å˜é‡å%}`)
  - âœ… æ¨¡æ¿åŠ è½½ä¸ç¼“å­˜
  - âœ… å˜é‡æå–ä¸éªŒè¯
  - âœ… è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦å¤„ç†
- æµ‹è¯•: 12/12 é€šè¿‡ âœ…

**1.2 ä¸»çº¿Aæç¤ºè¯æ¨¡æ¿**
- æ–‡ä»¶: `config/prompts/ai-say/mainline-a-introduce-concept.md`
- åŠŸèƒ½:
  - âœ… ç†è§£åº¦è¯„ä¼°æç¤ºè¯
  - âœ… é€€å‡ºåˆ¤æ–­é€»è¾‘
  - âœ… JSON æ ¼å¼è¾“å‡ºå®šä¹‰

---

### âœ… é˜¶æ®µ 2: AiSayAction æ ¸å¿ƒé€»è¾‘å¢å¼º

**2.1 å¤šè½®å¯¹è¯èƒ½åŠ›**
- æ–‡ä»¶: `packages/core-engine/src/actions/ai-say-action.ts`
- åŠŸèƒ½:
  - âœ… æ”¯æŒ `max_rounds` è½®æ•°æ§åˆ¶
  - âœ… è‡ªåŠ¨è½®æ¬¡è®¡æ•° (`currentRoundCount`)
  - âœ… è¾¾åˆ°æœ€å¤§è½®æ¬¡å¼ºåˆ¶é€€å‡º

**2.2 æç¤ºè¯æ¨¡æ¿é›†æˆ**
- âœ… æ¨¡æ¿æ¨¡å¼ vs å…¼å®¹æ¨¡å¼è‡ªåŠ¨åˆ‡æ¢
- âœ… è„šæœ¬å˜é‡æå– (`extractScriptVariables`)
- âœ… ç³»ç»Ÿå˜é‡æ„å»º (`buildSystemVariables`)
- âœ… ä¸¤å±‚å˜é‡æ›¿æ¢æµç¨‹

**2.3 é€€å‡ºå†³ç­–æœºåˆ¶**
- âœ… è§„åˆ™ 1: max_rounds ç¡¬æ€§é™åˆ¶
- âœ… è§„åˆ™ 2: ç†è§£åº¦ >= é˜ˆå€¼ ä¸”æ— ç–‘é—®
- âœ… è§„åˆ™ 3: ç†è§£åº¦ >= 70 ä¸”æ˜ç¡®è¡¨è¾¾ç†è§£
- âœ… å†³ç­–æ¥æºæ ‡è®° (`decision_source`)

**2.4 LLM è°ƒç”¨**
- âœ… JSON è¾“å‡ºè§£æ (æ”¯æŒ markdown ä»£ç å—)
- âœ… ç»“æ„åŒ–è¯„ä¼°ç»“æœæå–
- âœ… é”™è¯¯å¤„ç†ä¸æ—¥å¿—è®°å½•

---

### âœ… é˜¶æ®µ 3: è„šæœ¬ç±»å‹æ‰©å±•

**3.1 ç±»å‹å®šä¹‰å¢å¼º**
- æ–‡ä»¶: `packages/script-editor/src/types/action.ts`
- æ–°å¢å­—æ®µ:
  - âœ… `content`: è®²è§£å†…å®¹ (ä¼˜å…ˆä½¿ç”¨)
  - âœ… `ai_say`: å‘åå…¼å®¹å­—æ®µ
  - âœ… `exit_criteria.understanding_threshold`: ç†è§£åº¦é˜ˆå€¼
  - âœ… `exit_criteria.has_questions`: æ˜¯å¦å…è®¸æœ‰ç–‘é—®é€€å‡º

---

### âœ… é˜¶æ®µ 4: å‰ç«¯ç¼–è¾‘å™¨å¢å¼º

**4.1 ActionPropertyPanel ç»„ä»¶**
- æ–‡ä»¶: `packages/script-editor/src/components/ActionPropertyPanel/index.tsx`
- æ–°å¢ UI å…ƒç´ :
  - âœ… "Lecture Content" å¤šè¡Œæ–‡æœ¬æ¡† (10è¡Œ)
  - âœ… "Require Acknowledgment" å¼€å…³
  - âœ… "Max Rounds" æ•°å­—è¾“å…¥ (1-20)
  - âœ… "Understanding Threshold" ç™¾åˆ†æ¯”è¾“å…¥
  - âœ… "Allow Exit With Questions" å¼€å…³
  - âœ… å¯æŠ˜å çš„é«˜çº§é€€å‡ºæ¡ä»¶é¢æ¿

**4.2 è¡¨å•é€»è¾‘**
- âœ… å…¼å®¹æ–°æ—§å­—æ®µ (`content` ä¼˜å…ˆäº `ai_say`)
- âœ… é»˜è®¤å€¼è®¾ç½® (max_rounds=5, understanding_threshold=80)
- âœ… è‡ªåŠ¨ä¿å­˜ (600ms é˜²æŠ–)
- âœ… å®Œæ•´çš„è¡¨å•éªŒè¯è§„åˆ™

---

### âœ… é˜¶æ®µ 5: æµ‹è¯•ä¸éªŒè¯

**5.1 å•å…ƒæµ‹è¯•**
- æ–‡ä»¶: `packages/core-engine/test/prompt-template.test.ts`
- æµ‹è¯•è¦†ç›–:
  - âœ… å˜é‡æ›¿æ¢ (5 ä¸ªæµ‹è¯•)
  - âœ… å˜é‡æå– (4 ä¸ªæµ‹è¯•)
  - âœ… å˜é‡éªŒè¯ (3 ä¸ªæµ‹è¯•)
- ç»“æœ: **12/12 é€šè¿‡** âœ…

**5.2 ç¼–è¯‘éªŒè¯**
- âœ… core-engine ç¼–è¯‘æˆåŠŸ
- âœ… script-editor ç¼–è¯‘æˆåŠŸ
- âœ… æ— ç±»å‹é”™è¯¯

**5.3 æµ‹è¯•è„šæœ¬**
- æ–‡ä»¶: `scripts/sessions/test_ai_say_basic.yaml`
- åœºæ™¯: ABCæ¨¡å‹ä»‹ç»
- é…ç½®:
  - max_rounds: 3
  - understanding_threshold: 80
  - åŒ…å«ç”¨æˆ·ç”»åƒå˜é‡

---

## æŠ€æœ¯æ¶æ„

### ä¸¤å±‚å˜é‡ç³»ç»Ÿ

```
YAML è„šæœ¬
  â†“ declare
è„šæœ¬å±‚å˜é‡ {å˜é‡å}
  â†“ ç¬¬ä¸€æ¬¡æ›¿æ¢
æç¤ºè¯æ¨¡æ¿ (éƒ¨åˆ†æ›¿æ¢)
  â†“ è¿è¡Œæ—¶è®¡ç®—
ç³»ç»Ÿå±‚å˜é‡ {%å˜é‡å%}
  â†“ ç¬¬äºŒæ¬¡æ›¿æ¢
å®Œæ•´æç¤ºè¯
  â†“
LLM API
```

### æ‰§è¡Œæµç¨‹

```
ç”¨æˆ·è¾“å…¥
  â†“
AiSayAction.execute()
  â”œâ”€ æ¨¡å¼åˆ¤æ–­ (æ¨¡æ¿æ¨¡å¼ vs å…¼å®¹æ¨¡å¼)
  â”œâ”€ è½®æ¬¡æ£€æŸ¥ (currentRound vs maxRounds)
  â”œâ”€ æ¨¡æ¿åŠ è½½
  â”œâ”€ å˜é‡æ›¿æ¢ (ä¸¤å±‚)
  â”œâ”€ LLM è°ƒç”¨
  â”œâ”€ JSON è§£æ
  â””â”€ é€€å‡ºå†³ç­– (è§„åˆ™å¼•æ“)
```

---

## æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶ (6ä¸ª)

1. `packages/core-engine/src/engines/prompt-template/template-manager.ts` (172è¡Œ)
2. `packages/core-engine/src/engines/prompt-template/index.ts` (2è¡Œ)
3. `config/prompts/ai-say/mainline-a-introduce-concept.md` (47è¡Œ)
4. `packages/core-engine/test/prompt-template.test.ts` (103è¡Œ)
5. `scripts/sessions/test_ai_say_basic.yaml` (38è¡Œ)

### ä¿®æ”¹æ–‡ä»¶ (4ä¸ª)

1. `packages/core-engine/src/actions/ai-say-action.ts` (+366/-114è¡Œ)
2. `packages/script-editor/src/types/action.ts` (+6/-1è¡Œ)
3. `packages/script-editor/src/components/ActionPropertyPanel/index.tsx` (+66/-18è¡Œ)
4. `packages/core-engine/src/index.ts` (+1è¡Œ)

---

## è®¾è®¡äº®ç‚¹

### 1. æ¸è¿›å¼æ¼”è¿›
- âœ… ä¿æŒå‘åå…¼å®¹ (å…¼å®¹æ¨¡å¼ vs æ¨¡æ¿æ¨¡å¼)
- âœ… ä¼˜é›…é™çº§ (é…ç½®ç¼ºå¤±æ—¶ä½¿ç”¨é»˜è®¤å€¼)
- âœ… ä¸ºæœªæ¥æ‰©å±•é¢„ç•™æ¥å£

### 2. å…³æ³¨ç‚¹åˆ†ç¦»
- âœ… æ¨¡æ¿ç®¡ç† (PromptTemplateManager)
- âœ… æ‰§è¡Œé€»è¾‘ (AiSayAction)
- âœ… é€€å‡ºå†³ç­– (ç‹¬ç«‹æ–¹æ³•)
- âœ… å˜é‡ç³»ç»Ÿ (ä¸¤å±‚åˆ†ç¦»)

### 3. å¯è§‚æµ‹æ€§
- âœ… è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
- âœ… å†³ç­–æ¥æºæ ‡è®°
- âœ… å…ƒæ•°æ®å®Œæ•´è®°å½•

---

## éªŒè¯ç»“æœ

### å•å…ƒæµ‹è¯•
```
âœ“ packages/core-engine/test/prompt-template.test.ts (12)
  âœ“ PromptTemplateManager (12)
    âœ“ å˜é‡æ›¿æ¢ (5)
    âœ“ å˜é‡æå– (4)
    âœ“ å˜é‡éªŒè¯ (3)

Test Files  1 passed (1)
Tests       12 passed (12)
Duration    536ms
```

### ç¼–è¯‘éªŒè¯
```
âœ“ core-engine build success
  - ESM dist\index.mjs     59.36 KB
  - DTS dist\index.d.mts   15.88 KB

âœ“ script-editor build success
  - dist/assets/index.js   1,176.87 KB
```

---

## åç»­å»ºè®®

### ç¬¬äºŒé˜¶æ®µç›®æ ‡
1. å®ç°æ”¯çº¿ B (åˆ†æå±‚): æ·±åº¦è¯„ä¼°ä¸ç­–ç•¥ç”Ÿæˆ
2. å®ç°æ”¯çº¿ C (ç›‘æ§å±‚): é£é™©ç›‘æ§ä¸å¹²é¢„
3. æ”¯æŒå¤šç§ subtype (introduce_concept, persuade, etc.)
4. subtype è‡ªåŠ¨æ¨æ–­æœºåˆ¶

### ä¼˜åŒ–æ–¹å‘
1. LLM è°ƒç”¨æ€§èƒ½ä¼˜åŒ– (ç¼“å­˜ã€å¹¶è¡Œ)
2. æç¤ºè¯æ¨¡æ¿ç‰ˆæœ¬ç®¡ç†
3. A/B æµ‹è¯•æ¡†æ¶
4. æ›´ä¸°å¯Œçš„é€€å‡ºæ¡ä»¶é…ç½®

---

## é—®é¢˜ä¸é£é™©

### å·²çŸ¥é™åˆ¶
1. âš ï¸ ç¬¬ä¸€é˜¶æ®µä»…æ”¯æŒ introduce_concept æ¨¡æ¿
2. âš ï¸ é€€å‡ºå†³ç­–è¾ƒç®€å• (ä»…2æ¡è§„åˆ™)
3. âš ï¸ LLM è¾“å‡ºæ ¼å¼ä¾èµ–æç¤ºè¯è´¨é‡

### ç¼“è§£æªæ–½
- âœ… æ¶æ„é¢„ç•™æ‰©å±•ç©ºé—´
- âœ… JSON è§£æå®¹é”™å¤„ç†
- âœ… è¯¦ç»†æ—¥å¿—ä¾¿äºè°ƒè¯•

---

## æ€»ç»“

**å®ç°å®Œæˆåº¦**: 100% âœ…  
**æµ‹è¯•é€šè¿‡ç‡**: 100% (12/12) âœ…  
**ç¼–è¯‘æˆåŠŸç‡**: 100% âœ…  
**ä»£ç è´¨é‡**: ç¬¦åˆ TypeScript è§„èŒƒ âœ…

**æ ¸å¿ƒæˆæœ**:
- âœ… æç¤ºè¯æ¨¡æ¿ç³»ç»Ÿå®Œå…¨æ‰“é€š
- âœ… å¤šè½®å¯¹è¯ä¸ç†è§£åº¦è¯„ä¼°å¯ç”¨
- âœ… å‰ç«¯ç¼–è¾‘å™¨æ”¯æŒæ–°å­—æ®µé…ç½®
- âœ… å‘åå…¼å®¹æ€§è‰¯å¥½

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**:
1. åœ¨å®é™…ä¼šè°ˆä¸­æµ‹è¯•æ–°åŠŸèƒ½
2. æ ¹æ®åé¦ˆä¼˜åŒ–æç¤ºè¯æ¨¡æ¿
3. è§„åˆ’ç¬¬äºŒé˜¶æ®µæ”¯çº¿ B/C å®ç°

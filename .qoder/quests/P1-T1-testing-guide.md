# P1-T1 åŠŸèƒ½æµ‹è¯•æŒ‡å—

## ğŸš€ å¿«é€Ÿå¯åŠ¨

### 1. å¯åŠ¨æœåŠ¡

```powershell
# Terminal 1: å¯åŠ¨ API æœåŠ¡å™¨
cd c:\CBT\HeartRule-Qcoder
pnpm run dev

# Terminal 2: å¯åŠ¨ç¼–è¾‘å™¨å‰ç«¯
cd c:\CBT\HeartRule-Qcoder
pnpm run dev:editor
```

### 2. è®¿é—®åœ°å€

- **API Server**: http://localhost:8000
- **Script Editor**: http://localhost:3000
- **API Docs**: http://localhost:8000/docs

---

## ğŸ“‹ æµ‹è¯•åœºæ™¯

### åœºæ™¯ä¸€ï¼šæŸ¥çœ‹ç‰ˆæœ¬åˆ—è¡¨

#### æ­¥éª¤

1. åœ¨æµè§ˆå™¨æ‰“å¼€ http://localhost:3000
2. ç‚¹å‡»ä»»æ„å·¥ç¨‹å¡ç‰‡è¿›å…¥ç¼–è¾‘å™¨
3. ç‚¹å‡»é¡¶éƒ¨ Header çš„ **"ç‰ˆæœ¬ç®¡ç†"** æŒ‰é’®
4. å³ä¾§æ»‘å‡ºç‰ˆæœ¬ç®¡ç†é¢æ¿

#### é¢„æœŸç»“æœ

âœ… é¢æ¿æ˜¾ç¤ºä¸‰ä¸ªåŒºåŸŸï¼š
- **å½“å‰ç‰ˆæœ¬ä¿¡æ¯åŒº**ï¼ˆç»¿è‰²èƒŒæ™¯ï¼‰
- **å·¥ä½œåŒºè‰ç¨¿åŒº**ï¼ˆæ©™è‰²èƒŒæ™¯ï¼Œå¦‚æœæœ‰è‰ç¨¿ï¼‰
- **ç‰ˆæœ¬å†å²åˆ—è¡¨**ï¼ˆå¯æ»šåŠ¨ï¼‰

âœ… æ¯ä¸ªç‰ˆæœ¬æ˜¾ç¤ºï¼š
- ç‰ˆæœ¬å·ï¼ˆå¦‚ v1.0.0ï¼‰
- å‘å¸ƒæ—¶é—´
- å‘å¸ƒäºº
- å‘å¸ƒè¯´æ˜
- å½“å‰ç‰ˆæœ¬æ ‡è¯†ï¼ˆç»¿è‰² Tagï¼‰
- å›æ»šæ ‡è¯†ï¼ˆæ©™è‰² Tagï¼Œå¦‚æœæ˜¯å›æ»šç‰ˆæœ¬ï¼‰

---

### åœºæ™¯äºŒï¼šç‰ˆæœ¬åˆ‡æ¢

#### å‰ææ¡ä»¶

- å·¥ç¨‹è‡³å°‘æœ‰ 2 ä¸ªå·²å‘å¸ƒç‰ˆæœ¬

#### æ­¥éª¤

1. æ‰“å¼€ç‰ˆæœ¬ç®¡ç†é¢æ¿
2. åœ¨ç‰ˆæœ¬å†å²åˆ—è¡¨ä¸­ï¼Œæ‰¾åˆ°ä¸€ä¸ª**éå½“å‰ç‰ˆæœ¬**
3. ç‚¹å‡»ç‰ˆæœ¬å³ä¾§çš„ **"åˆ‡æ¢"** æŒ‰é’®
4. åœ¨ç¡®è®¤å¯¹è¯æ¡†ä¸­ç‚¹å‡» **"ç¡®è®¤"**
5. ç­‰å¾…åˆ‡æ¢å®Œæˆ

#### é¢„æœŸç»“æœ

âœ… æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†ï¼Œè¯¢é—®"ç¡®è®¤å°†å½“å‰å·¥ä½œç‰ˆæœ¬åˆ‡æ¢ä¸º vX.X.X å—ï¼Ÿ"  
âœ… ç‚¹å‡»ç¡®è®¤åï¼š
  - ç‰ˆæœ¬é¡¹æ˜¾ç¤º Loading çŠ¶æ€
  - åˆ‡æ¢æˆåŠŸåæ˜¾ç¤º "ç‰ˆæœ¬åˆ‡æ¢æˆåŠŸ" æç¤º
  - **å½“å‰ç‰ˆæœ¬æ ‡è¯†**ä»æ—§ç‰ˆæœ¬ç§»åˆ°æ–°ç‰ˆæœ¬
  - é¡¶éƒ¨ä¿¡æ¯åŒºæ›´æ–°ä¸ºæ–°ç‰ˆæœ¬ä¿¡æ¯
  - ç¼–è¾‘å™¨é‡æ–°åŠ è½½å·¥ç¨‹æ•°æ®ï¼ˆå¦‚æœæœ‰æ–‡ä»¶æ‰“å¼€ï¼Œå†…å®¹ä¿æŒä¸å˜ï¼‰

âœ… å¯ä»¥å†æ¬¡åˆ‡æ¢å›åŸç‰ˆæœ¬ï¼Œæ“ä½œæ— å¼‚å¸¸

---

### åœºæ™¯ä¸‰ï¼šAPI æ¥å£æµ‹è¯•

#### ä½¿ç”¨ PowerShell æµ‹è¯•

```powershell
# 1. è·å–å·¥ç¨‹IDï¼ˆæ›¿æ¢ä¸ºå®é™…çš„å·¥ç¨‹IDï¼‰
$projectId = "your-project-id"

# 2. è·å–ç‰ˆæœ¬åˆ—è¡¨
curl http://localhost:8000/api/projects/$projectId/versions | ConvertFrom-Json | Format-List

# 3. è®°å½•ä¸€ä¸ªç‰ˆæœ¬IDï¼ˆä»ä¸Šé¢çš„ç»“æœä¸­å¤åˆ¶ï¼‰
$versionId = "your-version-id"

# 4. åˆ‡æ¢åˆ°è¯¥ç‰ˆæœ¬
$body = @{
    versionId = $versionId
} | ConvertTo-Json

curl -X PUT `
  -H "Content-Type: application/json" `
  -d $body `
  http://localhost:8000/api/projects/$projectId/current-version | ConvertFrom-Json | Format-List

# 5. éªŒè¯åˆ‡æ¢ç»“æœ
curl http://localhost:8000/api/projects/$projectId | ConvertFrom-Json | Select-Object -ExpandProperty data | Select-Object projectName, currentVersionId
```

#### é¢„æœŸè¿”å›

**åˆ‡æ¢æˆåŠŸå“åº”**ï¼š
```json
{
  "success": true,
  "data": {
    "projectId": "uuid",
    "previousVersionId": "uuid",  // åˆ‡æ¢å‰çš„ç‰ˆæœ¬ID
    "currentVersionId": "uuid",   // åˆ‡æ¢åçš„ç‰ˆæœ¬ID
    "updatedAt": "2026-01-19T14:30:00.000Z"
  }
}
```

**é”™è¯¯å“åº”ï¼ˆç‰ˆæœ¬ä¸å­˜åœ¨ï¼‰**ï¼š
```json
{
  "success": false,
  "error": "Version not found"
}
```

---

### åœºæ™¯å››ï¼šæ•°æ®åº“éªŒè¯

#### ä½¿ç”¨ psql éªŒè¯

```sql
-- 1. æŸ¥çœ‹ sessions è¡¨ç»“æ„ï¼ˆéªŒè¯æ–°å­—æ®µï¼‰
\d sessions

-- é¢„æœŸè¾“å‡ºåº”åŒ…å«ï¼š
-- version_id            | uuid
-- version_snapshot      | jsonb

-- 2. æŸ¥çœ‹ç´¢å¼•
\di sessions_version_id_idx

-- é¢„æœŸè¾“å‡ºï¼šsessions_version_id_idx å­˜åœ¨

-- 3. éªŒè¯å¤–é”®çº¦æŸ
SELECT
    tc.constraint_name,
    tc.table_name,
    kcu.column_name,
    ccu.table_name AS foreign_table_name,
    ccu.column_name AS foreign_column_name
FROM information_schema.table_constraints AS tc
JOIN information_schema.key_column_usage AS kcu
  ON tc.constraint_name = kcu.constraint_name
JOIN information_schema.constraint_column_usage AS ccu
  ON ccu.constraint_name = tc.constraint_name
WHERE tc.constraint_type = 'FOREIGN KEY'
  AND tc.table_name = 'sessions'
  AND kcu.column_name = 'version_id';

-- é¢„æœŸè¾“å‡ºï¼šå¤–é”®æŒ‡å‘ project_versions(id)
```

---

## ğŸ› å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1ï¼šç‰ˆæœ¬ç®¡ç†æŒ‰é’®ç‚¹å‡»åæ— å“åº”

**åŸå› **ï¼šprojectId æœªæ­£ç¡®ä¼ é€’

**æ£€æŸ¥**ï¼š
1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
2. æŸ¥çœ‹ Console æ˜¯å¦æœ‰é”™è¯¯
3. æ£€æŸ¥ Network æ ‡ç­¾é¡µï¼Œç¡®è®¤ API è¯·æ±‚æ˜¯å¦å‘å‡º

**è§£å†³**ï¼š
- ç¡®ä¿å·²è¿›å…¥å·¥ç¨‹ç¼–è¾‘å™¨ï¼ˆURL åŒ…å« `/projects/:projectId`ï¼‰
- åˆ·æ–°é¡µé¢é‡æ–°åŠ è½½å·¥ç¨‹æ•°æ®

---

### é—®é¢˜ 2ï¼šç‰ˆæœ¬åˆ—è¡¨ä¸ºç©º

**åŸå› **ï¼šå·¥ç¨‹å°šæœªå‘å¸ƒä»»ä½•ç‰ˆæœ¬

**æ£€æŸ¥**ï¼š
```powershell
curl http://localhost:8000/api/projects/$projectId/versions
```

**è§£å†³**ï¼š
1. ä¿®æ”¹å·¥ç¨‹æ–‡ä»¶å†…å®¹
2. ç‚¹å‡» **"Save"** ä¿å­˜
3. ç‚¹å‡» **"Publish Version"** å‘å¸ƒç‰ˆæœ¬
4. è¾“å…¥å‘å¸ƒè¯´æ˜åç¡®è®¤
5. åˆ·æ–°ç‰ˆæœ¬ç®¡ç†é¢æ¿

---

### é—®é¢˜ 3ï¼šåˆ‡æ¢ç‰ˆæœ¬åç¼–è¾‘å™¨å†…å®¹æœªæ›´æ–°

**åŸå› **ï¼š`onVersionChange` å›è°ƒæœªæ­£ç¡®è§¦å‘

**æ£€æŸ¥**ï¼š
- æ‰“å¼€æµè§ˆå™¨ Console
- åˆ‡æ¢ç‰ˆæœ¬æ—¶åº”çœ‹åˆ° `loadProjectData` çš„æ—¥å¿—

**è§£å†³**ï¼š
- æ£€æŸ¥ `VersionListPanel` çš„ `onVersionChange` prop æ˜¯å¦æ­£ç¡®ä¼ é€’
- æ‰‹åŠ¨åˆ·æ–°æµè§ˆå™¨é¡µé¢ï¼ˆF5ï¼‰

---

### é—®é¢˜ 4ï¼šæ•°æ®åº“è¿ç§»æœªæ‰§è¡Œ

**ç—‡çŠ¶**ï¼šAPI æŠ¥é”™ `column "version_id" does not exist`

**æ£€æŸ¥**ï¼š
```powershell
cd packages/api-server
npx tsx src/db/migrate.ts
```

**è§£å†³**ï¼š
1. ç¡®è®¤ `.env` æ–‡ä»¶ä¸­çš„ `DATABASE_URL` æ­£ç¡®
2. æ‰‹åŠ¨æ‰§è¡Œè¿ç§»è„šæœ¬ï¼š
   ```powershell
   cd packages/api-server
   npx tsx src/db/migrate.ts
   ```
3. é‡å¯ API æœåŠ¡å™¨

---

## ğŸ“Š æ€§èƒ½æµ‹è¯•

### ç‰ˆæœ¬åˆ—è¡¨åŠ è½½æ€§èƒ½

#### æµ‹è¯•ç›®æ ‡

- 50 ä¸ªç‰ˆæœ¬åŠ è½½æ—¶é—´ < 1ç§’
- 100 ä¸ªç‰ˆæœ¬åŠ è½½æ—¶é—´ < 2ç§’

#### æµ‹è¯•æ–¹æ³•

```powershell
# åˆ›å»ºæµ‹è¯•ç‰ˆæœ¬ï¼ˆä»…ç”¨äºæµ‹è¯•ç¯å¢ƒï¼‰
$projectId = "your-project-id"

1..50 | ForEach-Object {
    $body = @{
        versionNumber = "v1.0.$_"
        releaseNote = "Test version $_"
        publishedBy = "tester"
    } | ConvertTo-Json

    curl -X POST `
      -H "Content-Type: application/json" `
      -d $body `
      http://localhost:8000/api/projects/$projectId/publish
}

# æµ‹é‡åŠ è½½æ—¶é—´
Measure-Command {
    curl http://localhost:8000/api/projects/$projectId/versions
}
```

#### é¢„æœŸç»“æœ

- API å“åº”æ—¶é—´ < 500ms
- å‰ç«¯æ¸²æŸ“æ—¶é—´ < 500ms
- æ€»ä½“ç”¨æˆ·æ„ŸçŸ¥ < 1s

---

## âœ… æµ‹è¯•æ£€æŸ¥æ¸…å•

### åŠŸèƒ½æµ‹è¯•

- [ ] ç‰ˆæœ¬ç®¡ç†æŒ‰é’®å¯ç‚¹å‡»ï¼Œé¢æ¿æ­£ç¡®æ˜¾ç¤º/éšè—
- [ ] ç‰ˆæœ¬åˆ—è¡¨æ­£ç¡®æ˜¾ç¤ºæ‰€æœ‰ç‰ˆæœ¬
- [ ] å½“å‰ç‰ˆæœ¬æ ‡è¯†æ­£ç¡®ï¼ˆç»¿è‰² Tagï¼‰
- [ ] å›æ»šç‰ˆæœ¬æ ‡è¯†æ­£ç¡®ï¼ˆæ©™è‰² Tag + æ¥æºç‰ˆæœ¬å·ï¼‰
- [ ] è‰ç¨¿çŠ¶æ€æ­£ç¡®æ˜¾ç¤ºï¼ˆæœ‰è‰ç¨¿æ—¶ï¼‰
- [ ] ç‰ˆæœ¬åˆ‡æ¢ç¡®è®¤å¯¹è¯æ¡†æ­£å¸¸å¼¹å‡º
- [ ] ç‰ˆæœ¬åˆ‡æ¢æˆåŠŸåçŠ¶æ€æ­£ç¡®æ›´æ–°
- [ ] åˆ‡æ¢å¤±è´¥æ—¶é”™è¯¯æç¤ºæ­£ç¡®æ˜¾ç¤º
- [ ] åˆ·æ–°æŒ‰é’®å¯æ­£å¸¸é‡æ–°åŠ è½½æ•°æ®
- [ ] å…³é—­æŒ‰é’®å¯æ­£ç¡®éšè—é¢æ¿

### API æµ‹è¯•

- [ ] PUT /current-version è¿”å›æ­£ç¡®çš„æˆåŠŸå“åº”
- [ ] æ— æ•ˆ versionId è¿”å› 404 é”™è¯¯
- [ ] æ— æ•ˆ projectId è¿”å› 404 é”™è¯¯
- [ ] ç¼ºå°‘å‚æ•°è¿”å› 400 é”™è¯¯
- [ ] æœåŠ¡å¼‚å¸¸è¿”å› 500 é”™è¯¯

### æ•°æ®åº“æµ‹è¯•

- [ ] sessions.version_id å­—æ®µå­˜åœ¨
- [ ] sessions.version_snapshot å­—æ®µå­˜åœ¨
- [ ] sessions_version_id_idx ç´¢å¼•å­˜åœ¨
- [ ] å¤–é”®çº¦æŸæ­£ç¡®è®¾ç½®

### UI æµ‹è¯•

- [ ] é¢æ¿å®½åº¦å›ºå®š 400px
- [ ] é¢æ¿å±‚çº§æ­£ç¡®ï¼ˆz-index: 1000ï¼‰
- [ ] æ»šåŠ¨æ¡æ ·å¼è‡ªå®šä¹‰ï¼ˆ6px å®½åº¦ï¼‰
- [ ] ç‰ˆæœ¬é¡¹æ‚¬åœæ•ˆæœï¼ˆè“è‰²è¾¹æ¡† + é˜´å½±ï¼‰
- [ ] Loading çŠ¶æ€æ˜¾ç¤º Spin ç»„ä»¶
- [ ] é”™è¯¯çŠ¶æ€æ˜¾ç¤ºé‡è¯•æŒ‰é’®
- [ ] ç©ºçŠ¶æ€æ˜¾ç¤º Empty ç»„ä»¶

---

## ğŸ¯ éªŒæ”¶æ ‡å‡†

æ ¹æ®è®¾è®¡æ–‡æ¡£ï¼Œä»¥ä¸‹æ ‡å‡†å¿…é¡»å…¨éƒ¨è¾¾æˆï¼š

### æ•°æ®æ¨¡å‹éªŒæ”¶
- âœ… SESSIONS è¡¨åŒ…å« version_id å’Œ version_snapshot
- âœ… å¤–é”®çº¦æŸæŒ‡å‘ PROJECT_VERSIONS.id
- âœ… ç´¢å¼• sessions_version_id_idx å·²åˆ›å»º

### API éªŒæ”¶
- âœ… PUT /current-version è¿”å› previousVersionId å’Œ currentVersionId
- âœ… Zod å‚æ•°æ ¡éªŒæœ‰æ•ˆ
- âœ… é”™è¯¯å¤„ç†å®Œå–„ï¼ˆ404/400/500ï¼‰

### UI éªŒæ”¶
- âœ… å³ä¾§é¢æ¿æ­£ç¡®æ˜¾ç¤º
- âœ… ä¸‰åŒºåŸŸå¸ƒå±€æ¸…æ™°
- âœ… ç‰ˆæœ¬åˆ‡æ¢æµç¨‹å®Œæ•´
- âœ… çŠ¶æ€ç®¡ç†æ­£ç¡®

### é›†æˆéªŒæ”¶
- âœ… ç‰ˆæœ¬åˆ‡æ¢åç¼–è¾‘å™¨æ•°æ®åŒæ­¥
- âœ… æœåŠ¡å¯åŠ¨æ— é”™è¯¯

---

## ğŸ“ æµ‹è¯•æŠ¥å‘Šæ¨¡æ¿

### æµ‹è¯•æ‰§è¡Œè®°å½•

| æµ‹è¯•åœºæ™¯ | æ‰§è¡Œäºº | æ‰§è¡Œæ—¶é—´ | ç»“æœ | å¤‡æ³¨ |
|---------|--------|---------|------|------|
| åœºæ™¯ä¸€ï¼šæŸ¥çœ‹ç‰ˆæœ¬åˆ—è¡¨ | | | âœ…/âŒ | |
| åœºæ™¯äºŒï¼šç‰ˆæœ¬åˆ‡æ¢ | | | âœ…/âŒ | |
| åœºæ™¯ä¸‰ï¼šAPI æ¥å£æµ‹è¯• | | | âœ…/âŒ | |
| åœºæ™¯å››ï¼šæ•°æ®åº“éªŒè¯ | | | âœ…/âŒ | |

### ç¼ºé™·è®°å½•

| ç¼ºé™·ID | æè¿° | ä¸¥é‡ç¨‹åº¦ | çŠ¶æ€ | å¤‡æ³¨ |
|--------|------|----------|------|------|
| | | é«˜/ä¸­/ä½ | å¾…ä¿®å¤/å·²ä¿®å¤ | |

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [å®æ–½å®ŒæˆæŠ¥å‘Š](./P1-T1-implementation-report.md)
- [è®¾è®¡æ–‡æ¡£](./engineering-version-model-design.md)
- [API æ–‡æ¡£](http://localhost:8000/docs)

---

**æµ‹è¯•æŒ‡å—ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°æ—¶é—´**ï¼š2026-01-19

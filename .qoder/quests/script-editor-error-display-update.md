# 脚本编辑器错误展示设计更新说明

## 更新日期
2026-01-18

## 更新原因
根据用户反馈，原设计方案A（顶部横向错误条）不符合实际需求。用户希望采用更灵活、功能更丰富的嵌入式气泡设计。

## 主要变更

### 1. 布局方案变更

**原方案A**：调试面板顶部横向错误条
- 优点：位置固定，视觉优先级高
- 缺点：只能展示单一错误，信息展示受限

**新方案B**：调试面板内嵌气泡式信息流
- 优点：
  - 支持多种类型的调试信息（错误、提示词、变量等）
  - 信息按时间顺序嵌入对话流，保持上下文连贯
  - 每个气泡可独立展开/折叠
  - 用户可通过过滤器灵活控制显示内容

### 2. 新增功能

#### 2.1 调试输出过滤器（🔧）

位于调试配置区的新增按钮，点击后弹出多选面板：

**可选类型**：
- ✅ 错误信息（默认开启）
- ✅ LLM 提示词
- ✅ LLM 响应
- ✅ 变量状态（默认开启）
- ✅ 执行日志
- ✅ 位置信息

**快捷操作**：
- 全部展开 / 全部折叠
- 仅显示错误 / 显示全部
- 重置默认

**持久化**：过滤器配置保存到 localStorage

#### 2.2 六种调试信息气泡

| 类型 | 图标 | 颜色 | 默认状态 | 主要用途 |
|-----|------|------|---------|---------|
| 错误信息 | ⚠️ | 红色 | 展开 | 显示执行错误和异常 |
| LLM 提示词 | 💡 | 蓝色 | 折叠 | 查看发送给AI的完整提示 |
| LLM 响应 | 🤖 | 深蓝 | 折叠 | 查看AI的原始响应内容 |
| 变量状态 | 📊 | 绿色 | 折叠 | 追踪会话变量变化 |
| 执行日志 | 📝 | 灰色 | 折叠 | 查看Action执行详情 |
| 位置信息 | 🧭 | 黄色 | 折叠 | 显示当前执行位置路径 |

#### 2.3 气泡交互增强

**单个气泡操作**：
- 展开 ▼ / 折叠 ▲
- 复制内容
- 导出JSON（变量气泡）
- 在导航树中定位（位置气泡）
- 重新开始（错误气泡）

**批量操作**：
- 通过过滤器面板统一控制
- 支持按类型显示/隐藏
- 支持全部展开/折叠

### 3. 数据结构更新

新增完整的 TypeScript 类型定义：

```typescript
// 核心类型
type DebugBubbleType = 'error' | 'llm_prompt' | 'llm_response' 
  | 'variable' | 'execution_log' | 'position';

interface DebugBubble {
  id: string;
  type: DebugBubbleType;
  timestamp: string;
  isExpanded: boolean;
  actionId?: string;
  actionType?: string;
  content: DebugBubbleContent;
}

// 过滤器配置
interface DebugOutputFilter {
  showError: boolean;
  showLLMPrompt: boolean;
  showLLMResponse: boolean;
  showVariable: boolean;
  showExecutionLog: boolean;
  showPosition: boolean;
  expandAll: boolean;
  errorOnly: boolean;
}

// 调试面板状态
interface DebugPanelState {
  bubbles: DebugBubble[];
  filter: DebugOutputFilter;
  userMessages: Message[];
  aiMessages: Message[];
}
```

### 4. 验收标准更新

原有 6 条验收标准扩展为 7 大类 42 条详细标准：

1. **错误信息气泡验收**（6条）
2. **LLM 提示词气泡验收**（4条）
3. **LLM 响应气泡验收**（3条）
4. **变量状态气泡验收**（4条）
5. **执行日志气泡验收**（3条）
6. **位置信息气泡验收**（3条）
7. **过滤器功能验收**（7条）

## 实现优先级

### P0 - 核心功能（必须实现）
1. 错误信息气泡
2. 变量状态气泡
3. 调试输出过滤器（基础版）
4. 气泡展开/折叠交互

### P1 - 增强功能（建议实现）
5. LLM 提示词气泡
6. LLM 响应气泡
7. 过滤器持久化
8. 批量展开/折叠

### P2 - 可选功能（后续迭代）
9. 执行日志气泡
10. 位置信息气泡
11. 导出JSON功能
12. 错误详情弹窗（已在气泡中展开，可降低优先级）

## 与原设计的兼容性

### 保留的设计元素
- 错误分类体系（5大类错误）
- 错误响应数据结构
- 重新开始调试功能
- 错误恢复策略

### 移除的设计元素
- 顶部横向错误条（替换为气泡）
- 全局浮动错误提示（不需要）

### 增强的设计元素
- 错误详情展示（从弹窗改为气泡内展开）
- 调试信息类型（从单一错误扩展为6种类型）
- 用户控制能力（增加过滤器）

## 对后续开发的影响

### 前端组件变更
1. **新增组件**：
   - `DebugBubble` - 调试信息气泡基础组件
   - `ErrorBubble` - 错误信息气泡
   - `LLMPromptBubble` - LLM提示词气泡
   - `LLMResponseBubble` - LLM响应气泡
   - `VariableBubble` - 变量状态气泡
   - `ExecutionLogBubble` - 执行日志气泡
   - `PositionBubble` - 位置信息气泡
   - `DebugFilterModal` - 调试输出过滤器面板

2. **修改组件**：
   - `DebugChatPanel` - 集成气泡渲染逻辑
   - `ErrorBanner` - 可能废弃或降低优先级

### 后端接口变更
无需变更，现有错误响应结构已满足需求。

### 状态管理变更
- 从单一错误状态扩展为气泡列表状态
- 增加过滤器配置状态
- 增加 localStorage 持久化逻辑

## 用户体验改进

1. **更好的上下文连贯性**：调试信息嵌入对话流，不打断对话连续性
2. **更强的信息可控性**：用户可自定义显示哪些类型的调试信息
3. **更灵活的信息密度**：通过展开/折叠控制信息详细程度
4. **更丰富的调试能力**：不仅看错误，还能看提示词、变量、日志等
5. **更好的可发现性**：所有调试信息统一在对话流中，不会遗漏

## 实施建议

1. **分阶段实现**：
   - 第一阶段：实现错误气泡 + 基础过滤器
   - 第二阶段：实现变量气泡 + LLM提示词气泡
   - 第三阶段：实现其他类型气泡 + 高级功能

2. **保持向后兼容**：
   - 原有的 `ErrorBanner` 组件保留但标记为 deprecated
   - 允许用户通过配置选择使用旧版或新版展示方式

3. **性能考虑**：
   - 气泡数量超过50个时实现虚拟滚动
   - 大文本内容（如LLM提示词）使用懒加载
   - 过滤器变更时使用防抖避免频繁重渲染

## 相关文档

- 主设计文档：`script-editor-core-plan.md` 第 2.4 节
- 实现参考：`DebugChatPanel/index.tsx`
- 类型定义：`src/types/debug.ts`（待创建）

## 审核记录

- 提出者：用户
- 更新者：AI Assistant
- 更新日期：2026-01-18
- 审核状态：待审核


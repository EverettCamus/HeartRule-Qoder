# 多用户项目工程基础设施

<cite>
**本文档引用的文件**
- [README.md](file://README.md)
- [package.json](file://package.json)
- [pnpm-workspace.yaml](file://pnpm-workspace.yaml)
- [docker-compose.dev.yml](file://docker-compose.dev.yml)
- [packages/api-server/package.json](file://packages/api-server/package.json)
- [packages/core-engine/package.json](file://packages/core-engine/package.json)
- [packages/script-editor/package.json](file://packages/script-editor/package.json)
- [packages/shared-types/package.json](file://packages/shared-types/package.json)
- [packages/api-server/src/app.ts](file://packages/api-server/src/app.ts)
- [packages/api-server/src/index.ts](file://packages/api-server/src/index.ts)
- [packages/api-server/src/routers/sessions.ts](file://packages/api-server/src/routers/sessions.ts)
- [packages/api-server/src/routers/chat.ts](file://packages/api-server/src/routers/chat.ts)
- [packages/api-server/src/routers/scripts.ts](file://packages/api-server/src/routers/scripts.ts)
- [packages/api-server/src/services/session-manager.ts](file://packages/api-server/src/services/session-manager.ts)
- [packages/api-server/src/services/project-initializer.ts](file://packages/api-server/src/services/project-initializer.ts)
- [packages/core-engine/src/index.ts](file://packages/core-engine/src/index.ts)
- [packages/core-engine/src/domain/session.ts](file://packages/core-engine/src/domain/session.ts)
- [packages/shared-types/src/index.ts](file://packages/shared-types/src/index.ts)
</cite>

## 目录

1. [项目概述](#项目概述)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概览](#架构概览)
5. [详细组件分析](#详细组件分析)
6. [依赖关系分析](#依赖关系分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 项目概述

HeartRule AI咨询引擎是一个基于"LLM + YAML脚本"的智能咨询框架，首个应用场景是CBT心理咨询。该项目采用混合架构，结合大语言模型的语言理解与生成能力，以及结构化脚本的流程控制能力，将专业咨询师的经验、技术、流程和数据沉淀为可执行、可维护的脚本化知识库。

### 核心特性

- **经验结构化沉淀**：通过YAML脚本将咨询师经验转化为可复用知识资产
- **灵活性与可控性平衡**：LLM提供自然语言交互，脚本保证流程专业性
- **领域知识可扩展**：支持不同咨询领域的专业化脚本定制
- **质量可追溯**：脚本化流程便于审计、优化和质量管理
- **类型安全**：TypeScript编译时检查，减少运行时错误
- **高性能**：Fastify框架 + 异步事件循环
- **现代化架构**：Monorepo + pnpm + 六大核心引擎

## 项目结构

项目采用Monorepo架构，使用pnpm workspace进行包管理：

```mermaid
graph TB
subgraph "根目录"
RootPkg[package.json]
Workspace[pnpm-workspace.yaml]
Docker[docker-compose.dev.yml]
Readme[README.md]
end
subgraph "packages/"
subgraph "共享层"
SharedTypes[packages/shared-types/]
SharedIndex[src/index.ts]
end
subgraph "核心引擎层"
CoreEngine[packages/core-engine/]
CoreIndex[src/index.ts]
Domain[domain/]
Engines[engines/]
end
subgraph "服务层"
APIServer[packages/api-server/]
App[app.ts]
Routes[routers/]
Services[services/]
end
subgraph "前端层"
ScriptEditor[packages/script-editor/]
end
end
RootPkg --> Workspace
Workspace --> SharedTypes
Workspace --> CoreEngine
Workspace --> APIServer
Workspace --> ScriptEditor
APIServer --> CoreEngine
APIServer --> SharedTypes
CoreEngine --> SharedTypes
```

**图表来源**

- [pnpm-workspace.yaml](file://pnpm-workspace.yaml#L1-L3)
- [packages/api-server/package.json](file://packages/api-server/package.json#L1-L49)
- [packages/core-engine/package.json](file://packages/core-engine/package.json#L1-L38)
- [packages/shared-types/package.json](file://packages/shared-types/package.json#L1-L27)

**章节来源**

- [README.md](file://README.md#L50-L58)
- [pnpm-workspace.yaml](file://pnpm-workspace.yaml#L1-L3)

## 核心组件

### 1. API服务器 (Fastify)

API服务器是系统的入口点，基于Fastify框架构建，提供REST API和WebSocket支持：

- **核心功能**：会话管理、聊天交互、脚本管理
- **中间件**：CORS、Swagger文档、WebSocket
- **数据库**：Drizzle ORM + PostgreSQL
- **缓存**：Redis集成

### 2. 核心引擎 (Headless)

核心引擎是无头的六引擎架构，包含以下核心模块：

- **脚本执行引擎**：解析YAML，管理Phase → Topic → Action流程
- **LLM编排引擎**：统一管理多个LLM提供者
- **变量提取引擎**：从对话中提取变量
- **记忆引擎**：短期/中期/长期记忆管理
- **话题调度引擎**：动态话题切换
- **意识触发引擎**：监控对话情境

### 3. 共享类型系统

提供跨包共享的TypeScript类型定义和Zod Schema：

- **领域模型类型**：Session、Message、Script、Variable
- **API接口类型**：请求和响应类型
- **枚举和常量**：状态枚举、配置常量

### 4. 脚本编辑器

基于React的可视化脚本编辑器，提供：

- **拖拽式界面**：可视化编辑YAML脚本
- **实时验证**：语法和Schema验证
- **调试功能**：LLM调试图标和变量显示
- **版本管理**：脚本版本控制

**章节来源**

- [packages/api-server/src/app.ts](file://packages/api-server/src/app.ts#L21-L105)
- [packages/core-engine/src/index.ts](file://packages/core-engine/src/index.ts#L12-L193)
- [packages/shared-types/src/index.ts](file://packages/shared-types/src/index.ts#L1-L20)

## 架构概览

系统采用五层分层架构：

```mermaid
graph TB
subgraph "表现层"
Frontend[用户前端]
Editor[脚本编辑器]
end
subgraph "应用层"
SessionMgr[会话管理器]
ChatRoutes[聊天路由]
ScriptRoutes[脚本路由]
ProjectInit[工程初始化器]
end
subgraph "引擎层"
ScriptExec[脚本执行引擎]
LLMOrchestrator[LLM编排引擎]
VarExtractor[变量提取引擎]
MemoryEngine[记忆引擎]
TopicScheduler[话题调度引擎]
ConsciousnessTrigger[意识触发引擎]
end
subgraph "脚本层"
YAMLScripts[YAML脚本]
Templates[模板系统]
end
subgraph "基础设施层"
PostgreSQL[(PostgreSQL)]
Redis[(Redis)]
LLMProviders[LLM提供者]
end
Frontend --> SessionMgr
Editor --> ProjectInit
SessionMgr --> ScriptExec
ChatRoutes --> SessionMgr
ScriptRoutes --> ProjectInit
SessionMgr --> LLMOrchestrator
ScriptExec --> VarExtractor
ScriptExec --> MemoryEngine
ScriptExec --> TopicScheduler
ScriptExec --> ConsciousnessTrigger
ScriptExec --> YAMLScripts
Templates --> ScriptExec
SessionMgr --> PostgreSQL
SessionMgr --> Redis
LLMOrchestrator --> LLMProviders
```

**图表来源**

- [README.md](file://README.md#L26-L48)
- [packages/api-server/src/services/session-manager.ts](file://packages/api-server/src/services/session-manager.ts#L76-L83)
- [packages/core-engine/src/index.ts](file://packages/core-engine/src/index.ts#L135-L167)

## 详细组件分析

### API服务器架构

API服务器采用模块化设计，每个路由模块负责特定功能域：

```mermaid
classDiagram
class FastifyApp {
+registerCors()
+registerSwagger()
+registerWebsocket()
+registerRoutes()
+startServer()
}
class SessionManager {
-scriptExecutor : ScriptExecutor
-templateProvider : TemplateProvider
+initializeSession(sessionId)
+processUserInput(sessionId, message)
-loadSessionById()
-executeScript()
-saveResults()
}
class ProjectInitializer {
-systemTemplatesPath : string
+initializeProject(config)
-importDefaultTemplates()
-generateSampleScripts()
}
class DatabaseTemplateProvider {
+getTemplate(templateId)
+listTemplates()
+saveTemplate()
}
FastifyApp --> SessionManager : "使用"
FastifyApp --> ProjectInitializer : "使用"
SessionManager --> DatabaseTemplateProvider : "依赖"
SessionManager --> ScriptExecutor : "使用"
```

**图表来源**

- [packages/api-server/src/app.ts](file://packages/api-server/src/app.ts#L21-L105)
- [packages/api-server/src/services/session-manager.ts](file://packages/api-server/src/services/session-manager.ts#L76-L83)
- [packages/api-server/src/services/project-initializer.ts](file://packages/api-server/src/services/project-initializer.ts#L46-L58)

### 会话管理系统

会话管理系统是核心业务逻辑的实现：

```mermaid
sequenceDiagram
participant Client as 客户端
participant API as API服务器
participant SM as 会话管理器
participant DB as 数据库
participant CE as 核心引擎
Client->>API : POST /api/sessions
API->>SM : initializeSession(sessionId)
SM->>DB : 查询会话和脚本
SM->>CE : executeSession(脚本内容, 状态)
CE->>CE : 执行Action链
CE-->>SM : 执行结果
SM->>DB : 保存消息和变量
SM-->>API : 会话初始化结果
API-->>Client : AI消息和状态
Client->>API : POST /api/chat
API->>SM : processUserInput(sessionId, message)
SM->>DB : 保存用户消息
SM->>CE : executeSession(带用户输入)
CE-->>SM : 执行结果
SM->>DB : 保存AI消息
SM-->>API : 聊天响应
API-->>Client : AI回复
```

**图表来源**

- [packages/api-server/src/routers/sessions.ts](file://packages/api-server/src/routers/sessions.ts#L14-L155)
- [packages/api-server/src/routers/chat.ts](file://packages/api-server/src/routers/chat.ts#L15-L88)
- [packages/api-server/src/services/session-manager.ts](file://packages/api-server/src/services/session-manager.ts#L649-L709)

### 核心引擎架构

核心引擎采用DDD（领域驱动设计）实现：

```mermaid
classDiagram
class Session {
+sessionId : string
+userId : string
+scriptId : string
+status : SessionStatus
+executionStatus : ExecutionStatus
+position : ExecutionPosition
+variables : Map~string, unknown~
+variableStore : VariableStore
+conversationHistory : ConversationEntry[]
+start()
+pause()
+resume()
+complete()
+fail(error)
+updatePosition()
+setVariable()
+getVariable()
+addConversationEntry()
}
class ScriptExecutor {
+executeSession()
+createInitialState()
+executePhase()
+executeTopic()
+executeAction()
}
class BaseAction {
<<abstract>>
+actionId : string
+actionType : string
+execute(context, userInput)
+validateConfig()
}
class AiSayAction {
+execute(context, userInput)
+generateResponse()
}
class AiAskAction {
+execute(context, userInput)
+extractVariables()
}
Session --> ScriptExecutor : "使用"
ScriptExecutor --> BaseAction : "执行"
BaseAction <|-- AiSayAction : "继承"
BaseAction <|-- AiAskAction : "继承"
```

**图表来源**

- [packages/core-engine/src/domain/session.ts](file://packages/core-engine/src/domain/session.ts#L26-L88)
- [packages/core-engine/src/index.ts](file://packages/core-engine/src/index.ts#L135-L169)

**章节来源**

- [packages/api-server/src/services/session-manager.ts](file://packages/api-server/src/services/session-manager.ts#L1-L769)
- [packages/core-engine/src/domain/session.ts](file://packages/core-engine/src/domain/session.ts#L1-L221)

### 数据库架构

系统使用PostgreSQL作为主要数据存储，采用Drizzle ORM进行类型安全的数据库操作：

```mermaid
erDiagram
SESSIONS {
uuid id PK
string user_id
uuid script_id FK
enum status
enum execution_status
jsonb position
jsonb variables
jsonb metadata
timestamp created_at
timestamp updated_at
}
SCRIPTS {
uuid id PK
string script_name
string script_type
text script_content
jsonb parsed_content
string version
enum status
string author
text description
string[] tags
timestamp created_at
timestamp updated_at
}
MESSAGES {
uuid id PK
uuid session_id FK
enum role
text content
string action_id
jsonb metadata
timestamp timestamp
}
VARIABLES {
uuid id PK
uuid session_id FK
string variable_name
jsonb value
string scope
string value_type
string source
timestamp created_at
}
SCRIPT_FILES {
uuid id PK
uuid project_id FK
string file_type
string file_name
string file_path
jsonb file_content
jsonb yaml_content
timestamp created_at
timestamp updated_at
}
PROJECTS {
uuid id PK
string project_name
string domain
string scenario
string language
string author
timestamp created_at
timestamp updated_at
}
SESSIONS ||--o{ MESSAGES : "包含"
SESSIONS ||--o{ VARIABLES : "跟踪"
SESSIONS }o--|| SCRIPTS : "使用"
SCRIPT_FILES ||--o{ SCRIPTS : "存储"
PROJECTS ||--o{ SCRIPT_FILES : "拥有"
```

**图表来源**

- [packages/api-server/src/services/session-manager.ts](file://packages/api-server/src/services/session-manager.ts#L14-L22)
- [packages/api-server/src/services/project-initializer.ts](file://packages/api-server/src/services/project-initializer.ts#L17-L18)

**章节来源**

- [packages/api-server/src/services/session-manager.ts](file://packages/api-server/src/services/session-manager.ts#L14-L22)

## 依赖关系分析

项目采用清晰的依赖层次结构：

```mermaid
graph TD
subgraph "根依赖"
RootPkg[根package.json]
Pnpm[pnpm workspace]
end
subgraph "共享依赖"
TS[TypeScript 5.9]
Vitest[Vitest]
ESLint[ESLint]
Prettier[Prettier]
end
subgraph "API服务器依赖"
Fastify[Fastify 4.x]
Drizzle[Drizzle ORM 0.29]
Postgres[PostgreSQL]
Redis[Redis 7.2]
Zod[Zod 3.x]
end
subgraph "核心引擎依赖"
CoreAjv[AJV 8.17]
CoreYAML[js-yaml 4.1]
CoreUUID[UUID 9.0]
CoreZod[Zod 3.x]
end
subgraph "脚本编辑器依赖"
React[React 18.2]
Antd[Ant Design 5.13]
Zustand[Zustand 4.5]
Vite[Vite 5.0]
end
RootPkg --> Pnpm
RootPkg --> TS
RootPkg --> Vitest
RootPkg --> ESLint
RootPkg --> Prettier
Fastify --> Drizzle
Drizzle --> Postgres
Fastify --> Redis
Fastify --> Zod
CoreAjv --> CoreYAML
CoreYAML --> CoreUUID
CoreUUID --> CoreZod
React --> Antd
Antd --> Zustand
Zustand --> Vite
```

**图表来源**

- [package.json](file://package.json#L1-L67)
- [packages/api-server/package.json](file://packages/api-server/package.json#L24-L39)
- [packages/core-engine/package.json](file://packages/core-engine/package.json#L21-L29)
- [packages/script-editor/package.json](file://packages/script-editor/package.json#L14-L26)

**章节来源**

- [package.json](file://package.json#L1-L67)
- [packages/api-server/package.json](file://packages/api-server/package.json#L1-L49)

## 性能考虑

### 1. 数据库性能优化

- **连接池管理**：使用Drizzle ORM的连接池优化数据库连接
- **索引策略**：为常用查询字段建立适当索引
- **查询优化**：避免N+1查询问题，批量操作数据
- **缓存策略**：Redis缓存热点数据，减少数据库压力

### 2. API性能优化

- **异步处理**：所有I/O操作采用异步模式
- **流式响应**：SSE流式响应支持长文本输出
- **错误处理**：完善的错误处理和超时机制
- **日志优化**：结构化日志，避免过度打印

### 3. 内存管理

- **变量存储**：分层变量存储，避免内存泄漏
- **会话状态**：及时清理不再使用的会话状态
- **模板缓存**：LLM模板缓存，减少重复计算

## 故障排除指南

### 1. 常见启动问题

**问题**：数据库连接失败

- 检查PostgreSQL服务状态
- 验证连接字符串配置
- 确认数据库权限设置

**问题**：Redis连接失败

- 检查Redis服务状态
- 验证密码配置
- 确认网络连通性

### 2. API调用问题

**问题**：会话创建失败

- 检查脚本ID有效性
- 验证用户ID格式
- 确认脚本状态为published

**问题**：聊天响应异常

- 检查会话状态
- 验证用户输入格式
- 查看LLM提供商状态

### 3. 调试技巧

- **启用详细日志**：设置LOG_LEVEL=debug
- **使用Swagger UI**：http://localhost:8000/docs
- **检查数据库状态**：http://localhost:8080
- **监控Redis状态**：http://localhost:8081

**章节来源**

- [packages/api-server/src/app.ts](file://packages/api-server/src/app.ts#L82-L89)
- [packages/api-server/src/utils/error-handler.ts](file://packages/api-server/src/utils/error-handler.ts)

## 结论

HeartRule AI咨询引擎是一个设计精良的多用户项目工程基础设施，具有以下特点：

### 技术优势

1. **架构清晰**：采用五层分层架构，职责分离明确
2. **类型安全**：全面的TypeScript类型系统
3. **可扩展性**：模块化设计，易于功能扩展
4. **性能优化**：异步处理和缓存策略
5. **开发友好**：完善的开发工具链和文档

### 未来发展方向

1. **前端开发**：实现React + Pixi.js的可视化界面
2. **功能完善**：完成话题调度引擎和意识触发引擎
3. **性能优化**：实现长期记忆和向量检索
4. **部署优化**：容器化和微服务架构
5. **用户体验**：游戏化UI和更好的交互体验

该系统为CBT心理咨询提供了强大的技术支持，通过结构化脚本和LLM编排，能够为用户提供专业、个性化的咨询服务。

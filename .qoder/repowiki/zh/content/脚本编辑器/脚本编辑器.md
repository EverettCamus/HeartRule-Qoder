# 脚本编辑器

<cite>
**本文引用的文件**
- [App.tsx](file://packages/script-editor/src/App.tsx)
- [main.tsx](file://packages/script-editor/src/main.tsx)
- [vite.config.ts](file://packages/script-editor/vite.config.ts)
- [package.json](file://packages/script-editor/package.json)
- [README.md](file://packages/script-editor/README.md)
- [ProjectList/index.tsx](file://packages/script-editor/src/pages/ProjectList/index.tsx)
- [ProjectEditor/index.tsx](file://packages/script-editor/src/pages/ProjectEditor/index.tsx)
- [EditorContent.tsx](file://packages/script-editor/src/pages/ProjectEditor/EditorContent.tsx)
- [ActionNodeList/index.tsx](file://packages/script-editor/src/components/ActionNodeList/index.tsx)
- [ActionPropertyPanel/index.tsx](file://packages/script-editor/src/components/ActionPropertyPanel/index.tsx)
- [DebugChatPanel/index.tsx](file://packages/script-editor/src/components/DebugChatPanel/index.tsx)
- [VersionListPanel/VersionListPanel.tsx](file://packages/script-editor/src/components/VersionListPanel/VersionListPanel.tsx)
- [VersionListPanel/style.css](file://packages/script-editor/src/components/VersionListPanel/style.css)
- [VersionListPanel/index.ts](file://packages/script-editor/src/components/VersionListPanel/index.ts)
- [NavigationTree/NavigationTree.tsx](file://packages/script-editor/src/components/NavigationTree/NavigationTree.tsx)
- [SessionPropertyPanel/index.tsx](file://packages/script-editor/src/components/SessionPropertyPanel/index.tsx)
- [SessionPropertyPanel/README.md](file://packages/script-editor/src/components/SessionPropertyPanel/README.md)
- [TemplateEditor/index.tsx](file://packages/script-editor/src/components/TemplateEditor/index.tsx)
- [TemplateEditor/TemplateValidator.tsx](file://packages/script-editor/src/components/TemplateEditor/TemplateValidator.tsx)
- [TemplateEditor/VariableInserter.tsx](file://packages/script-editor/src/components/TemplateEditor/VariableInserter.tsx)
- [TemplateSchemeManager/index.tsx](file://packages/script-editor/src/components/TemplateSchemeManager/index.tsx)
- [TemplateSchemeManager/CreateSchemeModal.tsx](file://packages/script-editor/src/components/TemplateSchemeManager/CreateSchemeModal.tsx)
- [TemplateSchemeManager/EditSchemeModal.tsx](file://packages/script-editor/src/components/TemplateSchemeManager/EditSchemeModal.tsx)
- [ValidationErrorPanel/ValidationErrorPanel.tsx](file://packages/script-editor/src/components/ValidationErrorPanel/ValidationErrorPanel.tsx)
- [validation-service.ts](file://packages/script-editor/src/services/validation-service.ts)
- [projects.ts](file://packages/script-editor/src/api/projects.ts)
- [action.ts](file://packages/script-editor/src/types/action.ts)
- [debug.ts](file://packages/script-editor/src/types/debug.ts)
- [navigation.ts](file://packages/script-editor/src/types/navigation.ts)
- [LLM-DEBUG-IMPLEMENTATION-SUMMARY.md](file://packages/script-editor/LLM-DEBUG-IMPLEMENTATION-SUMMARY.md)
- [T17-SESSION-PROPERTY-PANEL-SUMMARY.md](file://docs/design/T17-SESSION-PROPERTY-PANEL-SUMMARY.md)
- [T19-T20-T22-IMPLEMENTATION-SUMMARY.md](file://docs/design/T19-T20-T22-IMPLEMENTATION-SUMMARY.md)
</cite>

## 更新摘要

**所做更改**

- 新增会话属性面板组件，提供Session级别的配置管理
- 新增模板编辑器组件，支持Markdown模板的可视化编辑和验证
- 新增模板方案管理器，提供完整的模板方案生命周期管理
- 新增错误验证面板，提供详细的YAML验证错误展示
- 增强验证服务，支持异步验证工作流和防抖机制
- 完善调试功能，新增LLM提示词可视化和响应展示
- 增强测试框架，提供全面的组件测试覆盖

## 目录

1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构总览](#架构总览)
5. [详细组件分析](#详细组件分析)
6. [模板系统架构](#模板系统架构)
7. [验证与调试系统](#验证与调试系统)
8. [依赖关系分析](#依赖关系分析)
9. [性能考虑](#性能考虑)
10. [故障排查指南](#故障排查指南)
11. [结论](#结论)
12. [附录](#附录)

## 简介

本技术文档面向 HeartRule AI 咨询引擎的脚本编辑器，系统性梳理其 React 组件架构、状态管理与路由配置，深入讲解工程管理功能（项目列表、工程编辑器、文件管理）、可视化组件设计理念（Action 节点列表交互、属性面板数据绑定、调试面板实时反馈），并提供扩展开发指南（自定义组件、主题定制、插件机制）及用户体验与性能优化建议。

**更新** 脚本编辑器经过全面重构，新增了完整的模板系统架构，包括会话属性面板、模板编辑器、模板方案管理器等核心组件。前端增强了异步验证工作流、增强的调试功能与LLM提示词可视化，以及全面的测试框架。所有新增组件均提供完整的TypeScript类型定义和单元测试覆盖。

## 项目结构

脚本编辑器采用多包工作区组织，核心前端位于 packages/script-editor，包含页面、组件、类型定义、API 封装与工具模块。Vite 作为构建工具，Ant Design 提供 UI 基础组件，Zustand 用于轻量状态管理，React Router 实现前端路由，ReactFlow 用于流程图（在 README 中规划）。

```mermaid
graph TB
subgraph "前端应用"
A["App.tsx<br/>路由入口"]
B["main.tsx<br/>渲染入口"]
C["pages/<br/>页面层"]
D["components/<br/>组件层"]
E["types/<br/>类型定义"]
F["api/<br/>API封装"]
G["utils/<br/>工具模块"]
H["services/<br/>服务层"]
end
subgraph "构建与运行"
I["vite.config.ts<br/>代理/别名/端口"]
J["package.json<br/>依赖与脚本"]
K["README.md<br/>功能与进度"]
end
B --> A
A --> C
C --> D
D --> E
D --> F
D --> G
D --> H
H --> I
J --> B
K --> B
```

**图表来源**

- [App.tsx](file://packages/script-editor/src/App.tsx#L1-L21)
- [main.tsx](file://packages/script-editor/src/main.tsx#L1-L16)
- [vite.config.ts](file://packages/script-editor/vite.config.ts#L1-L23)
- [package.json](file://packages/script-editor/package.json#L1-L33)
- [README.md](file://packages/script-editor/README.md#L80-L97)

**章节来源**

- [App.tsx](file://packages/script-editor/src/App.tsx#L1-L21)
- [main.tsx](file://packages/script-editor/src/main.tsx#L1-L16)
- [vite.config.ts](file://packages/script-editor/vite.config.ts#L1-L23)
- [package.json](file://packages/script-editor/package.json#L1-L33)
- [README.md](file://packages/script-editor/README.md#L80-L97)

## 核心组件

- 页面层
  - 工程列表页：负责项目检索、筛选、创建、编辑入口与文件浏览。
  - 工程编辑器页：负责文件树、YAML/可视化双模式编辑、Action 层级结构解析与同步、调试面板集成、版本管理面板集成、会话属性面板集成。
- 组件层
  - Action 节点列表：提供层级折叠、拖拽排序、节点选择与高亮滚动。
  - Action 属性面板：按 Action 类型动态渲染表单，自动保存与校验。
  - 会话属性面板：管理Session级别的配置，包括名称、版本、描述和模板方案选择。
  - 模板编辑器：提供Markdown模板的可视化编辑、变量插入和实时验证。
  - 模板方案管理器：完整的模板方案生命周期管理，支持创建、编辑、删除和复制。
  - 调试聊天面板：会话加载、消息收发、导航树联动、错误与变量气泡展示、LLM提示词可视化。
  - 错误验证面板：详细的YAML验证错误展示，支持错误分类和修复建议。
  - 版本列表面板：提供版本历史查看、当前版本信息展示、草稿状态管理、版本切换功能。
  - 导航树组件：增强错误处理，提供脚本执行路径的可视化展示。
- 服务层
  - 验证服务：异步验证工作流、防抖控制、错误格式化。
  - 模板服务：模板内容管理、变量提取、验证规则。
- 工具与状态
  - 全局历史管理器：跨文件的撤销/重做与焦点定位。
  - API 封装：工程、文件、版本、调试、模板API统一管理。
  - 类型定义：Action、调试、导航树、模板方案等强类型支撑。

**章节来源**

- [ProjectList/index.tsx](file://packages/script-editor/src/pages/ProjectList/index.tsx#L1-L356)
- [ProjectEditor/index.tsx](file://packages/script-editor/src/pages/ProjectEditor/index.tsx#L1-L2438)
- [EditorContent.tsx](file://packages/script-editor/src/pages/ProjectEditor/EditorContent.tsx#L1-L420)
- [ActionNodeList/index.tsx](file://packages/script-editor/src/components/ActionNodeList/index.tsx#L1-L800)
- [ActionPropertyPanel/index.tsx](file://packages/script-editor/src/components/ActionPropertyPanel/index.tsx#L1-L607)
- [SessionPropertyPanel/index.tsx](file://packages/script-editor/src/components/SessionPropertyPanel/index.tsx#L1-L306)
- [TemplateEditor/index.tsx](file://packages/script-editor/src/components/TemplateEditor/index.tsx#L1-L288)
- [TemplateSchemeManager/index.tsx](file://packages/script-editor/src/components/TemplateSchemeManager/index.tsx#L1-L316)
- [ValidationErrorPanel/ValidationErrorPanel.tsx](file://packages/script-editor/src/components/ValidationErrorPanel/ValidationErrorPanel.tsx#L1-L171)
- [DebugChatPanel/index.tsx](file://packages/script-editor/src/components/DebugChatPanel/index.tsx#L1-L581)
- [VersionListPanel/VersionListPanel.tsx](file://packages/script-editor/src/components/VersionListPanel/VersionListPanel.tsx#L1-L340)
- [NavigationTree/NavigationTree.tsx](file://packages/script-editor/src/components/NavigationTree/NavigationTree.tsx#L1-L279)
- [validation-service.ts](file://packages/script-editor/src/services/validation-service.ts#L1-L230)
- [projects.ts](file://packages/script-editor/src/api/projects.ts#L1-L401)
- [action.ts](file://packages/script-editor/src/types/action.ts#L1-L126)
- [debug.ts](file://packages/script-editor/src/types/debug.ts#L1-L189)
- [navigation.ts](file://packages/script-editor/src/types/navigation.ts#L1-L67)

## 架构总览

前端采用"页面 + 组件 + 服务 + 工具 + API + 类型"的分层架构，路由驱动页面切换，页面内组合多种可视化组件，组件间通过 props 与回调通信，状态通过全局历史管理器与本地 useState 管理，API 通过 axios 统一封装。新增的模板系统通过专门的服务层和组件层实现完整的生命周期管理。

```mermaid
graph TB
R["React Router<br/>App.tsx 路由"] --> PL["ProjectList<br/>工程列表页"]
R --> PE["ProjectEditor<br/>工程编辑器页"]
PE --> EC["EditorContent<br/>编辑器内容"]
EC --> FT["文件树<br/>buildFileTree"]
EC --> AE["ActionNodeList<br/>节点列表"]
EC --> AP["ActionPropertyPanel<br/>属性面板"]
EC --> SP["SessionPropertyPanel<br/>会话属性面板"]
EC --> TE["TemplateEditor<br/>模板编辑器"]
EC --> TSM["TemplateSchemeManager<br/>模板方案管理器"]
EC --> DC["DebugChatPanel<br/>调试面板"]
EC --> VP["VersionListPanel<br/>版本列表面板"]
AE --> HM["HistoryManager<br/>全局历史"]
SP --> API["projectsApi<br/>工程/文件/模板API"]
TE --> API
TSM --> API
DC --> API
VP --> API
EC --> VS["ValidationService<br/>验证服务"]
VS --> CORE["@heartrule/core-engine<br/>核心引擎验证"]
EC --> T["types<br/>Action/Debug/Navigation"]
```

**图表来源**

- [App.tsx](file://packages/script-editor/src/App.tsx#L1-L21)
- [ProjectList/index.tsx](file://packages/script-editor/src/pages/ProjectList/index.tsx#L1-L356)
- [ProjectEditor/index.tsx](file://packages/script-editor/src/pages/ProjectEditor/index.tsx#L1-L2438)
- [EditorContent.tsx](file://packages/script-editor/src/pages/ProjectEditor/EditorContent.tsx#L1-L420)
- [ActionNodeList/index.tsx](file://packages/script-editor/src/components/ActionNodeList/index.tsx#L1-L800)
- [ActionPropertyPanel/index.tsx](file://packages/script-editor/src/components/ActionPropertyPanel/index.tsx#L1-L607)
- [SessionPropertyPanel/index.tsx](file://packages/script-editor/src/components/SessionPropertyPanel/index.tsx#L1-L306)
- [TemplateEditor/index.tsx](file://packages/script-editor/src/components/TemplateEditor/index.tsx#L1-L288)
- [TemplateSchemeManager/index.tsx](file://packages/script-editor/src/components/TemplateSchemeManager/index.tsx#L1-L316)
- [DebugChatPanel/index.tsx](file://packages/script-editor/src/components/DebugChatPanel/index.tsx#L1-L581)
- [VersionListPanel/VersionListPanel.tsx](file://packages/script-editor/src/components/VersionListPanel/VersionListPanel.tsx#L1-L340)
- [validation-service.ts](file://packages/script-editor/src/services/validation-service.ts#L1-L230)
- [projects.ts](file://packages/script-editor/src/api/projects.ts#L1-L401)
- [action.ts](file://packages/script-editor/src/types/action.ts#L1-L126)
- [debug.ts](file://packages/script-editor/src/types/debug.ts#L1-L189)
- [navigation.ts](file://packages/script-editor/src/types/navigation.ts#L1-L67)

## 详细组件分析

### 路由与入口

- 入口渲染：main.tsx 使用 ConfigProvider 注入 Ant Design 语言包，StrictMode 包裹保证严格模式。
- 路由配置：App.tsx 定义首页重定向、工程列表、工程编辑器（含文件级路由）。

```mermaid
sequenceDiagram
participant U as "用户"
participant M as "main.tsx"
participant A as "App.tsx"
participant RR as "React Router"
participant PL as "ProjectList"
participant PE as "ProjectEditor"
U->>M : 启动应用
M->>A : 渲染路由
A->>RR : 配置路由
U->>RR : 访问 /
RR->>PL : 重定向到 /projects
U->>RR : 访问 /projects
RR->>PL : 渲染工程列表
U->>RR : 访问 /projects/ : projectId
RR->>PE : 渲染工程编辑器
U->>RR : 访问 /projects/ : projectId/files/ : fileId
RR->>PE : 渲染工程编辑器
```

**图表来源**

- [main.tsx](file://packages/script-editor/src/main.tsx#L1-L16)
- [App.tsx](file://packages/script-editor/src/App.tsx#L1-L21)

**章节来源**

- [main.tsx](file://packages/script-editor/src/main.tsx#L1-L16)
- [App.tsx](file://packages/script-editor/src/App.tsx#L1-L21)

### 工程管理：项目列表页面

- 功能要点
  - 列表加载：首次挂载触发 API 请求，支持状态过滤与关键词搜索。
  - 创建工程：表单校验与 API 调用，成功后刷新列表。
  - 操作菜单：编辑、查看文件、复制、归档（确认对话框）。
  - 状态标签：根据状态映射不同颜色与文案。
- 交互细节
  - 过滤器：搜索框与状态选择器联动过滤。
  - 卡片点击：支持整卡点击进入编辑器。
  - 弹窗：创建工程对话框，提交后重置表单并刷新。

```mermaid
flowchart TD
Start(["进入项目列表"]) --> Load["加载工程列表"]
Load --> Filter["应用搜索与状态过滤"]
Filter --> Render["渲染卡片网格"]
Render --> Action{"用户操作"}
Action --> |点击卡片| Edit["跳转到工程编辑器"]
Action --> |点击菜单-编辑| Edit
Action --> |点击菜单-复制| Copy["调用复制API"]
Action --> |点击菜单-归档| Confirm["确认对话框"]
Confirm --> Archive["调用归档API"]
Edit --> End(["完成"])
Copy --> Refresh["刷新列表"]
Archive --> Refresh
Refresh --> End
```

**图表来源**

- [ProjectList/index.tsx](file://packages/script-editor/src/pages/ProjectList/index.tsx#L48-L123)

**章节来源**

- [ProjectList/index.tsx](file://packages/script-editor/src/pages/ProjectList/index.tsx#L1-L356)

### 工程编辑器：可视化与文件管理

- 文件树与文件加载
  - 构建文件树：区分会话文件与其他文件，会话文件聚合到"会话脚本"文件夹。
  - 切换文件：支持未保存变更的确认提示，URL 同步文件路径。
- YAML/可视化双模式
  - YAML 模式：文本编辑器，支持实时解析（针对会话脚本）。
  - 可视化模式：解析 YAML 为层级结构（Phases/Topics/Actions），默认进入可视化编辑。
- Action 层级结构与同步
  - 解析：兼容新旧两种脚本结构，规范化为前端内部结构。
  - 同步：将层级结构回写为 YAML，保留原始 config 以减少字段丢失。
- 历史与焦点
  - 全局历史管理器：跨文件撤销/重做，记录 before/after 与焦点路径。
  - 初始状态：首次加载为当前文件推入初始快照，避免重复记录。
- 调试集成
  - 调试配置与面板：支持开启调试会话、初始消息、发布版本。
  - 保存与快捷键：Ctrl/Cmd+S 保存，保存后刷新文件列表。
- 版本管理集成
  - 版本面板：固定定位右侧，提供版本历史查看与切换功能。
  - 版本切换：支持草稿与正式版本切换，带确认对话框与历史清空。
- 会话属性面板集成
  - Session 配置按钮：在可视化模式下显示。
  - 模板方案选择：支持下拉框选择可用方案。
  - 实时验证：表单验证与变更检测。

```mermaid
sequenceDiagram
participant U as "用户"
participant PE as "ProjectEditor"
participant EC as "EditorContent"
participant API as "projectsApi"
participant YML as "YAML解析"
participant HM as "HistoryManager"
U->>PE : 选择工程/文件
PE->>API : 获取工程与文件列表
API-->>PE : 返回工程与文件
PE->>EC : 渲染编辑器内容
EC->>API : 获取模板方案列表
API-->>EC : 返回可用方案
EC->>EC : 构建文件树并加载首个文件
alt 文件为会话脚本
EC->>YML : 解析YAML为层级结构
YML-->>EC : 返回Phases/Topics/Actions
EC->>HM : 推入初始状态快照
else 非会话脚本
EC->>EC : 切换到YAML模式
end
U->>EC : 修改Action/属性/会话配置
EC->>HM : push历史记录
U->>EC : Ctrl/Cmd+S
EC->>API : 更新文件
API-->>EC : 成功
EC->>EC : 刷新文件列表
```

**图表来源**

- [ProjectEditor/index.tsx](file://packages/script-editor/src/pages/ProjectEditor/index.tsx#L419-L513)
- [EditorContent.tsx](file://packages/script-editor/src/pages/ProjectEditor/EditorContent.tsx#L128-L153)
- [history-manager.ts](file://packages/script-editor/src/utils/history-manager.ts#L53-L118)

**章节来源**

- [ProjectEditor/index.tsx](file://packages/script-editor/src/pages/ProjectEditor/index.tsx#L1-L2438)
- [EditorContent.tsx](file://packages/script-editor/src/pages/ProjectEditor/EditorContent.tsx#L1-L420)
- [history-manager.ts](file://packages/script-editor/src/utils/history-manager.ts#L1-L340)

### Action 节点列表：交互与拖拽

- 展示结构：Phases → Topics → Actions 三层折叠面板，支持展开/折叠与选择。
- 交互能力
  - 节点选择：点击高亮，支持滚动到目标节点并高亮。
  - 拖拽排序：支持同级排序与跨级移动（Phase/Topic/Action）。
  - 动态菜单：Action 添加菜单，支持多种 Action 类型。
- 设计理念
  - 通过 data-\* 属性定位 DOM，结合自动滚动提升拖拽体验。
  - 通过 ref 暴露对外方法，便于父组件控制展开与滚动。

```mermaid
classDiagram
class ActionNodeList {
+props : Props
+state : 展开状态/拖拽状态
+expandAndScrollTo(path)
+renderActionCard()
}
class Action {
+type
+condition
+ai_say/ai_ask/ai_think/...
}
ActionNodeList --> Action : "渲染与交互"
```

**图表来源**

- [ActionNodeList/index.tsx](file://packages/script-editor/src/components/ActionNodeList/index.tsx#L176-L800)
- [action.ts](file://packages/script-editor/src/types/action.ts#L14-L87)

**章节来源**

- [ActionNodeList/index.tsx](file://packages/script-editor/src/components/ActionNodeList/index.tsx#L1-L800)
- [action.ts](file://packages/script-editor/src/types/action.ts#L1-L126)

### Action 属性面板：数据绑定与自动保存

- 动态表单：根据 Action 类型渲染不同字段（如 ai_say、ai_ask、ai_think 等）。
- 数据绑定：首次选中 Action 时填充表单，保存时合并更新。
- 自动保存：防抖 600ms，减少频繁写入。
- 输出变量：支持多输出变量的动态表单项（Form.List）。

```mermaid
flowchart TD
Select["选择Action"] --> Fill["按类型填充表单"]
Fill --> Edit["用户编辑"]
Edit --> Debounce["600ms防抖"]
Debounce --> Validate["校验字段"]
Validate --> |通过| Merge["合并更新Action"]
Validate --> |失败| Hint["提示错误"]
Merge --> Save["调用onSave回调"]
```

**图表来源**

- [ActionPropertyPanel/index.tsx](file://packages/script-editor/src/components/ActionPropertyPanel/index.tsx#L41-L161)

**章节来源**

- [ActionPropertyPanel/index.tsx](file://packages/script-editor/src/components/ActionPropertyPanel/index.tsx#L1-L607)

### 会话属性面板：Session配置管理

- 基本信息编辑：支持会谈名称（必填，最大100字符）、版本号（格式验证：x.y.z）、描述（最大500字符）。
- 模板方案配置：下拉框选择模板方案，显示选中方案的描述，支持"自动选择"（使用default层）。
- 管理功能：提供"管理模板方案"按钮（打开TemplateSchemeManager）和"查看方案详情"按钮。
- 表单管理：实时验证、未保存变更检测、取消/保存操作。
- 集成方式：在EditorContent中作为独立面板渲染，支持与ActionPropertyPanel的切换。

```mermaid
flowchart TD
Start(["打开会话属性面板"]) --> Load["加载模板方案列表"]
Load --> Render["渲染基本信息表单"]
Render --> Scheme["渲染模板方案选择器"]
Scheme --> Watch["监听表单变化"]
Watch --> Change{"表单有变更"}
Change --> |是| Enable["启用保存/取消按钮"]
Change --> |否| Disable["禁用保存/取消按钮"]
Enable --> Save["点击保存"]
Disable --> Cancel["点击取消"]
Save --> Validate["验证表单"]
Validate --> |通过| Update["调用onSave回调"]
Validate --> |失败| Error["显示验证错误"]
Update --> Success["显示保存成功"]
Success --> End(["完成"])
Error --> End
Cancel --> Reset["重置表单"]
Reset --> End
```

**图表来源**

- [SessionPropertyPanel/index.tsx](file://packages/script-editor/src/components/SessionPropertyPanel/index.tsx#L112-L144)

**章节来源**

- [SessionPropertyPanel/index.tsx](file://packages/script-editor/src/components/SessionPropertyPanel/index.tsx#L1-L306)
- [EditorContent.tsx](file://packages/script-editor/src/pages/ProjectEditor/EditorContent.tsx#L375-L388)

### 模板编辑器：Markdown模板管理

- 模板内容编辑：基于@uiw/react-md-editor的Markdown编辑器，支持实时预览。
- 变量插入工具：提供系统变量和脚本变量的快速插入功能。
- 实时验证：防抖500ms的模板验证，检查必需变量和安全边界声明。
- 权限控制：系统默认模板只读，自定义方案可编辑。
- 保存机制：支持确认对话框处理验证失败的情况。

```mermaid
sequenceDiagram
participant U as "用户"
participant TE as "TemplateEditor"
participant API as "projectsApi"
participant TV as "TemplateValidator"
U->>TE : 打开模板编辑器
TE->>API : 加载模板内容
API-->>TE : 返回模板内容
TE->>TV : 防抖验证
TV-->>TE : 返回验证结果
U->>TE : 编辑模板内容
TE->>TV : 500ms防抖验证
TV-->>TE : 更新验证结果
U->>TE : 插入变量
TE->>TE : 更新内容和变更状态
U->>TE : 保存模板
TE->>API : 更新模板内容
API-->>TE : 保存成功
TE->>U : 显示保存成功消息
```

**图表来源**

- [TemplateEditor/index.tsx](file://packages/script-editor/src/components/TemplateEditor/index.tsx#L75-L88)
- [TemplateEditor/index.tsx](file://packages/script-editor/src/components/TemplateEditor/index.tsx#L132-L173)

**章节来源**

- [TemplateEditor/index.tsx](file://packages/script-editor/src/components/TemplateEditor/index.tsx#L1-L288)
- [TemplateEditor/TemplateValidator.tsx](file://packages/script-editor/src/components/TemplateEditor/TemplateValidator.tsx#L1-L138)
- [TemplateEditor/VariableInserter.tsx](file://packages/script-editor/src/components/TemplateEditor/VariableInserter.tsx#L1-L95)

### 模板方案管理器：完整生命周期管理

- 方案列表管理：支持创建、编辑、删除、复制模板方案。
- 搜索过滤：支持按名称和描述搜索模板方案。
- 详情展示：显示选中方案的详细信息和类型标识。
- 权限控制：系统默认方案只读，不可修改或删除。
- 回调机制：方案变更时通知父组件重新加载数据。

```mermaid
flowchart TD
Start(["打开模板方案管理器"]) --> Load["加载方案列表"]
Load --> Render["渲染方案列表"]
Render --> Search["应用搜索过滤"]
Search --> Action{"用户操作"}
Action --> |新建方案| Create["打开创建对话框"]
Action --> |编辑方案| Edit["打开编辑对话框"]
Action --> |删除方案| Confirm["确认删除对话框"]
Action --> |查看详情| Detail["显示方案详情"]
Action --> |关闭| Close["关闭管理器"]
Create --> Success["创建成功回调"]
Edit --> Success
Confirm --> Success
Detail --> End(["完成"])
Success --> Reload["重新加载方案列表"]
Reload --> Render
```

**图表来源**

- [TemplateSchemeManager/index.tsx](file://packages/script-editor/src/components/TemplateSchemeManager/index.tsx#L47-L74)

**章节来源**

- [TemplateSchemeManager/index.tsx](file://packages/script-editor/src/components/TemplateSchemeManager/index.tsx#L1-L316)
- [TemplateSchemeManager/CreateSchemeModal.tsx](file://packages/script-editor/src/components/TemplateSchemeManager/CreateSchemeModal.tsx#L1-L138)
- [TemplateSchemeManager/EditSchemeModal.tsx](file://packages/script-editor/src/components/TemplateSchemeManager/EditSchemeModal.tsx#L1-L96)

### 错误验证面板：详细验证错误展示

- 错误分类：支持TYPE_ERROR、REQUIRED_ERROR、STRUCTURE_ERROR、FORMAT_ERROR、ENUM_ERROR、SYNTAX_ERROR等错误类型。
- 详细信息：显示错误消息、期望值、实际值、修复建议和正确示例。
- 折叠展示：支持错误详情的折叠/展开。
- 交互功能：提供关闭按钮和自动展开机制。

```mermaid
classDiagram
class ValidationErrorPanel {
+props : ValidationErrorPanelProps
+state : 错误列表/展开状态
+getErrorTypeConfig(errorType)
+renderErrorItem(error)
}
class ValidationErrorDetail {
+path : string
+errorType : string
+message : string
+expected : string
+actual : string
+suggestion : string
+example : string
}
ValidationErrorPanel --> ValidationErrorDetail : "渲染错误详情"
```

**图表来源**

- [ValidationErrorPanel/ValidationErrorPanel.tsx](file://packages/script-editor/src/components/ValidationErrorPanel/ValidationErrorPanel.tsx#L15-L18)
- [validation-service.ts](file://packages/script-editor/src/services/validation-service.ts#L25-L32)

**章节来源**

- [ValidationErrorPanel/ValidationErrorPanel.tsx](file://packages/script-editor/src/components/ValidationErrorPanel/ValidationErrorPanel.tsx#L1-L171)
- [validation-service.ts](file://packages/script-editor/src/services/validation-service.ts#L1-L230)

### 调试面板：实时反馈与导航树

- 会话加载：根据 sessionId 获取会话详情、消息历史、构建导航树。
- 消息交互：发送用户消息，接收 AI 回复，支持错误提示与位置更新。
- 导航树：基于脚本结构生成，展示当前执行位置。
- 错误与变量：错误气泡、变量状态气泡、执行日志与位置信息可配置过滤。
- 导航树增强：新增错误状态处理，提供更丰富的执行状态可视化。
- LLM调试信息：新增LLMPromptBubble和LLMResponseBubble组件，支持提示词和响应的可视化展示。

```mermaid
sequenceDiagram
participant U as "用户"
participant DP as "DebugChatPanel"
participant DBG as "debugApi"
participant NAV as "NavigationTree"
U->>DP : 打开调试面板
DP->>DBG : 获取会话详情
DBG-->>DP : 返回会话与脚本
DP->>NAV : 构建导航树
DP->>DBG : 获取消息历史
U->>DP : 输入消息并发送
DP->>DBG : 发送消息
DBG-->>DP : 返回AI回复/错误/位置
DP->>DP : 更新消息列表/错误/位置
DP->>DP : 渲染LLM调试信息
DP->>DP : 更新LLM提示词气泡
DP->>DP : 更新LLM响应气泡
```

**图表来源**

- [DebugChatPanel/index.tsx](file://packages/script-editor/src/components/DebugChatPanel/index.tsx#L168-L282)
- [LLM-DEBUG-IMPLEMENTATION-SUMMARY.md](file://packages/script-editor/LLM-DEBUG-IMPLEMENTATION-SUMMARY.md#L371-L377)
- [debug.ts](file://packages/script-editor/src/types/debug.ts#L20-L189)
- [navigation.ts](file://packages/script-editor/src/types/navigation.ts#L14-L66)

**章节来源**

- [DebugChatPanel/index.tsx](file://packages/script-editor/src/components/DebugChatPanel/index.tsx#L1-L581)
- [LLM-DEBUG-IMPLEMENTATION-SUMMARY.md](file://packages/script-editor/LLM-DEBUG-IMPLEMENTATION-SUMMARY.md#L349-L418)
- [debug.ts](file://packages/script-editor/src/types/debug.ts#L1-L189)
- [navigation.ts](file://packages/script-editor/src/types/navigation.ts#L1-L67)

### 版本列表面板：可视化版本管理

- 功能特性
  - 版本历史：展示所有版本的版本号、发布时间、发布人、发布说明。
  - 当前版本：突出显示当前激活的版本，显示发布时间和说明。
  - 草稿状态：显示未发布的草稿版本及其更新时间。
  - 版本切换：支持一键切换到指定版本，带确认对话框与历史清空。
  - 错误处理：加载失败时显示错误状态和重试按钮。
- 用户界面
  - 响应式设计：支持不同屏幕尺寸的适配。
  - 状态指示：使用颜色和图标清晰标识版本状态（当前、回滚、草稿）。
  - 滚动优化：版本列表支持垂直滚动，提供良好的滚动条样式。
- 技术实现
  - 并发加载：同时获取版本列表和草稿状态，提升加载效率。
  - 历史管理：版本切换后清空操作历史，防止跨版本数据错乱。
  - 确认机制：重要操作提供确认对话框，防止误操作。

```mermaid
flowchart TD
Start(["打开版本面板"]) --> Load["并发加载版本与草稿"]
Load --> Success{"加载成功"}
Success --> |是| Render["渲染版本列表"]
Success --> |否| Error["显示错误状态"]
Error --> Retry["用户点击重试"]
Retry --> Load
Render --> Current["显示当前版本信息"]
Current --> Draft["显示草稿状态"]
Draft --> List["渲染版本历史列表"]
List --> Switch{"用户选择切换版本"}
Switch --> |确认| Confirm["显示确认对话框"]
Confirm --> |确认| Perform["执行版本切换"]
Perform --> Clear["清空操作历史"]
Clear --> Refresh["刷新数据"]
Refresh --> End(["完成"])
Switch --> |取消| End
```

**图表来源**

- [VersionListPanel/VersionListPanel.tsx](file://packages/script-editor/src/components/VersionListPanel/VersionListPanel.tsx#L43-L139)

**章节来源**

- [VersionListPanel/VersionListPanel.tsx](file://packages/script-editor/src/components/VersionListPanel/VersionListPanel.tsx#L1-L340)
- [VersionListPanel/style.css](file://packages/script-editor/src/components/VersionListPanel/style.css#L1-L141)

### 导航树组件：增强错误处理

- 执行状态可视化：提供执行中、已执行、错误、未执行四种状态的图标和颜色标识。
- 智能展开：根据当前位置自动展开相应的 Phase 和 Topic。
- 错误状态处理：当 Action 状态为 error 时，显示警告图标和红色样式。
- 工具提示：鼠标悬停显示 Action ID、类型、状态等详细信息。
- 滚动定位：自动滚动到当前执行的 Action 位置。

**章节来源**

- [NavigationTree/NavigationTree.tsx](file://packages/script-editor/src/components/NavigationTree/NavigationTree.tsx#L1-L279)

### API 与类型体系

- API 封装：工程、文件、版本、调试、模板API统一管理，返回标准化结构。
- 类型定义：Action、SessionScript、调试气泡、导航树、模板方案等强类型，保障组件契约清晰。

**章节来源**

- [projects.ts](file://packages/script-editor/src/api/projects.ts#L1-L401)
- [action.ts](file://packages/script-editor/src/types/action.ts#L1-L126)
- [debug.ts](file://packages/script-editor/src/types/debug.ts#L1-L189)
- [navigation.ts](file://packages/script-editor/src/types/navigation.ts#L1-L67)

## 模板系统架构

脚本编辑器新增了完整的模板系统架构，包括会话属性面板、模板编辑器、模板方案管理器等核心组件，提供从模板创建到使用的完整生命周期管理。

### 模板系统组件关系

```mermaid
graph TB
subgraph "模板系统"
SP["SessionPropertyPanel<br/>会话属性面板"]
TE["TemplateEditor<br/>模板编辑器"]
TSM["TemplateSchemeManager<br/>模板方案管理器"]
TV["TemplateValidator<br/>模板验证器"]
VI["VariableInserter<br/>变量插入器"]
end
subgraph "数据流"
API["projectsApi<br/>模板API"]
DB["模板存储<br/>文件系统/数据库"]
end
SP --> TSM
SP --> TE
TE --> TV
TE --> VI
TSM --> API
TE --> API
SP --> API
API --> DB
```

**图表来源**

- [SessionPropertyPanel/index.tsx](file://packages/script-editor/src/components/SessionPropertyPanel/index.tsx#L1-L306)
- [TemplateEditor/index.tsx](file://packages/script-editor/src/components/TemplateEditor/index.tsx#L1-L288)
- [TemplateSchemeManager/index.tsx](file://packages/script-editor/src/components/TemplateSchemeManager/index.tsx#L1-L316)
- [TemplateEditor/TemplateValidator.tsx](file://packages/script-editor/src/components/TemplateEditor/TemplateValidator.tsx#L1-L138)
- [TemplateEditor/VariableInserter.tsx](file://packages/script-editor/src/components/TemplateEditor/VariableInserter.tsx#L1-L95)
- [projects.ts](file://packages/script-editor/src/api/projects.ts#L203-L313)

### 模板方案管理流程

```mermaid
flowchart TD
Start(["创建模板方案"]) --> Load["加载现有方案"]
Load --> Create["打开创建对话框"]
Create --> Validate["表单验证"]
Validate --> |通过| Copy["复制模板文件"]
Validate --> |失败| Error["显示验证错误"]
Copy --> Success["创建成功"]
Error --> Create
Success --> Reload["重新加载方案列表"]
Reload --> End(["完成"])
```

**图表来源**

- [TemplateSchemeManager/CreateSchemeModal.tsx](file://packages/script-editor/src/components/TemplateSchemeManager/CreateSchemeModal.tsx#L32-L58)

### 模板编辑验证流程

```mermaid
flowchart TD
Start(["编辑模板"]) --> Load["加载模板内容"]
Load --> Edit["用户编辑"]
Edit --> Debounce["500ms防抖"]
Debounce --> Validate["验证模板"]
Validate --> |通过| Success["显示验证通过"]
Validate --> |失败| ShowError["显示错误详情"]
Validate --> |警告| ShowWarning["显示建议"]
Success --> Save["保存模板"]
ShowError --> Confirm["确认保存"]
ShowWarning --> Save
Confirm --> Save
Save --> End(["完成"])
```

**图表来源**

- [TemplateEditor/index.tsx](file://packages/script-editor/src/components/TemplateEditor/index.tsx#L81-L88)
- [TemplateEditor/index.tsx](file://packages/script-editor/src/components/TemplateEditor/index.tsx#L90-L130)

**章节来源**

- [SessionPropertyPanel/index.tsx](file://packages/script-editor/src/components/SessionPropertyPanel/index.tsx#L1-L306)
- [TemplateEditor/index.tsx](file://packages/script-editor/src/components/TemplateEditor/index.tsx#L1-L288)
- [TemplateSchemeManager/index.tsx](file://packages/script-editor/src/components/TemplateSchemeManager/index.tsx#L1-L316)
- [TemplateEditor/TemplateValidator.tsx](file://packages/script-editor/src/components/TemplateEditor/TemplateValidator.tsx#L1-L138)
- [TemplateEditor/VariableInserter.tsx](file://packages/script-editor/src/components/TemplateEditor/VariableInserter.tsx#L1-L95)
- [projects.ts](file://packages/script-editor/src/api/projects.ts#L203-L313)

## 验证与调试系统

脚本编辑器增强了验证和调试功能，提供异步验证工作流、防抖机制和LLM提示词可视化。

### 验证服务架构

```mermaid
classDiagram
class ValidationService {
+config : ValidationServiceConfig
+lastValidationResult : ValidationResult
+debounceTimer : number
+validate(yamlContent, trigger)
+validateOnOpen(yamlContent)
+validateOnChange(yamlContent, callback)
+validateManual(yamlContent)
+validateBeforeSave(yamlContent)
+cancelPendingValidation()
+getLastResult()
+clearResult()
+formatErrorForUI(error)
+groupErrors(errors)
+dispose()
}
class ValidationResult {
+valid : boolean
+errors : ValidationErrorDetail[]
+trigger : ValidationTrigger
+timestamp : number
}
class ValidationErrorDetail {
+path : string
+errorType : string
+message : string
+expected : string
+actual : string
+suggestion : string
+example : string
}
ValidationService --> ValidationResult : "返回"
ValidationResult --> ValidationErrorDetail : "包含"
```

**图表来源**

- [validation-service.ts](file://packages/script-editor/src/services/validation-service.ts#L45-L229)
- [validation-service.ts](file://packages/script-editor/src/services/validation-service.ts#L27-L32)
- [validation-service.ts](file://packages/script-editor/src/services/validation-service.ts#L11-L12)

### LLM调试信息可视化

```mermaid
graph TB
subgraph "LLM调试信息流"
LLM["LLM Orchestrator<br/>捕获调试信息"]
AS["ActionResult<br/>传递debugInfo"]
ES["ExecutionState<br/>保存lastLLMDebugInfo"]
SM["Session Manager API<br/>响应包含debugInfo"]
FC["前端DebugChatPanel<br/>集成"]
LLMP["LLMPromptBubble<br/>提示词气泡"]
LLMR["LLMResponseBubble<br/>响应气泡"]
end
LLM --> AS --> ES --> SM --> FC --> LLMP
FC --> LLMR
```

**图表来源**

- [LLM-DEBUG-IMPLEMENTATION-SUMMARY.md](file://packages/script-editor/LLM-DEBUG-IMPLEMENTATION-SUMMARY.md#L379-L381)

### 异步验证工作流

```mermaid
sequenceDiagram
participant U as "用户"
participant VS as "ValidationService"
participant YAML as "YAML内容"
participant CORE as "@heartrule/core-engine"
U->>VS : 输入YAML内容
VS->>VS : 检查防抖设置
VS->>VS : 设置防抖定时器
VS->>CORE : validateYAML(yamlContent)
CORE-->>VS : 验证结果
VS-->>U : 触发回调
U->>VS : 手动触发验证
VS->>CORE : validateManual(yamlContent)
CORE-->>VS : 验证结果
VS-->>U : 返回验证结果
```

**图表来源**

- [validation-service.ts](file://packages/script-editor/src/services/validation-service.ts#L106-L122)
- [validation-service.ts](file://packages/script-editor/src/services/validation-service.ts#L127-L129)

**章节来源**

- [validation-service.ts](file://packages/script-editor/src/services/validation-service.ts#L1-L230)
- [LLM-DEBUG-IMPLEMENTATION-SUMMARY.md](file://packages/script-editor/LLM-DEBUG-IMPLEMENTATION-SUMMARY.md#L349-L418)

## 依赖关系分析

- 外部依赖
  - React 生态：React、React Router、Ant Design、Zustand、Axios。
  - 可视化：ReactFlow（规划中）、@uiw/react-md-editor。
  - 工具：js-yaml（YAML 解析）、uuid（调试会话 ID）、Vite（构建）。
  - 核心引擎：@heartrule/core-engine（验证服务）。
- 内部耦合
  - 页面与组件：页面组合组件，组件通过回调与页面通信。
  - 组件与工具：ActionNodeList 与 HistoryManager 通过全局实例交互。
  - 组件与 API：各组件通过 projectsApi/debugApi 调用后端。
  - 服务层：ValidationService与核心引擎验证服务集成。

```mermaid
graph LR
subgraph "外部"
R["React/AntD/Router/Zustand/Axios"]
Y["js-yaml"]
V["Vite"]
CE["@heartrule/core-engine"]
MED["@uiw/react-md-editor"]
end
subgraph "内部"
PL["ProjectList"]
PE["ProjectEditor"]
EC["EditorContent"]
ANL["ActionNodeList"]
APP["ActionPropertyPanel"]
SP["SessionPropertyPanel"]
TE["TemplateEditor"]
TSM["TemplateSchemeManager"]
DCP["DebugChatPanel"]
VLP["VersionListPanel"]
NT["NavigationTree"]
VS["ValidationService"]
HM["HistoryManager"]
API["projectsApi/debugApi"]
T["types/*"]
end
R --> PL
R --> PE
Y --> PE
V --> PE
CE --> VS
MED --> TE
PE --> ANL
PE --> APP
PE --> EC
EC --> SP
EC --> TE
EC --> TSM
PE --> DCP
PE --> VLP
PE --> NT
PE --> VS
PE --> HM
PE --> API
ANL --> HM
APP --> PE
SP --> API
TE --> API
TSM --> API
DCP --> API
VLP --> API
NT --> T
PL --> API
PE --> T
ANL --> T
APP --> T
SP --> T
TE --> T
TSM --> T
DCP --> T
VLP --> T
VS --> T
```

**图表来源**

- [package.json](file://packages/script-editor/package.json#L12-L23)
- [ProjectEditor/index.tsx](file://packages/script-editor/src/pages/ProjectEditor/index.tsx#L41-L51)
- [ActionNodeList/index.tsx](file://packages/script-editor/src/components/ActionNodeList/index.tsx#L1-L30)
- [ActionPropertyPanel/index.tsx](file://packages/script-editor/src/components/ActionPropertyPanel/index.tsx#L1-L21)
- [SessionPropertyPanel/index.tsx](file://packages/script-editor/src/components/SessionPropertyPanel/index.tsx#L1-L5)
- [TemplateEditor/index.tsx](file://packages/script-editor/src/components/TemplateEditor/index.tsx#L1-L8)
- [TemplateSchemeManager/index.tsx](file://packages/script-editor/src/components/TemplateSchemeManager/index.tsx#L1-L14)
- [DebugChatPanel/index.tsx](file://packages/script-editor/src/components/DebugChatPanel/index.tsx#L1-L30)
- [VersionListPanel/VersionListPanel.tsx](file://packages/script-editor/src/components/VersionListPanel/VersionListPanel.tsx#L1-L12)
- [NavigationTree/NavigationTree.tsx](file://packages/script-editor/src/components/NavigationTree/NavigationTree.tsx#L1-L14)
- [validation-service.ts](file://packages/script-editor/src/services/validation-service.ts#L1-L12)
- [history-manager.ts](file://packages/script-editor/src/utils/history-manager.ts#L1-L10)
- [projects.ts](file://packages/script-editor/src/api/projects.ts#L1-L3)

**章节来源**

- [package.json](file://packages/script-editor/package.json#L1-L33)

## 性能考虑

- 渲染优化
  - 列表虚拟化：项目列表卡片较多时，可引入虚拟列表减少 DOM。
  - 组件拆分：将 Action 节点卡片与属性面板独立渲染，避免不必要的重绘。
  - 版本面板优化：使用固定定位和溢出滚动，避免影响主界面渲染。
  - 模板编辑器：MDEditor组件支持实时预览，但需注意性能优化。
- 网络与缓存
  - API 请求去抖：项目列表搜索建议增加防抖，降低请求频率。
  - 本地缓存：对常用工程/文件元数据进行内存缓存，减少重复请求。
  - 并发加载：版本面板使用 Promise.allSettled 并发加载多个数据源。
  - 模板方案缓存：模板方案列表可进行本地缓存，减少重复请求。
- 解析与同步
  - YAML 解析：仅在会话脚本切换或输入停止后解析，避免高频解析。
  - 同步策略：增量同步层级结构到 YAML，避免全量替换。
  - 防抖验证：模板编辑器使用500ms防抖，平衡响应性和性能。
- 历史管理
  - 历史栈上限：限制最大条目，定期清理旧快照。
  - 深拷贝优化：对大体量数据进行浅拷贝 + 需要时深拷贝，降低内存峰值。
  - 版本切换清空：版本切换时清空历史栈，防止内存泄漏。
- 验证服务优化
  - 防抖机制：ValidationService提供500ms防抖，默认启用自动验证。
  - 取消机制：支持取消待执行的验证，避免资源浪费。
  - 结果缓存：缓存最后一次验证结果，减少重复计算。

## 故障排查指南

- 路由与入口
  - 若页面空白：检查 main.tsx 渲染与 App.tsx 路由配置。
- 工程列表
  - 加载失败：检查 API 代理配置与后端连通性；查看控制台错误。
  - 创建失败：确认表单校验与后端返回的 success 字段。
- 工程编辑器
  - 文件树不显示：确认返回的文件列表与 buildFileTree 逻辑。
  - YAML 解析报错：检查脚本格式与解析分支（新/旧结构）。
  - 撤销/重做无效：确认 HistoryManager 的 isUndoRedoActive 标记与 canUndo/canRedo。
  - 版本面板异常：检查版本 API 调用和数据格式。
  - 会话属性面板：检查模板方案加载和表单验证逻辑。
- 模板系统
  - 模板编辑器：检查模板内容加载和权限控制逻辑。
  - 模板方案管理器：确认方案列表加载和操作权限。
  - 模板验证：检查验证规则和错误提示显示。
- 调试面板
  - 无消息：检查 sessionId、API 返回与消息拼接逻辑。
  - 导航树异常：检查脚本结构与 buildNavigationTree 的解析分支。
  - 导航树错误状态：确认 Action 状态字段和错误处理逻辑。
  - LLM调试信息：检查debugInfo数据流和气泡渲染逻辑。
- 验证服务
  - 验证失败：检查YAML语法和schema验证规则。
  - 防抖失效：确认ValidationService配置和定时器管理。
- 代理与环境
  - 前端 3000 端口代理到后端 8000，确保后端服务已启动。

**章节来源**

- [main.tsx](file://packages/script-editor/src/main.tsx#L1-L16)
- [App.tsx](file://packages/script-editor/src/App.tsx#L1-L21)
- [ProjectList/index.tsx](file://packages/script-editor/src/pages/ProjectList/index.tsx#L48-L74)
- [ProjectEditor/index.tsx](file://packages/script-editor/src/pages/ProjectEditor/index.tsx#L419-L513)
- [EditorContent.tsx](file://packages/script-editor/src/pages/ProjectEditor/EditorContent.tsx#L128-L153)
- [SessionPropertyPanel/index.tsx](file://packages/script-editor/src/components/SessionPropertyPanel/index.tsx#L112-L144)
- [TemplateEditor/index.tsx](file://packages/script-editor/src/components/TemplateEditor/index.tsx#L132-L173)
- [TemplateSchemeManager/index.tsx](file://packages/script-editor/src/components/TemplateSchemeManager/index.tsx#L91-L119)
- [ValidationErrorPanel/ValidationErrorPanel.tsx](file://packages/script-editor/src/components/ValidationErrorPanel/ValidationErrorPanel.tsx#L69-L167)
- [validation-service.ts](file://packages/script-editor/src/services/validation-service.ts#L147-L152)
- [DebugChatPanel/index.tsx](file://packages/script-editor/src/components/DebugChatPanel/index.tsx#L168-L282)
- [VersionListPanel/VersionListPanel.tsx](file://packages/script-editor/src/components/VersionListPanel/VersionListPanel.tsx#L82-L117)
- [NavigationTree/NavigationTree.tsx](file://packages/script-editor/src/components/NavigationTree/NavigationTree.tsx#L129-L140)
- [vite.config.ts](file://packages/script-editor/vite.config.ts#L13-L21)

## 结论

脚本编辑器经过全面重构，形成了以模板系统为核心的完整架构。新增的会话属性面板、模板编辑器、模板方案管理器等组件，提供了从模板创建到使用的完整生命周期管理。通过增强的验证服务、异步工作流和LLM调试信息可视化，显著提升了开发体验和调试效率。完善的测试框架和TypeScript类型系统确保了代码质量和可维护性。后续可在模板系统扩展、插件机制与主题定制方面进一步完善，持续提升用户体验与可扩展性。

## 附录

- 开发与运行
  - 前置条件与安装、数据库迁移与前后端启动流程见 README。
- 扩展开发指南
  - 自定义组件：遵循现有组件模式（props + 回调 + 类型约束），接入 ActionNodeList/ActionPropertyPanel。
  - 主题定制：通过 Ant Design 主题变量与 CSS 变量覆盖实现。
  - 插件机制：预留扩展点（如 Action 类型注册、调试气泡类型扩展），通过配置与工厂模式注入。
  - 模板系统扩展：可基于现有模板编辑器和管理器架构开发更多模板管理功能。
  - 验证系统扩展：可基于ValidationService扩展更多验证规则和自定义验证器。
- 测试指南
  - 单元测试：所有新增组件均提供完整的单元测试覆盖。
  - 集成测试：建议使用Playwright进行端到端测试。
  - 性能测试：建议对模板编辑器和验证服务进行性能基准测试。

**章节来源**

- [README.md](file://packages/script-editor/README.md#L42-L78)
- [SessionPropertyPanel/README.md](file://packages/script-editor/src/components/SessionPropertyPanel/README.md#L1-L33)
- [T17-SESSION-PROPERTY-PANEL-SUMMARY.md](file://docs/design/T17-SESSION-PROPERTY-PANEL-SUMMARY.md#L1-L462)
- [T19-T20-T22-IMPLEMENTATION-SUMMARY.md](file://docs/design/T19-T20-T22-IMPLEMENTATION-SUMMARY.md#L187-L230)
